<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulario Termoformado - Formulario IA</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üî≤ Formulario Termoformado</h1>
        
        <!-- Desktop menu -->
        <div class="user-info">
          <span id="userName"></span>
          <div id="creditsDisplay" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, var(--alico-gold-20) 0%, var(--alico-gold-30) 100%); border-radius: 8px; margin-right: 12px; border: 2px solid var(--alico-gold);">
            <span style="font-size: 20px;">üí≥</span>
            <span style="font-weight: 700; color: var(--alico-gold); font-size: 18px;" id="creditsCount">...</span>
            <span style="font-size: 13px; color: var(--alico-gold-80);">cr√©ditos</span>
          </div>
          <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">Dashboard</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>

        <!-- Mobile hamburger button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
          ‚ò∞
        </button>
      </header>

      <!-- Mobile menu overlay and sidebar -->
      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
            <div class="mobile-menu-credits">
              <span class="mobile-menu-credits-icon">üí≥</span>
              <span class="mobile-menu-credits-count" id="mobileCreditsCount">...</span>
              <span class="mobile-menu-credits-label">cr√©ditos</span>
            </div>
          </div>
          <div class="mobile-menu-buttons">
            <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard</button>
            <button type="button" onclick="location.href='/forms.html'" class="btn-secondary">üìã Formularios</button>
            <button type="button" onclick="location.href='/history.html'" class="btn-secondary">üìä Historial</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <div class="gallery-section">
          <!-- Breadcrumb -->
          <div class="breadcrumb-container">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a href="/dashboard.html">üè† Dashboard</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item">
                  <a href="/forms.html">üìã Formularios</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item active" aria-current="page">
                  üî≤ Termoformado
                </li>
              </ol>
            </nav>
          </div>
          
          <!-- Progress indicator -->
          <div class="wizard-progress">
            <div class="wizard-step active" data-step="1">
              <div class="step-circle">1</div>
              <div class="step-label">Producto</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="2">
              <div class="step-circle">2</div>
              <div class="step-label">Foto</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="3">
              <div class="step-circle">3</div>
              <div class="step-label">Confirmar</div>
            </div>
          </div>

          <form id="mainForm">
            <!-- Step 1: Selecci√≥n de Producto -->
            <div class="form-step active" data-step="1">
              <div class="form-section">
                <h3>üì¶ Paso 1: Selecciona el tipo de producto</h3>
                
                <div class="form-section-content">
                  <div id="productsLoading" style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 48px; margin-bottom: 16px;">‚è≥</div>
                    <p>Cargando productos...</p>
                  </div>
                  <div id="productsContainer"></div>
                </div>
              </div>
            </div>

            <!-- Step 2: Seleccionar foto -->
            <div class="form-step" data-step="2">
              <div class="form-section">
                <h3>üì∑ Paso 2: Selecciona una foto</h3>
                
                <div class="form-section-content">
                  <div class="photo-selector-container">
                    <!-- Dropdown selector -->
                    <label>
                      Foto
                      <select id="photoSelect" name="photo_id" required>
                        <option value="">Cargando fotos...</option>
                      </select>
                    </label>
                    
                    <!-- Preview de la foto seleccionada -->
                    <div id="photoPreview" class="photo-preview-container" style="display: none;">
                      <div class="preview-header">
                        <span class="preview-title">üñºÔ∏è Vista previa</span>
                        <span class="preview-hint">(Click para ampliar)</span>
                      </div>
                      <div class="preview-image-wrapper">
                        <img 
                          id="previewImage" 
                          src="" 
                          alt="Vista previa" 
                          class="preview-image"
                        />
                      </div>
                      <p id="previewInfo" class="preview-info"></p>
                    </div>
                </div>
              </div>
            </div>

            <!-- Step 3: Confirmar -->
            <div class="form-step" data-step="3">
              <div class="form-section">
                <h3>‚úÖ Paso 3: Confirmar y enviar</h3>
                
                <div class="form-section-content">
                  <div class="confirmation-summary">
                    <div class="summary-item">
                      <strong>Producto seleccionado:</strong>
                      <div id="confirmProduct" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Foto seleccionada:</strong>
                      <div id="confirmPhoto" style="margin-top: 8px;"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Navigation buttons -->
            <div class="form-actions wizard-navigation" style="display: flex !important; visibility: visible !important;">
              <button type="button" id="prevBtn" class="btn-secondary" style="display: none;">
                ‚Üê Anterior
              </button>
              <button type="button" id="nextBtn" class="btn-submit" style="display: inline-block;">
                Siguiente ‚Üí
              </button>
              <button type="submit" id="submitBtn" class="btn-submit" style="display: none;">
                Enviar formulario
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal for full image view -->
    <div id="formImageViewModal" class="modal">
      <div class="modal-content modal-image">
        <span class="modal-close">&times;</span>
        <h2 id="formImageViewTitle">Imagen completa</h2>
        <img id="formFullImageView" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;" />
      </div>
    </div>

    <script>
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      let allPhotos = [];
      let currentFullImageUrl = '';
      let allProducts = {};
      
      if (!token) {
        window.location.href = '/login.html';
      }

      const userName = user.name || user.email || 'Usuario';
      document.getElementById('userName').textContent = userName;
      document.getElementById('mobileUserName').textContent = userName;

      // Mobile menu handlers
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function openMobileMenu() {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      mobileMenuToggle.addEventListener('click', openMobileMenu);
      mobileMenuClose.addEventListener('click', closeMobileMenu);
      mobileMenuOverlay.addEventListener('click', closeMobileMenu);

      document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
        }
      });

      // Load user credits
      async function loadCredits() {
        try {
          const res = await fetch('/api/credits', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok) {
            // Update desktop credits
            const creditsCount = document.getElementById('creditsCount');
            creditsCount.textContent = data.credits;
            
            // Update mobile credits
            const mobileCreditsCount = document.getElementById('mobileCreditsCount');
            mobileCreditsCount.textContent = data.credits;
            
            // Change color based on credits remaining
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (data.credits === 0) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
              creditsDisplay.style.borderColor = '#dc3545';
              creditsCount.style.color = '#dc3545';
              
              // Show next reset date
              const nextReset = new Date(data.nextReset);
              creditsDisplay.title = `Se recargar√°n el ${nextReset.toLocaleDateString('es-ES')}`;
            } else if (data.credits === 1) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
              creditsDisplay.style.borderColor = '#ffc107';
              creditsCount.style.color = '#856404';
            }
          }
        } catch (err) {
          console.error('Error loading credits:', err);
        }
      }

      loadCredits();

      // Category icons and labels
      const categoryConfig = {
        'estuches': { icon: 'üéÅ', label: 'Estuches' },
        'base-tapa': { icon: 'üîÑ', label: 'Base y Tapa' },
        'bandejas': { icon: 'üç±', label: 'Bandejas' },
        'domos': { icon: 'üîÆ', label: 'Domos' }
      };

      // Load products from API with cache
      async function loadProducts() {
        try {
          // Check cache first (5 minutes)
          const cacheKey = 'products_termoformado';
          const cacheTimeKey = 'products_termoformado_time';
          const cacheData = localStorage.getItem(cacheKey);
          const cacheTime = localStorage.getItem(cacheTimeKey);
          const now = Date.now();
          const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

          // Use cache if available and not expired
          if (cacheData && cacheTime && (now - parseInt(cacheTime)) < CACHE_DURATION) {
            const data = JSON.parse(cacheData);
            allProducts = data.groupedProducts;
            renderProducts(data.groupedProducts);
            document.getElementById('productsLoading').style.display = 'none';
            console.log('‚úÖ Productos cargados desde cach√©');
            return;
          }

          // Fetch from API
          const res = await fetch('/api/products/termoformado', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok && data.groupedProducts) {
            allProducts = data.groupedProducts;
            renderProducts(data.groupedProducts);
            document.getElementById('productsLoading').style.display = 'none';
            
            // Save to cache
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTimeKey, now.toString());
            console.log('‚úÖ Productos cargados desde API y guardados en cach√©');
          } else {
            throw new Error(data.error || 'Error al cargar productos');
          }
        } catch (err) {
          console.error('Error loading products:', err);
          document.getElementById('productsLoading').innerHTML = `
            <div style="color: #721c24; text-align: center; padding: 40px;">
              <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
              <p>Error al cargar productos: ${err.message}</p>
            </div>
          `;
        }
      }

      // Render products grouped by category
      function renderProducts(groupedProducts) {
        const container = document.getElementById('productsContainer');
        container.innerHTML = '';

        Object.keys(groupedProducts).forEach(category => {
          const config = categoryConfig[category] || { icon: 'üì¶', label: category };
          const products = groupedProducts[category];

          const accordion = document.createElement('div');
          accordion.className = 'product-accordion';

          const header = document.createElement('button');
          header.type = 'button';
          header.className = 'accordion-header';
          header.onclick = () => toggleAccordion(header);
          header.innerHTML = `
            <span>${config.icon} ${config.label}</span>
            <span class="accordion-icon">‚ñº</span>
          `;

          const content = document.createElement('div');
          content.className = 'accordion-content';

          const grid = document.createElement('div');
          grid.className = 'product-grid';

          products.forEach(product => {
            const card = document.createElement('label');
            card.className = 'product-card';
            card.htmlFor = `product-${product.id}`;

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'product_type';
            radio.id = `product-${product.id}`;
            radio.value = product.id;
            radio.className = 'product-radio';
            radio.addEventListener('change', handleProductSelection);

            const imageDiv = document.createElement('div');
            imageDiv.className = 'product-image';
            
            if (product.imageUrl && !product.imageError) {
              const img = document.createElement('img');
              img.src = product.imageUrl;
              img.alt = product.name;
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '8px';
              img.onerror = function() {
                this.parentElement.innerHTML = 'üì¶';
              };
              imageDiv.appendChild(img);
            } else {
              imageDiv.textContent = config.icon;
            }

            const name = document.createElement('p');
            name.className = 'product-name';
            name.textContent = product.name;

            card.appendChild(radio);
            card.appendChild(imageDiv);
            card.appendChild(name);

            grid.appendChild(card);
          });

          content.appendChild(grid);
          accordion.appendChild(header);
          accordion.appendChild(content);
          container.appendChild(accordion);
        });
      }

      // Handle product selection
      function handleProductSelection() {
        // Remove selected class from all cards
        document.querySelectorAll('.product-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Add selected class to the clicked card
        if (this.checked) {
          this.closest('.product-card').classList.add('selected');
        }
      }

      // === WIZARD NAVIGATION ===
      let currentStep = 1;
      const totalSteps = 3;

      function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active', 'completed'));
        
        // Show current step
        document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
        document.querySelector(`.wizard-step[data-step="${step}"]`).classList.add('active');
        
        // Mark previous steps as completed
        for (let i = 1; i < step; i++) {
          document.querySelector(`.wizard-step[data-step="${i}"]`).classList.add('completed');
        }
        
        // Update buttons
        document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'inline-block';
        document.getElementById('nextBtn').style.display = step === totalSteps ? 'none' : 'inline-block';
        document.getElementById('submitBtn').style.display = step === totalSteps ? 'inline-block' : 'none';
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function validateStep(step) {
        if (step === 1) {
          const selectedProduct = document.querySelector('input[name="product_type"]:checked');
          if (!selectedProduct) {
            alert('Por favor selecciona un producto');
            return false;
          }
        } else if (step === 2) {
          const photoId = document.getElementById('photoSelect').value;
          if (!photoId) {
            alert('Por favor selecciona una foto');
            return false;
          }
        }
        return true;
      }

      function updateConfirmation() {
        // Update product confirmation
        const selectedProduct = document.querySelector('input[name="product_type"]:checked');
        if (selectedProduct) {
          const productCard = selectedProduct.closest('.product-card');
          const productName = productCard.querySelector('.product-name').textContent;
          const productImg = productCard.querySelector('.product-image img');
          
          let html = `<div style="display: flex; align-items: center; gap: 16px;">`;
          if (productImg) {
            html += `<img src="${productImg.src}" alt="${productName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--alico-gold);">`;
          }
          html += `<div><div style="font-weight: 600; font-size: 16px;">${productName}</div></div></div>`;
          
          document.getElementById('confirmProduct').innerHTML = html;
        }
        
        // Update photo confirmation
        const photoSelect = document.getElementById('photoSelect');
        const selectedOption = photoSelect.options[photoSelect.selectedIndex];
        if (selectedOption && selectedOption.value) {
          const photoName = selectedOption.textContent;
          const photoUrl = selectedOption.dataset.url;
          const photoFolder = selectedOption.dataset.folder;
          
          let html = `<div style="display: flex; align-items: center; gap: 16px;">`;
          if (photoUrl) {
            html += `<img src="${photoUrl}" alt="${photoName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--alico-gold);">`;
          }
          html += `<div><div style="font-weight: 600; font-size: 16px;">${photoName}</div><div style="color: #666; font-size: 14px; margin-top: 4px;">Carpeta: ${photoFolder}</div></div></div>`;
          
          document.getElementById('confirmPhoto').innerHTML = html;
        }
      }

      document.getElementById('nextBtn').addEventListener('click', () => {
        if (validateStep(currentStep)) {
          currentStep++;
          if (currentStep === totalSteps) {
            updateConfirmation();
          }
          showStep(currentStep);
        }
      });

      document.getElementById('prevBtn').addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          showStep(currentStep);
        }
      });

      // Initialize wizard
      showStep(1);

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
        }
      });

      // Cargar fotos del usuario
      async function loadPhotos() {
        try {
          const res = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok && data.uploads) {
            allPhotos = data.uploads;
            
            populatePhotoSelect(data.uploads);
          } else {
            document.getElementById('photoSelect').innerHTML = '<option value="">Error al cargar fotos</option>';
          }
        } catch (err) {
          console.error('Error loading photos:', err);
          document.getElementById('photoSelect').innerHTML = '<option value="">Error al cargar fotos</option>';
        }
      }

      function populatePhotoSelect(photos) {
        const select = document.getElementById('photoSelect');
        const currentValue = select.value;
        
        if (photos.length === 0) {
          select.innerHTML = '<option value="">No hay fotos disponibles</option>';
          document.getElementById('photoPreview').style.display = 'none';
          return;
        }

        select.innerHTML = '<option value="">-- Selecciona una foto --</option>';
        
        // Agrupar por carpeta
        const byFolder = {};
        photos.forEach(photo => {
          const folder = photo.folder || 'Sin carpeta';
          if (!byFolder[folder]) byFolder[folder] = [];
          byFolder[folder].push(photo);
        });

        // Crear opciones agrupadas
        Object.keys(byFolder).sort().forEach(folder => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = `üìÅ ${folder}`;
          
          byFolder[folder].forEach(photo => {
            const option = document.createElement('option');
            option.value = photo.id;
            option.textContent = photo.custom_name || photo.filename;
            option.dataset.url = photo.thumbnailUrl || photo.signedUrl;
            option.dataset.filename = photo.filename;
            option.dataset.folder = photo.folder;
            optgroup.appendChild(option);
          });
          
          select.appendChild(optgroup);
        });

        // Restore selection if still available
        if (currentValue) {
          const option = Array.from(select.options).find(opt => opt.value === currentValue);
          if (option) {
            select.value = currentValue;
          } else {
            document.getElementById('photoPreview').style.display = 'none';
          }
        }
      }

      // Modal for full image view
      const formImageViewModal = document.getElementById('formImageViewModal');

      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      function viewFormFullImage(url, title) {
        document.getElementById('formFullImageView').src = url;
        document.getElementById('formImageViewTitle').textContent = title;
        formImageViewModal.style.display = 'flex';
      }

      // Preview de la foto seleccionada
      document.getElementById('photoSelect').addEventListener('change', (e) => {
        const selectedOption = e.target.options[e.target.selectedIndex];
        const photoId = e.target.value;
        
        if (!photoId) {
          document.getElementById('photoPreview').style.display = 'none';
          return;
        }

        const photoUrl = selectedOption.dataset.url; // This is thumbnail
        const photoName = selectedOption.textContent;
        const photoFolder = selectedOption.dataset.folder;
        
        // Find the full photo object to get the full image URL
        const selectedPhoto = allPhotos.find(p => p.id === photoId);
        currentFullImageUrl = selectedPhoto ? selectedPhoto.signedUrl : photoUrl;
        
        document.getElementById('previewImage').src = photoUrl; // Show thumbnail
        document.getElementById('previewImage').onclick = () => viewFormFullImage(currentFullImageUrl, photoName);
        document.getElementById('previewInfo').textContent = `Carpeta: ${photoFolder}`;
        document.getElementById('photoPreview').style.display = 'block';
      });

      // Enviar formulario
      document.getElementById('mainForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const photoId = document.getElementById('photoSelect').value;
        const selectedProduct = document.querySelector('input[name="product_type"]:checked');

        const submitButton = document.getElementById('submitBtn');
        const originalButtonText = submitButton.textContent;
        
        try {
          // Disable button and show loading state
          submitButton.disabled = true;
          submitButton.textContent = 'Enviando...';
          submitButton.style.opacity = '0.6';
          
          const formData = {
            photo_id: photoId,
            form_type: 'termoformado',
            product_id: selectedProduct.value,
            // Aqu√≠ se agregar√°n m√°s campos cuando se a√±adan m√°s secciones
          };

          const response = await fetch('/api/submit-form', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (response.status === 403 && result.credits !== undefined) {
            // No credits available
            const nextReset = new Date(result.nextReset);
            alert(`‚ùå No tienes cr√©ditos disponibles\n\n` +
                  `Tus cr√©ditos se recargar√°n el ${nextReset.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                  })}\n\n` +
                  `Cada mes recibes 3 cr√©ditos nuevos.`);
            
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
            submitButton.style.opacity = '1';
            return;
          }

          if (response.ok && result.ok) {
            console.log('Formulario enviado exitosamente:', result);
            
            // Update credits display
            loadCredits();
            
            let message = '‚úÖ ¬°Formulario enviado correctamente!\n';
            message += 'üí≥ Se ha descontado 1 cr√©dito\n\n';
            
            if (result.webhook_sent) {
              message += 'üéØ Webhook enviado a Alico exitosamente';
            } else {
              message += '‚ö†Ô∏è Advertencia: El webhook no pudo ser enviado\n';
              message += `Error: ${result.webhook_error || 'Desconocido'}`;
            }
            
            alert(message);
            
            // Redirect to dashboard after success
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
          } else {
            throw new Error(result.error || 'Error al enviar formulario');
          }
        } catch (error) {
          console.error('Error al enviar formulario:', error);
          alert('‚ùå Error al enviar el formulario:\n' + error.message);
          
          // Re-enable button
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
          submitButton.style.opacity = '1';
        }
      });

      // Toggle accordion function (permite m√∫ltiples abiertos)
      function toggleAccordion(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('.accordion-icon');
        
        // Toggle the clicked accordion
        button.classList.toggle('active');
        content.classList.toggle('active');
        
        // Update icon
        if (button.classList.contains('active')) {
          icon.textContent = '‚ñ≤';
        } else {
          icon.textContent = '‚ñº';
        }
      }

      // Handle product selection
      document.querySelectorAll('.product-radio').forEach(radio => {
        radio.addEventListener('change', function() {
          // Remove selected class from all cards
          document.querySelectorAll('.product-card').forEach(card => {
            card.classList.remove('selected');
          });
          
          // Add selected class to the clicked card
          if (this.checked) {
            this.closest('.product-card').classList.add('selected');
          }
        });
      });

      // Cargar productos y fotos al iniciar
      loadProducts();
      loadPhotos();
    </script>
  </body>
</html>

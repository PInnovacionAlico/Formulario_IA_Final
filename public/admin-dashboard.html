<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Administrativo - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <script src="/shared-components.js"></script>
    <style>
      .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--alico-blue);
      }

      .stat-card.gold {
        border-left-color: var(--alico-gold);
      }

      .stat-card.purple {
        border-left-color: #9C27B0;
      }

      .stat-card.success {
        border-left-color: #28a745;
      }

      .stat-card.danger {
        border-left-color: #dc3545;
      }

      .stat-card h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #333;
        margin: 8px 0;
      }

      .stat-card .stat-label {
        font-size: 13px;
        color: #999;
      }

      .admin-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .admin-section h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #333;
        border-bottom: 2px solid var(--alico-blue);
        padding-bottom: 12px;
      }

      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .admin-table th {
        background: var(--alico-blue-10);
        color: var(--alico-blue);
        font-weight: 600;
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid var(--alico-blue);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .admin-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      .admin-table tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge.success {
        background: #d4edda;
        color: #155724;
      }

      .badge.danger {
        background: #f8d7da;
        color: #721c24;
      }

      .badge.admin {
        background: var(--alico-gold-20);
        color: var(--alico-gold);
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-small.primary {
        background: var(--alico-blue);
        color: white;
      }

      .btn-small.primary:hover {
        background: var(--alico-blue-dark);
      }

      .btn-small.danger {
        background: #dc3545;
        color: white;
      }

      .btn-small.danger:hover {
        background: #c82333;
      }

      .chart-container {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .chart-label {
        min-width: 120px;
        font-size: 13px;
        font-weight: 600;
        color: #666;
      }

      .chart-bar-fill {
        flex: 1;
        height: 30px;
        background: var(--alico-blue);
        border-radius: 4px;
        position: relative;
        margin-left: 12px;
        transition: width 0.5s ease;
      }

      .chart-bar-value {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: 700;
        font-size: 12px;
      }

      .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .admin-stats-grid {
          grid-template-columns: 1fr;
        }

        .admin-table {
          font-size: 11px;
        }

        .admin-table th,
        .admin-table td {
          padding: 6px 4px;
        }

        .btn-small {
          padding: 4px 8px;
          font-size: 10px;
        }
      }

      @media (max-width: 1024px) {
        .admin-table {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üõ°Ô∏è Dashboard Administrativo</h1>
        <div class="user-info">
          <span id="userName"></span>
          <button onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard Usuario</button>
          <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>
        <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
      </header>

      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
          </div>
          <div class="mobile-menu-buttons">
            <button onclick="location.href='/admin-dashboard.html'" class="btn-secondary active-page">üõ°Ô∏è Admin Dashboard</button>
            <button onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard Usuario</button>
            <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="loadingMessage" class="loading-spinner">
          <p>‚è≥ Cargando estad√≠sticas...</p>
        </div>

        <div id="adminContent" style="display: none;">
          <!-- Statistics Cards -->
          <div class="admin-stats-grid">
            <div class="stat-card">
              <h3>üë• Total Usuarios</h3>
              <div class="stat-value" id="statTotalUsers">-</div>
              <div class="stat-label">Usuarios registrados</div>
            </div>

            <div class="stat-card gold">
              <h3>üì∏ Total Im√°genes</h3>
              <div class="stat-value" id="statTotalUploads">-</div>
              <div class="stat-label">Im√°genes subidas</div>
            </div>

            <div class="stat-card purple">
              <h3>üé® Im√°genes IA</h3>
              <div class="stat-value" id="statAIGenerated">-</div>
              <div class="stat-label">Generadas por IA</div>
            </div>

            <div class="stat-card">
              <h3>üìã Total Formularios</h3>
              <div class="stat-value" id="statTotalSubmissions">-</div>
              <div class="stat-label">Formularios enviados</div>
            </div>

            <div class="stat-card success">
              <h3>‚úÖ Formularios Exitosos</h3>
              <div class="stat-value" id="statSuccessfulSubmissions">-</div>
              <div class="stat-label">Enviados correctamente</div>
            </div>

            <div class="stat-card danger">
              <h3>‚ùå Formularios Fallidos</h3>
              <div class="stat-value" id="statFailedSubmissions">-</div>
              <div class="stat-label">Con errores</div>
            </div>

            <div class="stat-card gold">
              <h3>üí≥ Cr√©ditos Totales</h3>
              <div class="stat-value" id="statTotalCredits">-</div>
              <div class="stat-label">Cr√©ditos disponibles</div>
            </div>

            <div class="stat-card">
              <h3>üíæ Almacenamiento</h3>
              <div class="stat-value" id="statTotalStorage">-</div>
              <div class="stat-label">MB utilizados</div>
            </div>
          </div>

          <!-- Form Type Statistics -->
          <div class="admin-section">
            <h2>üìä Formularios por Tipo</h2>
            <div class="chart-container" id="formTypeChart">
              <!-- Charts will be generated here -->
            </div>
          </div>

          <!-- Recent Submissions -->
          <div class="admin-section">
            <h2>üìù Env√≠os Recientes</h2>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>ID Env√≠o</th>
                    <th>ID Usuario</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Imagen IA</th>
                  </tr>
                </thead>
                <tbody id="recentSubmissionsTable">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Users Management -->
          <div class="admin-section">
            <h2>üë• Gesti√≥n de Usuarios</h2>
            <div style="margin-bottom: 20px;">
              <input 
                type="text" 
                id="userEmailFilter" 
                placeholder="üîç Filtrar por correo electr√≥nico..." 
                style="width: 100%; max-width: 400px; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                oninput="filterUsersByEmailDebounced(this.value)"
              />
            </div>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Cr√©ditos</th>
                    <th>üì∏ Fotos</th>
                    <th>üíæ Tama√±o</th>
                    <th>Registro</th>
                    <th>Admin</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="usersTable">
                  <tr>
                    <td colspan="10" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="usersPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
              <!-- Pagination controls will be inserted here -->
            </div>
          </div>

          <!-- All Submissions -->
          <div class="admin-section">
            <h2>üìã Todos los Formularios</h2>
            <div style="margin-bottom: 20px;">
              <input 
                type="text" 
                id="submissionUserIdFilter" 
                placeholder="üîç Filtrar por ID de usuario..." 
                style="width: 100%; max-width: 400px; padding: 12px 16px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                oninput="filterSubmissionsByUserIdDebounced(this.value)"
              />
            </div>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>ID Env√≠o</th>
                    <th>ID Usuario</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Tipo</th>
                    <th>Producto</th>
                    <th>Estado</th>
                    <th>Webhook</th>
                    <th>Imagen IA</th>
                  </tr>
                </thead>
                <tbody id="allSubmissionsTable">
                  <tr>
                    <td colspan="9" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="submissionsPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 20px;">
              <!-- Pagination controls will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Check authentication and admin status
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
      }

      // Display user info
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      document.getElementById('userName').textContent = userInfo.name || 'Usuario';
      document.getElementById('mobileUserName').textContent = userInfo.name || 'Usuario';

      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      // Mobile menu functionality
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      mobileMenuToggle.addEventListener('click', () => {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
      });

      mobileMenuClose.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
      });

      mobileMenuOverlay.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
      });

      // Check if user is admin
      async function checkAdminStatus() {
        try {
          const response = await fetch('/api/admin/check', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          const data = await response.json();
          
          if (!data.ok || !data.is_admin) {
            showError('‚õî Acceso denegado. No tienes permisos de administrador.');
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
            return false;
          }

          return true;
        } catch (err) {
          showError('Error al verificar permisos de administrador: ' + err.message);
          return false;
        }
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
      }

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          const response = await fetch('/api/admin/dashboard-stats', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar estad√≠sticas');
          }

          const data = await response.json();
          const stats = data.stats;

          // Update stat cards
          document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
          document.getElementById('statTotalUploads').textContent = stats.totalUploads || 0;
          document.getElementById('statAIGenerated').textContent = stats.aiGeneratedImages || 0;
          document.getElementById('statTotalSubmissions').textContent = stats.totalSubmissions || 0;
          document.getElementById('statSuccessfulSubmissions').textContent = stats.successfulSubmissions || 0;
          document.getElementById('statFailedSubmissions').textContent = stats.failedSubmissions || 0;
          document.getElementById('statTotalCredits').textContent = stats.totalCredits || 0;
          document.getElementById('statTotalStorage').textContent = stats.totalStorageMB || '0.00';

          // Render form type chart
          renderFormTypeChart(stats.formTypeStats);

          // Render recent submissions
          renderRecentSubmissions(stats.recentSubmissions);

          document.getElementById('loadingMessage').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
        } catch (err) {
          showError('Error al cargar estad√≠sticas: ' + err.message);
        }
      }

      // Render form type chart
      function renderFormTypeChart(formTypeStats) {
        const chartContainer = document.getElementById('formTypeChart');
        chartContainer.innerHTML = '';

        const total = Object.values(formTypeStats).reduce((sum, val) => sum + val, 0);

        if (total === 0) {
          chartContainer.innerHTML = '<p style="text-align: center; color: #999;">No hay datos de formularios a√∫n</p>';
          return;
        }

        const formTypeNames = {
          'termoformado': 'Termoformado',
          'doypack': 'Doypack',
          'flowpack': 'Flowpack',
          'sin_tipo': 'Sin tipo'
        };

        Object.entries(formTypeStats).forEach(([type, count]) => {
          const percentage = ((count / total) * 100).toFixed(1);
          const barDiv = document.createElement('div');
          barDiv.className = 'chart-bar';
          barDiv.innerHTML = `
            <div class="chart-label">${formTypeNames[type] || type}</div>
            <div class="chart-bar-fill" style="width: ${percentage}%;">
              <span class="chart-bar-value">${count}</span>
            </div>
          `;
          chartContainer.appendChild(barDiv);
        });
      }

      // Render recent submissions
      function renderRecentSubmissions(submissions) {
        const tbody = document.getElementById('recentSubmissionsTable');
        
        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #999;">No hay env√≠os recientes</td></tr>';
          return;
        }

        tbody.innerHTML = submissions.map(sub => {
          const shortSubmissionId = sub.id.substring(0, 8) + '...';
          const shortUserId = sub.user_id ? sub.user_id.substring(0, 8) + '...' : 'N/A';
          
          // AI Image cell
          const aiImageCell = sub.ai_image_url 
            ? `<a href="${sub.ai_image_url}" target="_blank" title="Ver imagen generada por IA">
                <img src="${sub.ai_image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; cursor: pointer;" />
               </a>`
            : '<span style="color: #999; font-size: 12px;">-</span>';
          
          return `
          <tr>
            <td style="font-family: monospace; font-size: 11px;" title="${sub.id}">
              ${shortSubmissionId}
              <button class="btn-small" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="copySubmissionId('${sub.id}')" title="Copiar ID de env√≠o">üìã</button>
            </td>
            <td style="font-family: monospace; font-size: 11px;" title="${sub.user_id || 'N/A'}">
              ${shortUserId}
              ${sub.user_id ? `<button class="btn-small" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="copyUserId('${sub.user_id}')" title="Copiar ID de usuario">üìã</button>` : ''}
            </td>
            <td>${new Date(sub.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
            <td>${sub.user_name}</td>
            <td>${sub.user_email}</td>
            <td>${sub.form_type || 'N/A'}</td>
            <td><span class="badge ${sub.success ? 'success' : 'danger'}">${sub.success ? '‚úÖ Exitoso' : '‚ùå Fallido'}</span></td>
            <td style="text-align: center;">${aiImageCell}</td>
          </tr>
        `;
        }).join('');
      }

      // Load all users
      async function loadUsers() {
        try {
          const response = await fetch('/api/admin/users', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar usuarios');
          }

          const data = await response.json();
          renderUsersTable(data.users);
        } catch (err) {
          console.error('Error loading users:', err);
        }
      }

      // Pagination state
      let currentUsersPage = 1;
      let currentSubmissionsPage = 1;
      let allUsersData = [];
      let filteredUsersData = [];
      let allSubmissionsData = [];
      let filteredSubmissionsData = [];
      const ITEMS_PER_PAGE = 7;

      // Render users table
      function renderUsersTable(users) {
        allUsersData = users;
        filteredUsersData = users;
        currentUsersPage = 1;
        document.getElementById('userEmailFilter').value = '';
        renderUsersTablePaginated();
      }

      function renderUsersTablePaginated() {
        const tbody = document.getElementById('usersTable');
        const users = filteredUsersData;
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 20px; color: #999;">No hay usuarios</td></tr>';
          document.getElementById('usersPagination').innerHTML = '';
          return;
        }

        const startIndex = (currentUsersPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedUsers = users.slice(startIndex, endIndex);

        tbody.innerHTML = paginatedUsers.map(user => {
          const statusBadge = user.banned 
            ? `<span class="badge danger" title="Baneado el ${new Date(user.banned_at).toLocaleDateString('es-ES')}${user.banned_by_name ? ' por ' + user.banned_by_name : ''}">üö´ Baneado</span>`
            : `<span class="badge success">‚úì Activo</span>`;
          
          const banButton = user.banned
            ? `<button class="btn-small success" onclick="unbanUser('${user.id}', '${user.name}')" ${user.is_super_admin ? 'disabled' : ''}>Desbanear</button>`
            : `<button class="btn-small" style="background: #e74c3c; color: white;" onclick="banUser('${user.id}', '${user.name}')" ${user.is_super_admin ? 'disabled' : ''}>üö´ Banear</button>`;

          // Truncate ID for display (first 8 characters)
          const shortId = user.id.substring(0, 8) + '...';

          // Admin badge with super admin variant
          const adminBadge = user.is_super_admin 
            ? '<span class="badge" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; font-weight: bold;">üëë Super Admin</span>'
            : user.is_admin 
            ? '<span class="badge admin">üõ°Ô∏è Admin</span>' 
            : '-';

          // Disable actions for super admin (except for own account)
          const isSuperAdmin = user.is_super_admin;
          const isOwnAccount = user.id === userInfo.id;
          const adminToggleButton = isSuperAdmin 
            ? '' 
            : !user.is_admin 
            ? `<button class="btn-small danger" onclick="toggleAdminStatus('${user.id}', true)" ${user.banned ? 'disabled' : ''}>Hacer Admin</button>` 
            : `<button class="btn-small danger" onclick="toggleAdminStatus('${user.id}', false)" ${user.banned ? 'disabled' : ''}>Quitar Admin</button>`;

          const deleteButton = isSuperAdmin 
            ? '' 
            : `<button class="btn-small" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;" onclick="deleteUser('${user.id}', '${user.name}')" ${user.banned ? 'disabled' : ''}>üóëÔ∏è Eliminar</button>`;

          const exportButton = isSuperAdmin 
            ? '' 
            : `<button class="btn-small" style="background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%);" onclick="exportUserDataAdmin('${user.id}', '${user.name}')">üì• Exportar</button>`;

          return `
            <tr style="${user.banned ? 'opacity: 0.7; background: #fff5f5;' : isSuperAdmin ? 'background: #fffef0;' : ''}">
              <td style="font-family: monospace; font-size: 11px;" title="${user.id}">
                ${shortId}
                <button class="btn-small" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="copyUserId('${user.id}')" title="Copiar ID completo">üìã</button>
              </td>
              <td>${user.name}</td>
              <td>${user.email}</td>
              <td>${user.credits || 0}</td>
              <td><strong>${user.total_photos || 0}</strong></td>
              <td title="Usuario: ${user.user_photos_size_mb || '0.00'} MB | IA: ${user.ai_photos_size_mb || '0.00'} MB">
                ${user.total_size_mb || '0.00'} MB
                ${user.ai_photos > 0 ? `<br><span style="font-size: 10px; color: #666;">üì∏ ${user.user_photos || 0} (${user.user_photos_size_mb || '0.00'} MB) | ü§ñ ${user.ai_photos || 0} (${user.ai_photos_size_mb || '0.00'} MB)</span>` : ''}
              </td>
              <td>${new Date(user.created_at).toLocaleDateString('es-ES')}</td>
              <td>${adminBadge}</td>
              <td>${statusBadge}</td>
              <td>
                <button class="btn-small primary" onclick="editUserCredits('${user.id}', ${user.credits})" ${user.banned || (isSuperAdmin && !isOwnAccount) ? 'disabled' : ''}>Editar Cr√©ditos</button>
                ${adminToggleButton}
                ${banButton}
                ${exportButton}
                ${deleteButton}
              </td>
            </tr>
          `;
        }).join('');

        createPaginationControls('usersPagination', filteredUsersData.length, currentUsersPage, (page) => {
          currentUsersPage = page;
          renderUsersTablePaginated();
        });
      }

      // Load all submissions
      async function loadAllSubmissions() {
        try {
          const response = await fetch('/api/admin/submissions', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar formularios');
          }

          const data = await response.json();
          renderAllSubmissionsTable(data.submissions);
        } catch (err) {
          console.error('Error loading submissions:', err);
        }
      }

      // Render all submissions table
      function renderAllSubmissionsTable(submissions) {
        allSubmissionsData = submissions;
        filteredSubmissionsData = submissions;
        currentSubmissionsPage = 1;
        document.getElementById('submissionUserIdFilter').value = '';
        renderSubmissionsTablePaginated();
      }

      function renderSubmissionsTablePaginated() {
        const tbody = document.getElementById('allSubmissionsTable');
        const submissions = filteredSubmissionsData;
        
        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #999;">No hay formularios enviados</td></tr>';
          document.getElementById('submissionsPagination').innerHTML = '';
          return;
        }

        const startIndex = (currentSubmissionsPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;
        const paginatedSubmissions = submissions.slice(startIndex, endIndex);

        tbody.innerHTML = paginatedSubmissions.map(sub => {
          const shortSubmissionId = sub.id.substring(0, 8) + '...';
          const shortUserId = sub.user_id ? sub.user_id.substring(0, 8) + '...' : 'N/A';
          
          // AI Image cell
          const aiImageCell = sub.ai_image_url 
            ? `<a href="${sub.ai_image_url}" target="_blank" title="Ver imagen generada por IA">
                <img src="${sub.ai_image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; cursor: pointer;" />
               </a>`
            : '<span style="color: #999; font-size: 12px;">-</span>';
          
          return `
          <tr>
            <td style="font-family: monospace; font-size: 11px;" title="${sub.id}">
              ${shortSubmissionId}
              <button class="btn-small" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="copySubmissionId('${sub.id}')" title="Copiar ID de env√≠o">üìã</button>
            </td>
            <td style="font-family: monospace; font-size: 11px;" title="${sub.user_id || 'N/A'}">
              ${shortUserId}
              ${sub.user_id ? `<button class="btn-small" style="margin-left: 5px; padding: 2px 6px; font-size: 10px;" onclick="copyUserId('${sub.user_id}')" title="Copiar ID de usuario">üìã</button>` : ''}
            </td>
            <td>${new Date(sub.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
            <td>${sub.user_name}</td>
            <td>${sub.form_type || 'N/A'}</td>
            <td>${sub.product_name || 'N/A'}</td>
            <td><span class="badge ${sub.success ? 'success' : 'danger'}">${sub.success ? '‚úÖ Exitoso' : '‚ùå Fallido'}</span></td>
            <td><span class="badge ${sub.webhook_sent ? 'success' : 'danger'}">${sub.webhook_sent ? '‚úÖ Enviado' : '‚ùå No enviado'}</span></td>
            <td style="text-align: center;">${aiImageCell}</td>
          </tr>
        `;
        }).join('');

        createPaginationControls('submissionsPagination', filteredSubmissionsData.length, currentSubmissionsPage, (page) => {
          currentSubmissionsPage = page;
          renderSubmissionsTablePaginated();
        });
      }

      // Filter users by email
      let filterUsersDebounceTimer;
      function filterUsersByEmailDebounced(searchValue) {
        clearTimeout(filterUsersDebounceTimer);
        filterUsersDebounceTimer = setTimeout(() => {
          filterUsersByEmail(searchValue);
        }, 300);
      }

      function filterUsersByEmail(searchValue) {
        const searchTerm = searchValue.trim().toLowerCase();
        
        if (!searchTerm) {
          filteredUsersData = allUsersData;
        } else {
          filteredUsersData = allUsersData.filter(user => 
            user.email.toLowerCase().includes(searchTerm)
          );
        }
        
        currentUsersPage = 1;
        renderUsersTablePaginated();
      }

      // Filter submissions by user ID
      let filterSubmissionsDebounceTimer;
      function filterSubmissionsByUserIdDebounced(searchValue) {
        clearTimeout(filterSubmissionsDebounceTimer);
        filterSubmissionsDebounceTimer = setTimeout(() => {
          filterSubmissionsByUserId(searchValue);
        }, 300);
      }

      function filterSubmissionsByUserId(searchValue) {
        const searchTerm = searchValue.trim().toLowerCase();
        
        if (!searchTerm) {
          filteredSubmissionsData = allSubmissionsData;
        } else {
          filteredSubmissionsData = allSubmissionsData.filter(sub => 
            sub.user_id && sub.user_id.toLowerCase().includes(searchTerm)
          );
        }
        
        currentSubmissionsPage = 1;
        renderSubmissionsTablePaginated();
      }

      // Create pagination controls
      function createPaginationControls(containerId, totalItems, currentPage, onPageChange) {
        const container = document.getElementById(containerId);
        const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

        if (totalPages <= 1) {
          container.innerHTML = '';
          return;
        }

        let html = `
          <button 
            class="btn-small" 
            style="padding: 8px 12px; background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%); color: white;" 
            ${currentPage === 1 ? 'disabled' : ''} 
            onclick="changePage${containerId}(${currentPage - 1})"
          >
            ‚Üê Anterior
          </button>
        `;

        // Calculate page range to show (max 10 pages at a time)
        const maxPagesToShow = 10;
        let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
        let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

        if (endPage - startPage < maxPagesToShow - 1) {
          startPage = Math.max(1, endPage - maxPagesToShow + 1);
        }

        // Add first page and ellipsis if needed
        if (startPage > 1) {
          html += `
            <button 
              class="btn-small" 
              style="padding: 8px 14px; ${1 === currentPage ? 'background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%); color: white; font-weight: bold;' : 'background: white; color: var(--alico-blue); border: 1px solid var(--alico-blue);'}" 
              onclick="changePage${containerId}(1)"
            >
              1
            </button>
          `;
          if (startPage > 2) {
            html += `<span style="padding: 8px; color: #999;">...</span>`;
          }
        }

        // Add page numbers
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === currentPage;
          html += `
            <button 
              class="btn-small" 
              style="padding: 8px 14px; ${isActive ? 'background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%); color: white; font-weight: bold;' : 'background: white; color: var(--alico-blue); border: 1px solid var(--alico-blue);'}" 
              onclick="changePage${containerId}(${i})"
            >
              ${i}
            </button>
          `;
        }

        // Add last page and ellipsis if needed
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            html += `<span style="padding: 8px; color: #999;">...</span>`;
          }
          html += `
            <button 
              class="btn-small" 
              style="padding: 8px 14px; ${totalPages === currentPage ? 'background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%); color: white; font-weight: bold;' : 'background: white; color: var(--alico-blue); border: 1px solid var(--alico-blue);'}" 
              onclick="changePage${containerId}(${totalPages})"
            >
              ${totalPages}
            </button>
          `;
        }

        html += `
          <button 
            class="btn-small" 
            style="padding: 8px 12px; background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%); color: white;" 
            ${currentPage === totalPages ? 'disabled' : ''} 
            onclick="changePage${containerId}(${currentPage + 1})"
          >
            Siguiente ‚Üí
          </button>
        `;

        html += `<span style="margin-left: 15px; color: #666; font-size: 14px;">P√°gina ${currentPage} de ${totalPages} (${totalItems} items)</span>`;

        container.innerHTML = html;

        // Create global change page function for this container
        window[`changePage${containerId}`] = onPageChange;
      }

      // Edit user credits
      async function editUserCredits(userId, currentCredits) {
        const newCredits = prompt(`Ingresa la nueva cantidad de cr√©ditos (actual: ${currentCredits}):`, currentCredits);
        
        if (newCredits === null) return;
        
        const credits = parseInt(newCredits);
        if (isNaN(credits) || credits < 0) {
          showNotification('Por favor ingresa un n√∫mero v√°lido de cr√©ditos', NotificationType.WARNING);
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/${userId}/credits`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ credits })
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al actualizar cr√©ditos');
          }

          showNotification('Cr√©ditos actualizados correctamente', NotificationType.SUCCESS);
          loadUsers();
        } catch (err) {
          showNotification('Error al actualizar cr√©ditos: ' + err.message, NotificationType.ERROR);
        }
      }

      // Toggle admin status
      async function toggleAdminStatus(userId, makeAdmin) {
        const confirmMessage = makeAdmin 
          ? '¬øEst√°s seguro de que quieres dar permisos de administrador a este usuario?'
          : '¬øEst√°s seguro de que quieres quitar los permisos de administrador a este usuario?';
        
        if (!confirm(confirmMessage)) return;

        try {
          const response = await fetch(`/api/admin/users/${userId}/admin-status`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_admin: makeAdmin })
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al actualizar estado de admin');
          }

          showNotification('Estado de administrador actualizado correctamente', NotificationType.SUCCESS);
          loadUsers();
        } catch (err) {
          showNotification('Error al actualizar estado: ' + err.message, NotificationType.ERROR);
        }
      }

      // Initialize dashboard
      async function initDashboard() {
        const isAdmin = await checkAdminStatus();
        if (!isAdmin) return;

        await loadDashboardStats();
        await loadUsers();
        await loadAllSubmissions();
      }

      // Show notification helper
      function showNotification(message) {
        // Create notification element if it doesn't exist
        let notification = document.getElementById('adminNotification');
        if (!notification) {
          notification = document.createElement('div');
          notification.id = 'adminNotification';
          notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            font-weight: 600;
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
          `;
          document.body.appendChild(notification);
          
          // Add animation
          const style = document.createElement('style');
          style.textContent = `
            @keyframes slideIn {
              from { transform: translateX(400px); opacity: 0; }
              to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
              from { transform: translateX(0); opacity: 1; }
              to { transform: translateX(400px); opacity: 0; }
            }
          `;
          document.head.appendChild(style);
        }
        
        notification.textContent = message;
        notification.style.display = 'block';
        notification.style.animation = 'slideIn 0.3s ease-out';
        
        // Auto hide after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => {
            notification.style.display = 'none';
          }, 300);
        }, 3000);
      }

      // Export user data (Admin function)
      async function exportUserDataAdmin(userId, userName) {
        if (!confirm(`¬øDesea exportar todos los datos de ${userName}?\n\nEsto generar√° un archivo ZIP con:\n- Informe en PDF\n- Datos en JSON\n- Todas las im√°genes subidas`)) {
          return;
        }

        try {
          // Show loading notification
          showNotification('‚è≥ Generando exportaci√≥n... Esto puede tardar unos momentos.');

          const response = await fetch(`/api/export-user-data/${userId}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al generar la exportaci√≥n');
          }

          // Get the blob from response
          const blob = await response.blob();
          
          // Create download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `datos_${userName.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.zip`;
          document.body.appendChild(a);
          a.click();
          
          // Cleanup
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showNotification('‚úÖ Exportaci√≥n completada y descargada exitosamente');
        } catch (error) {
          console.error('Error exporting data:', error);
          alert('‚ùå Error al exportar datos: ' + error.message);
        }
      }

      // Ban user
      async function banUser(userId, userName) {
        const reason = prompt(`¬øPor qu√© deseas banear a ${userName}?\n\nEscribe el motivo del baneo (esto ser√° visible para el usuario):`);
        
        if (reason === null) {
          return; // User cancelled
        }

        if (!reason.trim()) {
          alert('Debes proporcionar un motivo para el baneo');
          return;
        }

        if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres BANEAR PERMANENTEMENTE a ${userName}?\n\nMotivo: ${reason}\n\nEsta acci√≥n impedir√° que el usuario acceda a la plataforma.`)) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/${userId}/ban`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: reason.trim() })
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al banear usuario');
          }

          alert(`‚úÖ ${userName} ha sido baneado exitosamente`);
          loadUsers(); // Reload users table
        } catch (err) {
          alert('‚ùå Error al banear usuario: ' + err.message);
        }
      }

      // Unban user
      async function unbanUser(userId, userName) {
        if (!confirm(`¬øEst√°s seguro de que quieres DESBANEAR a ${userName}?\n\nEl usuario podr√° acceder nuevamente a la plataforma.`)) {
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/${userId}/unban`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al desbanear usuario');
          }

          alert(`‚úÖ ${userName} ha sido desbaneado exitosamente`);
          loadUsers(); // Reload users table
        } catch (err) {
          alert('‚ùå Error al desbanear usuario: ' + err.message);
        }
      }

      // Copy user ID to clipboard
      function copyUserId(userId) {
        navigator.clipboard.writeText(userId).then(() => {
          showNotification('ID de usuario copiado al portapapeles', NotificationType.SUCCESS);
        }).catch(err => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = userId;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showNotification('ID de usuario copiado al portapapeles', NotificationType.SUCCESS);
        });
      }

      // Copy submission ID to clipboard
      function copySubmissionId(submissionId) {
        navigator.clipboard.writeText(submissionId).then(() => {
          showNotification('ID de env√≠o copiado al portapapeles', NotificationType.SUCCESS);
        }).catch(err => {
          // Fallback for older browsers
          const textArea = document.createElement('textarea');
          textArea.value = submissionId;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
          showNotification('ID de env√≠o copiado al portapapeles', NotificationType.SUCCESS);
        });
      }

      // Delete user completely
      async function deleteUser(userId, userName) {
        // First confirmation
        if (!confirm(`‚ö†Ô∏è ADVERTENCIA: ¬øEst√°s seguro de que quieres ELIMINAR PERMANENTEMENTE a ${userName}?\n\nEsto eliminar√°:\n‚Ä¢ El usuario de la base de datos\n‚Ä¢ Todos sus formularios enviados\n‚Ä¢ Todas sus im√°genes subidas\n‚Ä¢ Todos sus datos en los buckets de almacenamiento\n\nEsta acci√≥n NO se puede deshacer.`)) {
          return;
        }

        // Second confirmation (extra safety)
        const confirmation = prompt(`Para confirmar, escribe el nombre del usuario: "${userName}"`);
        if (confirmation !== userName) {
          showNotification('Nombre incorrecto. Eliminaci√≥n cancelada.', NotificationType.WARNING);
          return;
        }

        const hideLoader = showLoader('Eliminando usuario...');
        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          const data = await response.json();
          hideLoader();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al eliminar usuario');
          }

          showNotification(`Usuario ${userName} eliminado exitosamente. Eliminado: ${data.deleted.formSubmissions} formularios, ${data.deleted.uploads} im√°genes, ${data.deleted.mobileTokens} tokens m√≥viles`, NotificationType.SUCCESS, 7000);
          loadUsers(); // Reload users table
        } catch (err) {
          hideLoader();
          showNotification('Error al eliminar usuario: ' + err.message, NotificationType.ERROR);
        }
      }

      // Start initialization
      initDashboard();
    </script>
  </body>
</html>

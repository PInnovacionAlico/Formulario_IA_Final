<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard Administrativo - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      .admin-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid var(--alico-blue);
      }

      .stat-card.gold {
        border-left-color: var(--alico-gold);
      }

      .stat-card.success {
        border-left-color: #28a745;
      }

      .stat-card.danger {
        border-left-color: #dc3545;
      }

      .stat-card h3 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .stat-card .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: #333;
        margin: 8px 0;
      }

      .stat-card .stat-label {
        font-size: 13px;
        color: #999;
      }

      .admin-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .admin-section h2 {
        margin: 0 0 20px 0;
        font-size: 20px;
        color: #333;
        border-bottom: 2px solid var(--alico-blue);
        padding-bottom: 12px;
      }

      .admin-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .admin-table th {
        background: var(--alico-blue-10);
        color: var(--alico-blue);
        font-weight: 600;
        text-align: left;
        padding: 12px;
        border-bottom: 2px solid var(--alico-blue);
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .admin-table td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }

      .admin-table tr:hover {
        background: #f8f9fa;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }

      .badge.success {
        background: #d4edda;
        color: #155724;
      }

      .badge.danger {
        background: #f8d7da;
        color: #721c24;
      }

      .badge.admin {
        background: var(--alico-gold-20);
        color: var(--alico-gold);
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-small.primary {
        background: var(--alico-blue);
        color: white;
      }

      .btn-small.primary:hover {
        background: var(--alico-blue-dark);
      }

      .btn-small.danger {
        background: #dc3545;
        color: white;
      }

      .btn-small.danger:hover {
        background: #c82333;
      }

      .chart-container {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }

      .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .chart-label {
        min-width: 120px;
        font-size: 13px;
        font-weight: 600;
        color: #666;
      }

      .chart-bar-fill {
        flex: 1;
        height: 30px;
        background: var(--alico-blue);
        border-radius: 4px;
        position: relative;
        margin-left: 12px;
        transition: width 0.5s ease;
      }

      .chart-bar-value {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        color: white;
        font-weight: 700;
        font-size: 12px;
      }

      .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #dc3545;
        margin-bottom: 20px;
      }

      @media (max-width: 768px) {
        .admin-stats-grid {
          grid-template-columns: 1fr;
        }

        .admin-table {
          font-size: 11px;
        }

        .admin-table th,
        .admin-table td {
          padding: 6px 4px;
        }

        .btn-small {
          padding: 4px 8px;
          font-size: 10px;
        }
      }

      @media (max-width: 1024px) {
        .admin-table {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üõ°Ô∏è Dashboard Administrativo</h1>
        <div class="user-info">
          <span id="userName"></span>
          <button onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard Usuario</button>
          <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>
        <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
      </header>

      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
          </div>
          <div class="mobile-menu-buttons">
            <button onclick="location.href='/admin-dashboard.html'" class="btn-secondary active-page">üõ°Ô∏è Admin Dashboard</button>
            <button onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard Usuario</button>
            <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="loadingMessage" class="loading-spinner">
          <p>‚è≥ Cargando estad√≠sticas...</p>
        </div>

        <div id="adminContent" style="display: none;">
          <!-- Statistics Cards -->
          <div class="admin-stats-grid">
            <div class="stat-card">
              <h3>üë• Total Usuarios</h3>
              <div class="stat-value" id="statTotalUsers">-</div>
              <div class="stat-label">Usuarios registrados</div>
            </div>

            <div class="stat-card gold">
              <h3>üì∏ Total Im√°genes</h3>
              <div class="stat-value" id="statTotalUploads">-</div>
              <div class="stat-label">Im√°genes subidas</div>
            </div>

            <div class="stat-card">
              <h3>üìã Total Formularios</h3>
              <div class="stat-value" id="statTotalSubmissions">-</div>
              <div class="stat-label">Formularios enviados</div>
            </div>

            <div class="stat-card success">
              <h3>‚úÖ Formularios Exitosos</h3>
              <div class="stat-value" id="statSuccessfulSubmissions">-</div>
              <div class="stat-label">Enviados correctamente</div>
            </div>

            <div class="stat-card danger">
              <h3>‚ùå Formularios Fallidos</h3>
              <div class="stat-value" id="statFailedSubmissions">-</div>
              <div class="stat-label">Con errores</div>
            </div>

            <div class="stat-card gold">
              <h3>üí≥ Cr√©ditos Totales</h3>
              <div class="stat-value" id="statTotalCredits">-</div>
              <div class="stat-label">Cr√©ditos disponibles</div>
            </div>

            <div class="stat-card">
              <h3>üíæ Almacenamiento</h3>
              <div class="stat-value" id="statTotalStorage">-</div>
              <div class="stat-label">MB utilizados</div>
            </div>
          </div>

          <!-- Form Type Statistics -->
          <div class="admin-section">
            <h2>üìä Formularios por Tipo</h2>
            <div class="chart-container" id="formTypeChart">
              <!-- Charts will be generated here -->
            </div>
          </div>

          <!-- Recent Submissions -->
          <div class="admin-section">
            <h2>üìù Env√≠os Recientes</h2>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody id="recentSubmissionsTable">
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Users Management -->
          <div class="admin-section">
            <h2>üë• Gesti√≥n de Usuarios</h2>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Cr√©ditos</th>
                    <th>üì∏ Fotos</th>
                    <th>üíæ Tama√±o</th>
                    <th>Registro</th>
                    <th>Admin</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="usersTable">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- All Submissions -->
          <div class="admin-section">
            <h2>üìã Todos los Formularios</h2>
            <div style="overflow-x: auto;">
              <table class="admin-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Tipo</th>
                    <th>Producto</th>
                    <th>Estado</th>
                    <th>Webhook</th>
                  </tr>
                </thead>
                <tbody id="allSubmissionsTable">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 20px; color: #999;">
                      Cargando...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Check authentication and admin status
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
      }

      // Display user info
      const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
      document.getElementById('userName').textContent = userInfo.name || 'Usuario';
      document.getElementById('mobileUserName').textContent = userInfo.name || 'Usuario';

      // Logout functionality
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('user');
        window.location.href = '/login.html';
      });

      // Mobile menu functionality
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      mobileMenuToggle.addEventListener('click', () => {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
      });

      mobileMenuClose.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
      });

      mobileMenuOverlay.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
      });

      // Check if user is admin
      async function checkAdminStatus() {
        try {
          const response = await fetch('/api/admin/check', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          const data = await response.json();
          
          if (!data.ok || !data.is_admin) {
            showError('‚õî Acceso denegado. No tienes permisos de administrador.');
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
            return false;
          }

          return true;
        } catch (err) {
          showError('Error al verificar permisos de administrador: ' + err.message);
          return false;
        }
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        document.getElementById('loadingMessage').style.display = 'none';
      }

      // Load dashboard statistics
      async function loadDashboardStats() {
        try {
          const response = await fetch('/api/admin/dashboard-stats', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar estad√≠sticas');
          }

          const data = await response.json();
          const stats = data.stats;

          // Update stat cards
          document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
          document.getElementById('statTotalUploads').textContent = stats.totalUploads || 0;
          document.getElementById('statTotalSubmissions').textContent = stats.totalSubmissions || 0;
          document.getElementById('statSuccessfulSubmissions').textContent = stats.successfulSubmissions || 0;
          document.getElementById('statFailedSubmissions').textContent = stats.failedSubmissions || 0;
          document.getElementById('statTotalCredits').textContent = stats.totalCredits || 0;
          document.getElementById('statTotalStorage').textContent = stats.totalStorageMB || '0.00';

          // Render form type chart
          renderFormTypeChart(stats.formTypeStats);

          // Render recent submissions
          renderRecentSubmissions(stats.recentSubmissions);

          document.getElementById('loadingMessage').style.display = 'none';
          document.getElementById('adminContent').style.display = 'block';
        } catch (err) {
          showError('Error al cargar estad√≠sticas: ' + err.message);
        }
      }

      // Render form type chart
      function renderFormTypeChart(formTypeStats) {
        const chartContainer = document.getElementById('formTypeChart');
        chartContainer.innerHTML = '';

        const total = Object.values(formTypeStats).reduce((sum, val) => sum + val, 0);

        if (total === 0) {
          chartContainer.innerHTML = '<p style="text-align: center; color: #999;">No hay datos de formularios a√∫n</p>';
          return;
        }

        const formTypeNames = {
          'termoformado': 'Termoformado',
          'doypack': 'Doypack',
          'flowpack': 'Flowpack',
          'sin_tipo': 'Sin tipo'
        };

        Object.entries(formTypeStats).forEach(([type, count]) => {
          const percentage = ((count / total) * 100).toFixed(1);
          const barDiv = document.createElement('div');
          barDiv.className = 'chart-bar';
          barDiv.innerHTML = `
            <div class="chart-label">${formTypeNames[type] || type}</div>
            <div class="chart-bar-fill" style="width: ${percentage}%;">
              <span class="chart-bar-value">${count}</span>
            </div>
          `;
          chartContainer.appendChild(barDiv);
        });
      }

      // Render recent submissions
      function renderRecentSubmissions(submissions) {
        const tbody = document.getElementById('recentSubmissionsTable');
        
        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">No hay env√≠os recientes</td></tr>';
          return;
        }

        tbody.innerHTML = submissions.map(sub => `
          <tr>
            <td>${new Date(sub.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
            <td>${sub.user_name}</td>
            <td>${sub.user_email}</td>
            <td>${sub.form_type || 'N/A'}</td>
            <td><span class="badge ${sub.success ? 'success' : 'danger'}">${sub.success ? '‚úÖ Exitoso' : '‚ùå Fallido'}</span></td>
          </tr>
        `).join('');
      }

      // Load all users
      async function loadUsers() {
        try {
          const response = await fetch('/api/admin/users', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar usuarios');
          }

          const data = await response.json();
          renderUsersTable(data.users);
        } catch (err) {
          console.error('Error loading users:', err);
        }
      }

      // Render users table
      function renderUsersTable(users) {
        const tbody = document.getElementById('usersTable');
        
        if (!users || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #999;">No hay usuarios</td></tr>';
          return;
        }

        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.credits || 0}</td>
            <td><strong>${user.total_photos || 0}</strong></td>
            <td>${user.total_size_mb || '0.00'} MB</td>
            <td>${new Date(user.created_at).toLocaleDateString('es-ES')}</td>
            <td>${user.is_admin ? '<span class="badge admin">üõ°Ô∏è Admin</span>' : '-'}</td>
            <td>
              <button class="btn-small primary" onclick="editUserCredits('${user.id}', ${user.credits})">Editar Cr√©ditos</button>
              ${!user.is_admin ? `<button class="btn-small danger" onclick="toggleAdminStatus('${user.id}', true)">Hacer Admin</button>` : `<button class="btn-small danger" onclick="toggleAdminStatus('${user.id}', false)">Quitar Admin</button>`}
            </td>
          </tr>
        `).join('');
      }

      // Load all submissions
      async function loadAllSubmissions() {
        try {
          const response = await fetch('/api/admin/submissions', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Error al cargar formularios');
          }

          const data = await response.json();
          renderAllSubmissionsTable(data.submissions);
        } catch (err) {
          console.error('Error loading submissions:', err);
        }
      }

      // Render all submissions table
      function renderAllSubmissionsTable(submissions) {
        const tbody = document.getElementById('allSubmissionsTable');
        
        if (!submissions || submissions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">No hay formularios enviados</td></tr>';
          return;
        }

        tbody.innerHTML = submissions.slice(0, 50).map(sub => `
          <tr>
            <td>${sub.id.substring(0, 8)}...</td>
            <td>${new Date(sub.created_at).toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' })}</td>
            <td>${sub.user_name}</td>
            <td>${sub.form_type || 'N/A'}</td>
            <td>${sub.product_name || 'N/A'}</td>
            <td><span class="badge ${sub.success ? 'success' : 'danger'}">${sub.success ? '‚úÖ Exitoso' : '‚ùå Fallido'}</span></td>
            <td><span class="badge ${sub.webhook_sent ? 'success' : 'danger'}">${sub.webhook_sent ? '‚úÖ Enviado' : '‚ùå No enviado'}</span></td>
          </tr>
        `).join('');

        if (submissions.length > 50) {
          tbody.innerHTML += `<tr><td colspan="7" style="text-align: center; padding: 12px; color: #999; font-style: italic;">Mostrando 50 de ${submissions.length} formularios</td></tr>`;
        }
      }

      // Edit user credits
      async function editUserCredits(userId, currentCredits) {
        const newCredits = prompt(`Ingresa la nueva cantidad de cr√©ditos (actual: ${currentCredits}):`, currentCredits);
        
        if (newCredits === null) return;
        
        const credits = parseInt(newCredits);
        if (isNaN(credits) || credits < 0) {
          alert('Por favor ingresa un n√∫mero v√°lido de cr√©ditos');
          return;
        }

        try {
          const response = await fetch(`/api/admin/users/${userId}/credits`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ credits })
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al actualizar cr√©ditos');
          }

          alert('Cr√©ditos actualizados correctamente');
          loadUsers();
        } catch (err) {
          alert('Error al actualizar cr√©ditos: ' + err.message);
        }
      }

      // Toggle admin status
      async function toggleAdminStatus(userId, makeAdmin) {
        const confirmMessage = makeAdmin 
          ? '¬øEst√°s seguro de que quieres dar permisos de administrador a este usuario?'
          : '¬øEst√°s seguro de que quieres quitar los permisos de administrador a este usuario?';
        
        if (!confirm(confirmMessage)) return;

        try {
          const response = await fetch(`/api/admin/users/${userId}/admin-status`, {
            method: 'PATCH',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ is_admin: makeAdmin })
          });

          const data = await response.json();
          
          if (!data.ok) {
            throw new Error(data.error || 'Error al actualizar estado de admin');
          }

          alert('Estado de administrador actualizado correctamente');
          loadUsers();
        } catch (err) {
          alert('Error al actualizar estado: ' + err.message);
        }
      }

      // Initialize dashboard
      async function initDashboard() {
        const isAdmin = await checkAdminStatus();
        if (!isAdmin) return;

        await loadDashboardStats();
        await loadUsers();
        await loadAllSubmissions();
      }

      // Start initialization
      initDashboard();
    </script>
  </body>
</html>

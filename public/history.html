<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Historial de Env√≠os - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <script src="/shared-components.js"></script>
    <style>
      .history-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%);
        color: white;
      }

      th {
        padding: 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        vertical-align: middle;
      }

      td {
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 14px;
        vertical-align: middle;
      }

      tbody tr:hover {
        background: var(--alico-gold-10);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
      }

      .webhook-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 16px;
        font-size: 11px;
        font-weight: 600;
      }

      .webhook-sent {
        background: var(--alico-blue-10);
        color: var(--alico-blue);
      }

      .webhook-failed {
        background: var(--alico-gold-20);
        color: var(--alico-gold-80);
      }

      .form-type-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .form-termoformado {
        background: #e3f2fd;
        color: #1565c0;
      }

      .form-doypack {
        background: #fff3e0;
        color: #e65100;
      }

      .form-flowpack {
        background: #f3e5f5;
        color: #6a1b9a;
      }

      .form-unknown {
        background: #f5f5f5;
        color: #757575;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
      }

      .empty-state-text {
        font-size: 18px;
        margin-bottom: 24px;
      }

      .btn-view-photo {
        padding: 6px 12px;
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-80) 100%);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-view-photo:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 15, 159, 0.3);
      }

      .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
        border: 2px solid var(--alico-gold-20);
      }

      .stat-number {
        font-size: 36px;
        font-weight: 700;
        color: var(--alico-gold);
        margin-bottom: 8px;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
        font-weight: 500;
      }

      .error-message {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        color: #721c24;
        font-size: 12px;
      }

      .date-filter-container {
        position: relative;
        margin-bottom: 20px;
        display: inline-block;
      }

      .date-filter-toggle {
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-80) 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 2px 6px rgba(0, 15, 159, 0.3);
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .date-filter-toggle:hover {
        background: linear-gradient(135deg, var(--alico-blue-80) 0%, var(--alico-blue) 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 10px rgba(0, 15, 159, 0.4);
      }

      .date-filter-dropdown {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        background: #1a1a2e;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        padding: 8px;
        min-width: 200px;
        z-index: 1000;
      }

      .date-filter-option {
        background: transparent;
        color: white;
        border: none;
        padding: 12px 16px;
        width: 100%;
        text-align: left;
        cursor: pointer;
        font-size: 14px;
        border-radius: 6px;
        transition: all 0.2s;
        display: block;
      }

      .date-filter-option:hover {
        background: rgba(219, 149, 0, 0.2);
        transform: translateX(4px);
      }

      .date-filter-option.active {
        background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%);
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .history-table {
          overflow-x: auto;
        }

        table {
          min-width: 800px;
        }

        th, td {
          padding: 12px 8px;
          font-size: 12px;
        }

        .stats-container {
          grid-template-columns: repeat(2, 1fr);
          gap: 12px;
        }

        .stat-card {
          padding: 16px;
        }

        .stat-number {
          font-size: 28px;
        }

        .stat-label {
          font-size: 12px;
        }
      }

      /* Estilos para botones de acci√≥n en historial */
      .action-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        justify-content: flex-start;
      }

      .btn-view-generated {
        background: linear-gradient(135deg, #9C27B0 0%, #E91E63 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .btn-view-generated:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
      }

      /* Modal de imagen generada */
      .generated-image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }

      .generated-image-content {
        background: white;
        border-radius: 12px;
        max-width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .generated-image-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-gold) 100%);
        color: white;
      }

      .generated-image-header h3 {
        margin: 0;
        font-size: 20px;
      }

      .close-modal {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .close-modal:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .generated-image-body {
        padding: 20px;
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f5f5f5;
      }

      .generated-image-preview {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .generated-image-footer {
        padding: 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e0e0e0;
      }

      .btn-download-generated {
        background: var(--alico-gold);
        color: var(--text-dark);
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-download-generated:hover {
        background: var(--alico-gold-80);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(219, 149, 0, 0.3);
      }

      .btn-close-modal {
        background: #e0e0e0;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-close-modal:hover {
        background: #d0d0d0;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üìä Historial de Env√≠os</h1>
        
        <!-- Desktop menu -->
        <div class="user-info">
          <span id="userName"></span>
          <div id="creditsDisplay" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, var(--alico-gold-20) 0%, var(--alico-gold-30) 100%); border-radius: 8px; margin-right: 12px; border: 2px solid var(--alico-gold);">
            <span style="font-size: 20px;">üí≥</span>
            <span style="font-weight: 700; color: var(--alico-gold); font-size: 18px;" id="creditsCount">...</span>
            <span style="font-size: 13px; color: var(--alico-gold-80);">cr√©ditos</span>
          </div>
          <button id="adminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
          <button onclick="location.href='/dashboard.html'" class="btn-secondary">Volver al Dashboard</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>

        <!-- Mobile hamburger button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
          ‚ò∞
        </button>
      </header>

      <!-- Mobile menu overlay and sidebar -->
      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
            <div class="mobile-menu-credits">
              <span class="mobile-menu-credits-icon">üí≥</span>
              <span class="mobile-menu-credits-count" id="mobileCreditsCount">...</span>
              <span class="mobile-menu-credits-label">cr√©ditos</span>
            </div>
          </div>
          <div class="mobile-menu-buttons">
            <button id="mobileAdminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
            <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard</button>
            <button type="button" onclick="location.href='/forms.html'" class="btn-secondary">üìã Formularios</button>
            <button type="button" onclick="location.href='/history.html'" class="btn-secondary active-page">üìä Historial</button>
            <button type="button" onclick="location.href='/settings.html'" class="btn-secondary">‚öôÔ∏è Configuraci√≥n</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <!-- Breadcrumb -->
        <div class="breadcrumb-container">
          <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
              <li class="breadcrumb-item">
                <a href="/dashboard.html">üè† Dashboard</a>
              </li>
              <li class="breadcrumb-separator">‚Ä∫</li>
              <li class="breadcrumb-item active" aria-current="page">
                üìä Historial
              </li>
            </ol>
          </nav>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-number" id="totalSubmissions">0</div>
            <div class="stat-label">Total de env√≠os</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="successfulSubmissions">0</div>
            <div class="stat-label">Exitosos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="failedSubmissions">0</div>
            <div class="stat-label">Fallidos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="webhookSuccessRate">0%</div>
            <div class="stat-label">Tasa de √©xito webhook</div>
          </div>
        </div>

        <!-- Tabla de historial -->
        <div class="gallery-section">
          <h2>Registro de Env√≠os</h2>
          
          <!-- Filtro de fechas -->
          <div class="date-filter-container">
            <button class="date-filter-toggle" id="dateFilterToggle">
              üìÖ Filtrar por fecha
            </button>
            <div class="date-filter-dropdown" id="dateFilterDropdown" style="display: none;">
              <button class="date-filter-option" data-filter="today">Hoy</button>
              <button class="date-filter-option" data-filter="7days">√öltimos 7 d√≠as</button>
              <button class="date-filter-option" data-filter="30days">√öltimos 30 d√≠as</button>
              <button class="date-filter-option" data-filter="3months">√öltimos 3 meses</button>
              <button class="date-filter-option" data-filter="all">Todos los registros</button>
            </div>
          </div>

          <div id="loadingMsg">Cargando historial...</div>
          
          <div id="historyContainer" style="display: none;">
            <div class="history-table">
              <table>
                <thead>
                  <tr>
                    <th>Fecha y Hora</th>
                    <th>Formulario</th>
                    <th>Estado</th>
                    <th>Webhook</th>
                    <th>Error</th>
                    <th>Imagen IA</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            
            <!-- Pagination Controls -->
            <div id="paginationControls"></div>
          </div>

          <div id="emptyState" style="display: none;">
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div class="empty-state-text">No hay env√≠os registrados todav√≠a</div>
              <button onclick="location.href='/form.html'" class="btn-action btn-form">üìù Crear primer formulario</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for photo details -->
    <div id="photoModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2 id="photoModalTitle">Detalles del Env√≠o</h2>
        <div id="photoModalContent"></div>
      </div>
    </div>

    <script>
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('userInfo') || '{}');
      
      if (!token) {
        window.location.href = '/login.html';
      }

      const userName = user.name || user.email || 'Usuario';
      document.getElementById('userName').textContent = userName;
      document.getElementById('mobileUserName').textContent = userName;

      // Check if user is admin and show admin button
      if (user.is_admin) {
        document.getElementById('adminDashboardBtn').style.display = 'inline-block';
        document.getElementById('mobileAdminDashboardBtn').style.display = 'block';
      }

      // Mobile menu handlers
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function openMobileMenu() {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      mobileMenuToggle.addEventListener('click', openMobileMenu);
      mobileMenuClose.addEventListener('click', closeMobileMenu);
      mobileMenuOverlay.addEventListener('click', closeMobileMenu);

      document.getElementById('mobileLogoutBtn').addEventListener('click', async () => {
        const confirmed = await showConfirmDialog('¬øEst√°s seguro que deseas cerrar sesi√≥n?', 'Cerrar sesi√≥n', 'Cancelar');
        if (confirmed) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Load user credits
      async function loadCredits() {
        try {
          const res = await fetch('/api/credits', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok) {
            // Update desktop credits
            const creditsCount = document.getElementById('creditsCount');
            creditsCount.textContent = data.credits;
            
            // Update mobile credits
            const mobileCreditsCount = document.getElementById('mobileCreditsCount');
            mobileCreditsCount.textContent = data.credits;
            
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (data.credits === 0) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
              creditsDisplay.style.borderColor = '#dc3545';
              creditsCount.style.color = '#dc3545';
              const nextReset = new Date(data.nextReset);
              creditsDisplay.title = `Se recargar√°n el ${nextReset.toLocaleDateString('es-ES')}`;
            } else if (data.credits === 1) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
              creditsDisplay.style.borderColor = '#ffc107';
              creditsCount.style.color = '#856404';
            }
          }
        } catch (err) {
          console.error('Error loading credits:', err);
        }
      }

      loadCredits();

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        const confirmed = await showConfirmDialog('¬øEst√°s seguro que deseas cerrar sesi√≥n?', 'Cerrar sesi√≥n', 'Cancelar');
        if (confirmed) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Store all submissions for filtering
      let allSubmissions = [];
      let currentFilter = 'all';
      
      // Pagination state
      let filteredSubmissions = [];
      let currentPage = 1;
      const itemsPerPage = 7;

      // Load submission history
      async function loadHistory() {
        try {
          const res = await fetch('/api/form-submissions', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          const data = await res.json();
          
          if (data.ok && data.submissions) {
            allSubmissions = data.submissions;
            
            if (data.submissions.length === 0) {
              document.getElementById('loadingMsg').style.display = 'none';
              document.getElementById('emptyState').style.display = 'block';
            } else {
              applyDateFilter(currentFilter);
              document.getElementById('loadingMsg').style.display = 'none';
              document.getElementById('historyContainer').style.display = 'block';
            }
          } else {
            throw new Error(data.error || 'Error al cargar historial');
          }
        } catch (err) {
          console.error('Error loading history:', err);
          document.getElementById('loadingMsg').innerHTML = `
            <div style="color: #721c24; padding: 20px; text-align: center;">
              ‚ùå Error al cargar el historial: ${err.message}
            </div>
          `;
        }
      }

      function renderHistoryPaginated() {
        const tbody = document.getElementById('historyTableBody');
        tbody.innerHTML = '';
        
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedSubmissions = filteredSubmissions.slice(startIndex, endIndex);

        paginatedSubmissions.forEach(sub => {
          const row = document.createElement('tr');
          
          const date = new Date(sub.completed_at);
          const formattedDate = date.toLocaleString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const statusBadge = sub.success 
            ? '<span class="status-badge status-success">‚úÖ Exitoso</span>'
            : '<span class="status-badge status-error">‚ùå Fallido</span>';

          const webhookBadge = sub.webhook_sent
            ? '<span class="webhook-badge webhook-sent">üéØ Enviado</span>'
            : '<span class="webhook-badge webhook-failed">‚ö†Ô∏è No enviado</span>';

          const errorCell = sub.error_message 
            ? `<span class="error-message" title="${sub.error_message}">${sub.error_message}</span>`
            : '-';

          // Form type badge
          const formTypeIcons = {
            'termoformado': 'üî≤',
            'doypack': 'üì¶',
            'flowpack': 'üìÑ'
          };
          const formTypeName = sub.form_type || 'No especificado';
          const formTypeIcon = formTypeIcons[sub.form_type] || '‚ùì';
          const formTypeClass = sub.form_type ? `form-${sub.form_type}` : 'form-unknown';
          const formTypeBadge = `<span class="form-type-badge ${formTypeClass}">${formTypeIcon} ${formTypeName.charAt(0).toUpperCase() + formTypeName.slice(1)}</span>`;

          // Previsualizaci√≥n de imagen IA o placeholder
          const aiImageCell = sub.generated_image_url
            ? `<a href="javascript:void(0)" onclick="viewGeneratedImage('${sub.id}', '${sub.generated_image_url}')" title="Ver imagen generada por IA">
                <img src="${sub.generated_image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" />
               </a>`
            : '<span style="color: #999; font-size: 12px;">-</span>';

          row.innerHTML = `
            <td>${formattedDate}</td>
            <td>${formTypeBadge}</td>
            <td>${statusBadge}</td>
            <td>${webhookBadge}</td>
            <td>${errorCell}</td>
            <td style="text-align: center;">${aiImageCell}</td>
            <td class="action-buttons">
              <button class="btn-view-photo" onclick="viewDetails('${sub.id}')">
                üìã Ver detalles
              </button>
            </td>
          `;

          tbody.appendChild(row);
        });
        
        // Render pagination controls
        renderPaginationControls();
      }
      
      function renderPaginationControls() {
        const paginationContainer = document.getElementById('paginationControls');
        if (!paginationContainer) return;
        
        const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
        
        if (totalPages <= 1) {
          paginationContainer.innerHTML = '';
          return;
        }
        
        let paginationHTML = '<div style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 20px; flex-wrap: wrap;">';
        
        // Previous button
        paginationHTML += `
          <button 
            onclick="changePage(${currentPage - 1})" 
            ${currentPage === 1 ? 'disabled' : ''}
            style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="if(!this.disabled) this.style.background='var(--alico-gold-10)'"
            onmouseout="this.style.background='white'">
            ‚Üê Anterior
          </button>
        `;
        
        // Page numbers with smart range
        const maxVisiblePages = 7;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // First page
        if (startPage > 1) {
          paginationHTML += `
            <button onclick="changePage(1)" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='var(--alico-gold-10)'" onmouseout="this.style.background='white'">1</button>
          `;
          if (startPage > 2) {
            paginationHTML += '<span style="padding: 8px;">...</span>';
          }
        }
        
        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
          const isActive = i === currentPage;
          paginationHTML += `
            <button 
              onclick="changePage(${i})" 
              style="padding: 8px 12px; border: 1px solid ${isActive ? 'var(--alico-gold)' : '#ddd'}; background: ${isActive ? 'var(--alico-gold)' : 'white'}; color: ${isActive ? 'white' : '#333'}; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: ${isActive ? '600' : '400'}; transition: all 0.2s;"
              ${isActive ? '' : "onmouseover=\"this.style.background='var(--alico-gold-10)'\" onmouseout=\"this.style.background='white'\""}
              ${isActive ? 'disabled' : ''}>
              ${i}
            </button>
          `;
        }
        
        // Last page
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += '<span style="padding: 8px;">...</span>';
          }
          paginationHTML += `
            <button onclick="changePage(${totalPages})" style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;" onmouseover="this.style.background='var(--alico-gold-10)'" onmouseout="this.style.background='white'">${totalPages}</button>
          `;
        }
        
        // Next button
        paginationHTML += `
          <button 
            onclick="changePage(${currentPage + 1})" 
            ${currentPage === totalPages ? 'disabled' : ''}
            style="padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="if(!this.disabled) this.style.background='var(--alico-gold-10)'"
            onmouseout="this.style.background='white'">
            Siguiente ‚Üí
          </button>
        `;
        
        paginationHTML += '</div>';
        paginationContainer.innerHTML = paginationHTML;
      }
      
      function changePage(page) {
        const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
        if (page < 1 || page > totalPages) return;
        currentPage = page;
        renderHistoryPaginated();
        
        // Scroll to top of table
        document.querySelector('.history-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      function updateStats(submissions) {
        const total = submissions.length;
        const successful = submissions.filter(s => s.success).length;
        const failed = total - successful;
        const webhookSent = submissions.filter(s => s.webhook_sent).length;
        const webhookRate = total > 0 ? Math.round((webhookSent / total) * 100) : 0;

        document.getElementById('totalSubmissions').textContent = total;
        document.getElementById('successfulSubmissions').textContent = successful;
        document.getElementById('failedSubmissions').textContent = failed;
        document.getElementById('webhookSuccessRate').textContent = webhookRate + '%';
      }

      async function viewDetails(submissionId) {
        try {
          const res = await fetch(`/api/form-submissions/${submissionId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          const data = await res.json();
          
          if (data.ok && data.submission) {
            showDetailsModal(data.submission);
          } else {
            alert('Error al cargar detalles');
          }
        } catch (err) {
          console.error('Error loading details:', err);
          alert('Error al cargar detalles: ' + err.message);
        }
      }

      function showDetailsModal(sub) {
        const modal = document.getElementById('photoModal');
        const content = document.getElementById('photoModalContent');
        
        const date = new Date(sub.completed_at);
        const formattedDate = date.toLocaleString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const formTypeIcons = {
          'termoformado': 'üî≤',
          'doypack': 'üì¶',
          'flowpack': 'üìÑ'
        };
        const formTypeDisplay = sub.form_type 
          ? `${formTypeIcons[sub.form_type] || '‚ùì'} ${sub.form_type.charAt(0).toUpperCase() + sub.form_type.slice(1)}`
          : 'No especificado';

        const productInfo = sub.product_name 
          ? `<div><strong>Producto:</strong> ${sub.product_name} <span style="color: #666;">(${sub.product_category})</span></div>`
          : '';

        // Imagen generada por IA
        const generatedImageSection = sub.generated_image_url 
          ? `
            <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid var(--alico-gold-20);">
              <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                <strong style="font-size: 16px;">üé® Imagen Generada por IA:</strong>
                <button 
                  onclick="viewGeneratedImage('${sub.id}', '${sub.generated_image_url}')"
                  style="background: linear-gradient(135deg, #9C27B0 0%, #E91E63 100%);
                         color: white;
                         border: none;
                         padding: 8px 16px;
                         border-radius: 8px;
                         cursor: pointer;
                         font-size: 13px;
                         font-weight: 600;
                         transition: all 0.3s;
                         display: flex;
                         align-items: center;
                         gap: 6px;"
                  onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(156, 39, 176, 0.4)';"
                  onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
                  title="Ver imagen generada en pantalla completa">
                  üñºÔ∏è Ver imagen completa
                </button>
              </div>
              <div style="text-align: center; background: #f5f5f5; padding: 16px; border-radius: 8px;">
                <img src="${sub.generated_image_url}" 
                     alt="Imagen generada" 
                     style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer;"
                     onclick="viewGeneratedImage('${sub.id}', '${sub.generated_image_url}')">
              </div>
              <div style="margin-top: 8px; text-align: center;">
                <a href="${sub.generated_image_url}" 
                   download="imagen_generada_${sub.id}.png"
                   style="color: var(--alico-blue); text-decoration: none; font-size: 13px; font-weight: 600;">
                  üì• Descargar imagen
                </a>
              </div>
            </div>
          `
          : '';

        content.innerHTML = `
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <!-- Header Section -->
            <div style="background: linear-gradient(135deg, var(--alico-blue-10) 0%, var(--alico-gold-10) 100%); padding: 16px; border-radius: 8px; border-left: 4px solid var(--alico-gold);">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <strong style="font-size: 13px; color: #666;">ID del Env√≠o:</strong> 
                <span style="font-family: monospace; font-size: 12px; color: #333; background: white; padding: 4px 8px; border-radius: 4px;">${sub.id.substring(0, 8)}...</span>
                <button 
                  onclick="copyToClipboard('${sub.id}')" 
                  style="background: var(--alico-gold); color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s;"
                  onmouseover="this.style.transform='scale(1.05)'"
                  onmouseout="this.style.transform='scale(1)'"
                  title="Copiar ID completo">
                  üìã Copiar
                </button>
              </div>
              <div style="font-size: 14px; color: #555;"><strong>üìÖ Fecha:</strong> ${formattedDate}</div>
            </div>

            <!-- Main Info Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Tipo de Formulario</div>
                <div style="font-size: 15px; font-weight: 600;">${formTypeDisplay}</div>
              </div>
              ${productInfo ? `<div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Producto</div>
                <div style="font-size: 15px; font-weight: 600;">${sub.product_name}</div>
                <div style="font-size: 12px; color: #999;">${sub.product_category}</div>
              </div>` : ''}
              <div style="background: #f8f9fa; padding: 12px; border-radius: 6px;">
                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">Foto Utilizada</div>
                <div style="font-size: 14px;">${sub.photo_filename || 'N/A'}</div>
              </div>
            </div>

            <!-- Status Section -->
            <div style="background: ${sub.success ? '#d4edda' : '#f8d7da'}; padding: 14px; border-radius: 8px; border-left: 4px solid ${sub.success ? '#28a745' : '#dc3545'};">
              <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                <div>
                  <span style="font-size: 12px; color: #555;">Estado:</span>
                  <strong style="font-size: 15px; margin-left: 8px;">${sub.success ? '‚úÖ Exitoso' : '‚ùå Fallido'}</strong>
                </div>
                <div>
                  <span style="font-size: 12px; color: #555;">Webhook:</span>
                  <strong style="font-size: 15px; margin-left: 8px;">${sub.webhook_sent ? '‚úÖ Enviado' : '‚ùå No enviado'}</strong>
                </div>
                ${sub.webhook_response_status ? `<div>
                  <span style="font-size: 12px; color: #555;">C√≥digo HTTP:</span>
                  <strong style="font-size: 15px; margin-left: 8px;">${sub.webhook_response_status}</strong>
                </div>` : ''}
              </div>
              ${sub.error_message ? `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1);">
                <strong style="font-size: 12px; color: #721c24;">Error:</strong>
                <div style="color: #721c24; font-size: 13px; margin-top: 4px;">${sub.error_message}</div>
              </div>` : ''}
            </div>

            ${generatedImageSection}
            
            ${sub.form_data && Object.keys(sub.form_data).length > 0 ? `
            <details style="background: #f8f9fa; padding: 14px; border-radius: 8px; cursor: pointer;">
              <summary style="font-weight: 600; font-size: 14px; user-select: none;">üìä Datos del Formulario</summary>
              <pre style="background: white; padding: 12px; border-radius: 6px; overflow-x: auto; margin-top: 12px; font-size: 12px; border: 1px solid #e0e0e0;">${JSON.stringify(sub.form_data, null, 2)}</pre>
            </details>` : ''}
          </div>
        `;

        modal.style.display = 'flex';
      }

      // Modal close handlers
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      // Date filter functionality
      const dateFilterToggle = document.getElementById('dateFilterToggle');
      const dateFilterDropdown = document.getElementById('dateFilterDropdown');

      dateFilterToggle.addEventListener('click', (e) => {
        e.stopPropagation();
        dateFilterDropdown.style.display = dateFilterDropdown.style.display === 'none' ? 'block' : 'none';
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dateFilterToggle.contains(e.target) && !dateFilterDropdown.contains(e.target)) {
          dateFilterDropdown.style.display = 'none';
        }
      });

      document.querySelectorAll('.date-filter-option').forEach(option => {
        option.addEventListener('click', () => {
          const filter = option.dataset.filter;
          currentFilter = filter;
          
          // Update active state
          document.querySelectorAll('.date-filter-option').forEach(opt => opt.classList.remove('active'));
          option.classList.add('active');
          
          // Update button text
          dateFilterToggle.textContent = 'üìÖ ' + option.textContent;
          
          // Apply filter
          applyDateFilter(filter);
          
          // Close dropdown
          dateFilterDropdown.style.display = 'none';
        });
      });

      function applyDateFilter(filter) {
        if (allSubmissions.length === 0) return;

        const now = new Date();
        filteredSubmissions = allSubmissions;

        if (filter !== 'all') {
          filteredSubmissions = allSubmissions.filter(sub => {
            const submissionDate = new Date(sub.completed_at);
            const diffTime = now - submissionDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);

            switch (filter) {
              case 'today':
                return diffDays < 1;
              case '7days':
                return diffDays <= 7;
              case '30days':
                return diffDays <= 30;
              case '3months':
                return diffDays <= 90;
              default:
                return true;
            }
          });
        }

        currentPage = 1;
        renderHistoryPaginated();
        updateStats(filteredSubmissions);
      }

      // Initialize default filter as active
      document.querySelector('.date-filter-option[data-filter="all"]').classList.add('active');

      // Copy to clipboard function
      function copyToClipboard(text) {
        // Try modern clipboard API first
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(() => {
            showCopyNotification('‚úÖ ID copiado al portapapeles');
          }).catch(err => {
            console.error('Error copying to clipboard:', err);
            fallbackCopyToClipboard(text);
          });
        } else {
          fallbackCopyToClipboard(text);
        }
      }

      // Fallback method for older browsers
      function fallbackCopyToClipboard(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          const successful = document.execCommand('copy');
          if (successful) {
            showCopyNotification('‚úÖ ID copiado al portapapeles');
          } else {
            showCopyNotification('‚ùå Error al copiar');
          }
        } catch (err) {
          console.error('Fallback copy failed:', err);
          showCopyNotification('‚ùå Error al copiar');
        }
        
        document.body.removeChild(textArea);
      }

      // Show temporary notification
      function showCopyNotification(message) {
        // Remove existing notification if any
        const existingNotification = document.getElementById('copyNotification');
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.id = 'copyNotification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%);
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10000;
          font-weight: 600;
          font-size: 14px;
          animation: slideIn 0.3s ease-out;
        `;

        document.body.appendChild(notification);

        // Remove after 3 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Descargar imagen sin redirigir
      async function downloadImage(imageUrl, fileName) {
        try {
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error('Error al descargar imagen:', error);
          alert('Error al descargar la imagen. Por favor, intenta nuevamente.');
        }
      }

      // Ver imagen generada por IA
      function viewGeneratedImage(submissionId, imageUrl) {
        // Crear modal para mostrar la imagen generada
        const modal = document.createElement('div');
        modal.className = 'generated-image-modal';
        modal.innerHTML = `
          <div class="generated-image-content">
            <div class="generated-image-header">
              <h3>üé® Imagen Generada por IA</h3>
              <button class="close-modal" onclick="this.closest('.generated-image-modal').remove()">‚úï</button>
            </div>
            <div class="generated-image-body">
              <img src="${imageUrl}" alt="Imagen generada" class="generated-image-preview" />
            </div>
            <div class="generated-image-footer">
              <button onclick="downloadImage('${imageUrl}', 'imagen_generada_${submissionId}.png')" class="btn-download-generated">
                üì• Descargar imagen
              </button>
              <button class="btn-close-modal" onclick="this.closest('.generated-image-modal').remove()">
                Cerrar
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Cerrar al hacer click fuera del contenido
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // Add animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);

      // Load history on page load
      loadHistory();
    </script>
  </body>
</html>

<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <script src="/shared-components.js"></script>
    <style>
      /* Modal de imagen completa */
      .image-preview-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease;
      }

      .image-preview-content {
        background: white;
        border-radius: 12px;
        max-width: 90%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .image-preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-gold) 100%);
        color: white;
      }

      .image-preview-header h3 {
        margin: 0;
        font-size: 20px;
      }

      .close-preview {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .close-preview:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(90deg);
      }

      .image-preview-body {
        padding: 20px;
        flex: 1;
        overflow: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f5f5f5;
      }

      .image-preview-img {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .image-preview-footer {
        padding: 20px;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        border-top: 1px solid #e0e0e0;
      }

      .btn-download-preview {
        background: var(--alico-gold);
        color: var(--text-dark);
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .btn-download-preview:hover {
        background: var(--alico-gold-80);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(219, 149, 0, 0.3);
      }

      .btn-close-preview {
        background: #e0e0e0;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .btn-close-preview:hover {
        background: #d0d0d0;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <div style="display: flex; align-items: center; gap: 12px;">
          <h1>Mi Dashboard</h1>
          <button id="tutorialButton" onclick="startTutorial()" style="
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%);
            color: white;
            border: none;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(219, 149, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
          " title="Ver tutorial" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
            ?
          </button>
        </div>
        <div class="user-info">
          <span id="userName"></span>
          <div id="creditsDisplay" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, var(--alico-gold-20) 0%, var(--alico-gold-30) 100%); border-radius: 8px; margin-right: 12px; border: 2px solid var(--alico-gold);">
            <span style="font-size: 20px;">üí≥</span>
            <span style="font-weight: 700; color: var(--alico-gold); font-size: 18px;" id="creditsCount">...</span>
            <span style="font-size: 13px; color: var(--alico-gold-80);">cr√©ditos</span>
          </div>
          <button id="adminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
          <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
          <button onclick="location.href='/history.html'" class="btn-secondary">üìä Historial</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>
        <button class="mobile-menu-toggle" id="mobileMenuToggle">‚ò∞</button>
      </header>

      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
            <div class="mobile-menu-credits">
              <span class="mobile-menu-credits-icon">üí≥</span>
              <span class="mobile-menu-credits-count" id="mobileCreditsCount">...</span>
              <span class="mobile-menu-credits-label">cr√©ditos</span>
            </div>
          </div>
          <div class="mobile-menu-buttons">
            <button id="mobileAdminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
            <button onclick="location.href='/dashboard.html'" class="btn-secondary active-page">üè† Dashboard</button>
            <button onclick="location.href='/forms.html'" class="btn-action btn-form">üìù Formularios</button>
            <button onclick="location.href='/history.html'" class="btn-secondary">üìä Historial</button>
            <button onclick="location.href='/settings.html'" class="btn-secondary">‚öôÔ∏è Configuraci√≥n</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <div class="gallery-section">
            <!-- Breadcrumb -->
            <div class="breadcrumb-container">
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item active" aria-current="page">
                    üè† Dashboard
                  </li>
                </ol>
              </nav>
            </div>

            <div class="action-buttons">
              <button id="uploadBtn" class="btn-action btn-upload">üì∑ Subir foto</button>
              <button id="qrUploadBtn" class="btn-action" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">üì± Subir desde celular</button>
              <button id="createFolderBtn" class="btn-action btn-folder">üìÅ Nueva carpeta</button>
              <span id="cacheBadge" style="display: none; margin-left: 12px; padding: 6px 12px; background: var(--alico-gold-20); color: var(--alico-gold); border-radius: 6px; font-size: 12px; font-weight: 600;">üì¶ Cargado desde cach√©</span>
            </div>
            <h2 style="display: inline-block;">Mis Fotos</h2>
            <span id="photoCountBadge" style="display: inline-block; margin-left: 12px; padding: 8px 16px; background: #28a745; color: white; border-radius: 20px; font-size: 14px; font-weight: 600;">0/4 fotos</span>
            <div id="loadingMsg">Cargando...</div>
            <div id="gallery"></div>
        </div>
      </div>
    </div>

    <!-- Modal for upload -->
    <div id="uploadModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>Subir fotos</h2>
        <form id="uploadForm" enctype="multipart/form-data">
          <div style="background: #f0f8ff; border-left: 4px solid var(--alico-blue); padding: 12px; margin: 12px 0; border-radius: 6px;">
            <p style="margin: 0; font-size: 13px; color: #333; line-height: 1.6;">
              <strong>‚ÑπÔ∏è Formatos permitidos:</strong> JPG, JPEG, PNG<br>
              <strong>üì¶ Tama√±o m√°ximo:</strong> 5 MB por archivo<br>
              <strong>üì∏ M√∫ltiples archivos:</strong> Puedes seleccionar varias fotos a la vez<br>
              <strong>‚ö†Ô∏è L√≠mite:</strong> M√°ximo 4 fotos subidas (las im√°genes generadas por IA no cuentan)
            </p>
          </div>
          <div style="background: #e8f5e9; border-left: 4px solid #28a745; padding: 12px; margin: 12px 0; border-radius: 6px;">
            <p style="margin: 0; font-size: 13px; color: #2e7d32; line-height: 1.6;">
              <strong>üîÑ Optimizaci√≥n autom√°tica:</strong> Tus im√°genes se optimizar√°n autom√°ticamente antes de subirse, reduciendo el tama√±o del archivo sin p√©rdida visible de calidad. Esto ahorra espacio y mejora la velocidad de carga.
            </p>
          </div>
          <label>Selecciona una o m√°s im√°genes
            <input type="file" id="fileInputUpload" name="file" accept="image/jpeg,image/jpg,image/png" multiple required />
          </label>
          <div id="uploadPreview" style="display: none; margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px;">
            <p style="margin: 0 0 8px 0; font-weight: 600; color: #333;">Archivos seleccionados:</p>
            <div id="uploadFileList" style="font-size: 13px; color: #666;"></div>
          </div>
          <label>Carpeta de destino
            <select id="uploadFolderSelect" name="folder">
              <option value="Sin carpeta">Sin carpeta</option>
            </select>
          </label>
          <button type="submit" id="uploadSubmitBtn">Subir</button>
          <div id="uploadResult" class="result"></div>
        </form>
      </div>
    </div>

    <!-- Modal for folder creation -->
    <div id="folderModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>Seleccionar o crear carpeta</h2>
        <div id="existingFoldersList"></div>
        <button id="newFolderBtn" class="btn-new-folder">+ Nueva carpeta</button>
        <div id="newFolderSection" style="display: none; margin-top: 16px;">
          <input type="text" id="newFolderName" placeholder="Nombre de la carpeta" />
          <button id="confirmFolderBtn" class="btn-primary">Crear</button>
        </div>
        <div id="folderResult" class="result"></div>
      </div>
    </div>

    <!-- Modal for folder selection -->
    <div id="selectFolderModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>Seleccionar carpeta</h2>
        <div id="folderList"></div>
        <div style="margin-top: 20px; display: flex; gap: 12px; justify-content: flex-end;">
          <button id="cancelFolderChangeBtn" class="btn-secondary" style="padding: 12px 24px;">Cancelar</button>
          <button id="confirmFolderChangeBtn" class="btn-action" style="padding: 12px 24px; background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%); color: white; font-weight: 600;" disabled>Confirmar</button>
        </div>
      </div>
    </div>

    <!-- Modal for full image view -->
    <div id="imageViewModal" class="modal">
      <div class="modal-content modal-image">
        <span class="modal-close">&times;</span>
        <h2 id="imageViewTitle">Imagen</h2>
        <img id="fullImageView" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;" />
      </div>
    </div>

    <!-- Modal for delete folder -->
    <div id="deleteFolderModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>üóëÔ∏è Eliminar Carpeta</h2>
        <p style="margin: 16px 0; color: #666;">
          ¬øQu√© deseas hacer con las <strong id="folderImageCount">0</strong> im√°genes de la carpeta "<strong id="folderNameToDelete"></strong>"?
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 24px;">
          <button id="moveFolderImagesBtn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(219, 149, 0, 0.3);">
            üìÅ Mover a otra carpeta
          </button>
          <button id="deleteAllImagesBtn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);">
            üóëÔ∏è Eliminar todas las im√°genes
          </button>
          <button id="cancelDeleteFolderBtn" style="width: 100%; padding: 14px; background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-80) 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(0, 15, 159, 0.3);">
            Cancelar
          </button>
        </div>
        <div id="deleteFolderResult" class="result" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Modal for select destination folder -->
    <div id="moveImagesModal" class="modal">
      <div class="modal-content">
        <span class="modal-close">&times;</span>
        <h2>üìÅ Seleccionar carpeta destino</h2>
        <p style="margin: 16px 0; color: #666;">
          Selecciona la carpeta a la que deseas mover las im√°genes:
        </p>
        <div id="destinationFolderList" style="margin-top: 16px;"></div>
        <div id="selectedFolderInfo" style="margin: 16px 0; padding: 12px; background: var(--alico-gold-10); border-left: 4px solid var(--alico-gold); border-radius: 6px; display: none;">
          <p style="margin: 0; color: #333; font-weight: 600;">
            üìÅ Carpeta seleccionada: <span id="selectedFolderName"></span>
          </p>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button id="confirmMoveBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, var(--alico-gold) 0%, var(--alico-gold-80) 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(219, 149, 0, 0.3); display: none;">
            ‚úÖ Confirmar y mover
          </button>
          <button id="cancelMoveBtn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);">
            Cancelar
          </button>
        </div>
        <div id="moveImagesResult" class="result" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Modal for QR Code Upload -->
    <div id="qrUploadModal" class="modal">
      <div class="modal-content" style="max-width: 500px;">
        <span class="modal-close">&times;</span>
        <h2 style="text-align: center; margin-bottom: 16px;">üì± Subir desde el celular</h2>
        <p style="text-align: center; color: #666; margin-bottom: 24px;">
          Escanea este c√≥digo QR con tu celular para subir fotos directamente a tu cuenta
        </p>
        <div id="qrCodeContainer" style="display: flex; justify-content: center; align-items: center; min-height: 280px; background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
          <div style="text-align: center;">
            <div id="qrCodeImage"></div>
            <p id="qrCodeExpiry" style="margin-top: 16px; font-size: 13px; color: #666;"></p>
          </div>
        </div>
        <div style="background: var(--alico-gold-10); border-left: 4px solid var(--alico-gold); border-radius: 8px; padding: 16px; margin-top: 16px;">
          <p style="margin: 0; font-size: 14px; color: #333;">
            <strong>üí° Instrucciones:</strong><br>
            1. Abre la c√°mara de tu celular<br>
            2. Escanea el c√≥digo QR<br>
            3. Se abrir√° una p√°gina para subir fotos<br>
            4. Las fotos se subir√°n autom√°ticamente a tu cuenta
          </p>
        </div>
        <div style="background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; padding: 12px; margin-top: 12px;">
          <p style="margin: 0; font-size: 13px; color: #856404;">
            ‚ö†Ô∏è Este enlace expira en <strong>30 minutos</strong> por seguridad
          </p>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('userInfo') || '{}');
      let allFolders = ['Sin carpeta'];
      let currentPhotoId = null;
      let allUploads = [];
      
      if (!token) {
        window.location.href = '/login.html';
      }

      const userName = user.name || user.email || 'Usuario';
      document.getElementById('userName').textContent = userName;
      document.getElementById('mobileUserName').textContent = userName;

      // Check if user is admin and show admin button
      if (user.is_admin) {
        document.getElementById('adminDashboardBtn').style.display = 'inline-block';
        document.getElementById('mobileAdminDashboardBtn').style.display = 'block';
      }

      // Mobile menu handlers
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function openMobileMenu() {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      mobileMenuToggle.addEventListener('click', openMobileMenu);
      mobileMenuClose.addEventListener('click', closeMobileMenu);
      mobileMenuOverlay.addEventListener('click', closeMobileMenu);

      document.getElementById('mobileLogoutBtn').addEventListener('click', async () => {
        const confirmed = await showConfirmDialog('¬øEst√°s seguro que deseas cerrar sesi√≥n?', 'Cerrar sesi√≥n', 'Cancelar');
        if (confirmed) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Load user credits
      async function loadCredits() {
        try {
          const res = await fetch('/api/credits', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok) {
            const creditsCount = document.getElementById('creditsCount');
            creditsCount.textContent = data.credits;
            document.getElementById('mobileCreditsCount').textContent = data.credits;
            
            // Change color based on credits remaining
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (data.credits === 0) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
              creditsDisplay.style.borderColor = '#dc3545';
              creditsCount.style.color = '#dc3545';
              
              // Show next reset date
              const nextReset = new Date(data.nextReset);
              creditsDisplay.title = `Se recargar√°n el ${nextReset.toLocaleDateString('es-ES')}`;
            } else if (data.credits === 1) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
              creditsDisplay.style.borderColor = '#ffc107';
              creditsCount.style.color = '#856404';
            }
          }
        } catch (err) {
          console.error('Error loading credits:', err);
        }
      }

      loadCredits();

      document.getElementById('logoutBtn').addEventListener('click', async () => {
        const confirmed = await showConfirmDialog('¬øEst√°s seguro que deseas cerrar sesi√≥n?', 'Cerrar sesi√≥n', 'Cancelar');
        if (confirmed) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Modal controls
      const uploadModal = document.getElementById('uploadModal');
      const folderModal = document.getElementById('folderModal');
      const selectFolderModal = document.getElementById('selectFolderModal');
      const imageViewModal = document.getElementById('imageViewModal');

      function viewFullImage(url, title) {
        document.getElementById('fullImageView').src = url;
        document.getElementById('imageViewTitle').textContent = title;
        imageViewModal.style.display = 'flex';
      }

      // Delete folder functions
      let folderToDelete = null;
      let imagesInFolder = [];
      const deleteFolderModal = document.getElementById('deleteFolderModal');
      const moveImagesModal = document.getElementById('moveImagesModal');

      function showDeleteFolderModal(folderName, images) {
        folderToDelete = folderName;
        imagesInFolder = images;
        document.getElementById('folderNameToDelete').textContent = folderName;
        document.getElementById('folderImageCount').textContent = images.length;
        document.getElementById('deleteFolderResult').textContent = '';
        deleteFolderModal.style.display = 'flex';
      }

      // Add hover effects to delete folder modal buttons
      const moveFolderBtn = document.getElementById('moveFolderImagesBtn');
      const deleteAllBtn = document.getElementById('deleteAllImagesBtn');
      const cancelDeleteBtn = document.getElementById('cancelDeleteFolderBtn');

      moveFolderBtn.addEventListener('mouseenter', (e) => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(219, 149, 0, 0.5)';
      });
      moveFolderBtn.addEventListener('mouseleave', (e) => {
        e.target.style.transform = '';
        e.target.style.boxShadow = '0 2px 6px rgba(219, 149, 0, 0.3)';
      });

      deleteAllBtn.addEventListener('mouseenter', (e) => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(220, 53, 69, 0.5)';
      });
      deleteAllBtn.addEventListener('mouseleave', (e) => {
        e.target.style.transform = '';
        e.target.style.boxShadow = '0 2px 6px rgba(220, 53, 69, 0.3)';
      });

      cancelDeleteBtn.addEventListener('mouseenter', (e) => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(0, 15, 159, 0.5)';
      });
      cancelDeleteBtn.addEventListener('mouseleave', (e) => {
        e.target.style.transform = '';
        e.target.style.boxShadow = '0 2px 6px rgba(0, 15, 159, 0.3)';
      });

      document.getElementById('moveFolderImagesBtn').addEventListener('click', () => {
        showMoveImagesModal();
      });

      document.getElementById('deleteAllImagesBtn').addEventListener('click', async () => {
        if (!confirm(`¬øEst√°s seguro que deseas eliminar todas las ${imagesInFolder.length} im√°genes de la carpeta "${folderToDelete}"?`)) {
          return;
        }

        const resultEl = document.getElementById('deleteFolderResult');
        const deleteBtn = document.getElementById('deleteAllImagesBtn');
        const moveBtn = document.getElementById('moveFolderImagesBtn');
        const cancelBtn = document.getElementById('cancelDeleteFolderBtn');
        
        resultEl.textContent = 'Eliminando im√°genes...';
        resultEl.style.color = '';
        deleteBtn.disabled = true;
        moveBtn.disabled = true;
        cancelBtn.disabled = true;

        try {
          let deletedCount = 0;
          let failedCount = 0;
          const totalImages = imagesInFolder.length;
          
          for (let i = 0; i < imagesInFolder.length; i++) {
            const image = imagesInFolder[i];
            resultEl.textContent = `Eliminando imagen ${i + 1} de ${totalImages}...`;
            
            try {
              const res = await fetch(`/api/uploads/${image.id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
              });
              
              const data = await res.json();
              
              if (res.ok && data.ok) {
                deletedCount++;
              } else {
                console.error(`Error deleting image ${image.id}:`, data.error);
                failedCount++;
              }
            } catch (err) {
              console.error(`Error deleting image ${image.id}:`, err);
              failedCount++;
            }
            
            // Small delay to avoid overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          if (failedCount === 0) {
            resultEl.textContent = `‚úÖ ${deletedCount} im√°genes eliminadas correctamente`;
            resultEl.style.color = '#28a745';
          } else {
            resultEl.textContent = `‚ö†Ô∏è ${deletedCount} eliminadas, ${failedCount} fallaron`;
            resultEl.style.color = '#ff9800';
          }
          
          invalidateCache();
          setTimeout(() => {
            deleteFolderModal.style.display = 'none';
            deleteBtn.disabled = false;
            moveBtn.disabled = false;
            cancelBtn.disabled = false;
            loadUploads(true);
          }, 2000);
        } catch (err) {
          resultEl.textContent = '‚ùå Error: ' + err.message;
          resultEl.style.color = '#dc3545';
          deleteBtn.disabled = false;
          moveBtn.disabled = false;
          cancelBtn.disabled = false;
        }
      });

      document.getElementById('cancelDeleteFolderBtn').addEventListener('click', () => {
        deleteFolderModal.style.display = 'none';
      });

      let selectedDestinationFolder = null;

      function showMoveImagesModal() {
        selectedDestinationFolder = null;
        const availableFolders = allFolders.filter(f => f !== folderToDelete && f !== 'Sin carpeta');
        availableFolders.push('Sin carpeta');
        
        const list = document.getElementById('destinationFolderList');
        const confirmBtn = document.getElementById('confirmMoveBtn');
        const selectedInfo = document.getElementById('selectedFolderInfo');
        
        list.innerHTML = '';
        confirmBtn.style.display = 'none';
        selectedInfo.style.display = 'none';
        document.getElementById('moveImagesResult').textContent = '';
        
        if (availableFolders.length === 1 && availableFolders[0] === 'Sin carpeta') {
          list.innerHTML = '<p style="color: #666;">No hay otras carpetas disponibles. Crea una nueva carpeta primero.</p>';
        } else {
          availableFolders.forEach(folder => {
            const btn = document.createElement('button');
            btn.className = 'folder-option';
            btn.style.cssText = 'width: 100%; padding: 12px; margin: 8px 0; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 15px; transition: all 0.3s; text-align: left;';
            btn.textContent = `üìÅ ${folder}`;
            btn.onclick = (e) => {
              // Remove selection from all buttons
              document.querySelectorAll('#destinationFolderList .folder-option').forEach(b => {
                b.style.background = 'white';
                b.style.border = '2px solid #ddd';
              });
              // Mark this button as selected
              e.target.style.background = 'var(--alico-gold-10)';
              e.target.style.border = '2px solid var(--alico-gold)';
              
              // Store selected folder and show confirm button
              selectedDestinationFolder = folder;
              document.getElementById('selectedFolderName').textContent = folder;
              selectedInfo.style.display = 'block';
              confirmBtn.style.display = 'block';
            };
            btn.onmouseenter = (e) => {
              if (e.target.style.border !== '2px solid var(--alico-gold)') {
                e.target.style.background = '#f8f9fa';
              }
            };
            btn.onmouseleave = (e) => {
              if (e.target.style.border !== '2px solid var(--alico-gold)') {
                e.target.style.background = 'white';
              }
            };
            list.appendChild(btn);
          });
        }
        
        deleteFolderModal.style.display = 'none';
        moveImagesModal.style.display = 'flex';
      }

      // Confirm move button handler
      document.getElementById('confirmMoveBtn').addEventListener('click', () => {
        if (selectedDestinationFolder) {
          moveImagesToFolder(selectedDestinationFolder);
        }
      });

      // Cancel move button handler
      document.getElementById('cancelMoveBtn').addEventListener('click', () => {
        moveImagesModal.style.display = 'none';
      });

      // Add hover effects to move modal buttons
      const confirmMoveBtn = document.getElementById('confirmMoveBtn');
      const cancelMoveBtn = document.getElementById('cancelMoveBtn');

      confirmMoveBtn.addEventListener('mouseenter', (e) => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(219, 149, 0, 0.5)';
      });
      confirmMoveBtn.addEventListener('mouseleave', (e) => {
        e.target.style.transform = '';
        e.target.style.boxShadow = '0 2px 6px rgba(219, 149, 0, 0.3)';
      });

      cancelMoveBtn.addEventListener('mouseenter', (e) => {
        e.target.style.transform = 'translateY(-2px)';
        e.target.style.boxShadow = '0 4px 12px rgba(108, 117, 125, 0.5)';
      });
      cancelMoveBtn.addEventListener('mouseleave', (e) => {
        e.target.style.transform = '';
        e.target.style.boxShadow = '0 2px 6px rgba(108, 117, 125, 0.3)';
      });

      async function moveImagesToFolder(destinationFolder) {
        const resultEl = document.getElementById('moveImagesResult');
        const confirmBtn = document.getElementById('confirmMoveBtn');
        const cancelBtn = document.getElementById('cancelMoveBtn');
        
        resultEl.textContent = `Moviendo ${imagesInFolder.length} im√°genes a "${destinationFolder}"...`;
        resultEl.style.color = '';
        confirmBtn.disabled = true;
        cancelBtn.disabled = true;

        try {
          let movedCount = 0;
          let failedCount = 0;
          const totalImages = imagesInFolder.length;
          
          for (let i = 0; i < imagesInFolder.length; i++) {
            const image = imagesInFolder[i];
            resultEl.textContent = `Moviendo imagen ${i + 1} de ${totalImages}...`;
            
            try {
              const res = await fetch(`/api/uploads/${image.id}`, {
                method: 'PATCH',
                headers: {
                  'Authorization': 'Bearer ' + token,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  folder: destinationFolder === 'Sin carpeta' ? null : destinationFolder
                })
              });
              
              const data = await res.json();
              
              if (res.ok && data.ok) {
                movedCount++;
              } else {
                console.error(`Error moving image ${image.id}:`, data.error);
                failedCount++;
              }
            } catch (err) {
              console.error(`Error moving image ${image.id}:`, err);
              failedCount++;
            }
            
            // Small delay to avoid overwhelming the server
            await new Promise(resolve => setTimeout(resolve, 100));
          }

          if (failedCount === 0) {
            resultEl.textContent = `‚úÖ ${movedCount} im√°genes movidas a "${destinationFolder}"`;
            resultEl.style.color = '#28a745';
          } else {
            resultEl.textContent = `‚ö†Ô∏è ${movedCount} movidas, ${failedCount} fallaron`;
            resultEl.style.color = '#ff9800';
          }
          
          invalidateCache();
          setTimeout(() => {
            moveImagesModal.style.display = 'none';
            confirmBtn.disabled = false;
            cancelBtn.disabled = false;
            loadUploads(true);
          }, 2000);
        } catch (err) {
          resultEl.textContent = '‚ùå Error: ' + err.message;
          resultEl.style.color = '#dc3545';
          confirmBtn.disabled = false;
          cancelBtn.disabled = false;
        }
      }

      document.getElementById('uploadBtn').addEventListener('click', () => {
        // Verificar l√≠mite de 4 fotos (solo fotos subidas, no generadas)
        const count = window.currentUserPhotosCount || 0;
        if (count >= 4) {
          showNotification('Has alcanzado el l√≠mite de 4 fotos subidas. Elimina algunas fotos antes de subir nuevas. Las im√°genes generadas por IA no cuentan en este l√≠mite.', NotificationType.WARNING, 6000);
          return;
        }
        updateFolderSelect();
        uploadModal.style.display = 'flex';
      });

      document.getElementById('qrUploadBtn').addEventListener('click', async () => {
        // Verificar l√≠mite de 4 fotos (solo fotos subidas, no generadas)
        const count = window.currentUserPhotosCount || 0;
        if (count >= 4) {
          showNotification('Has alcanzado el l√≠mite de 4 fotos subidas. Elimina algunas fotos antes de subir nuevas. Las im√°genes generadas por IA no cuentan en este l√≠mite.', NotificationType.WARNING, 6000);
          return;
        }
        
        const qrModal = document.getElementById('qrUploadModal');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrCodeExpiry = document.getElementById('qrCodeExpiry');
        
        qrModal.style.display = 'flex';
        qrCodeImage.innerHTML = '<p style="color: #666;">Generando c√≥digo QR...</p>';
        
        try {
          // Generar token temporal para subida desde m√≥vil
          const response = await fetch('/api/generate-upload-token', {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (data.ok) {
            // Construir URL completa
            const uploadUrl = `${window.location.origin}/mobile-upload.html?token=${data.uploadToken}`;
            
            // Limpiar contenedor
            qrCodeImage.innerHTML = '';
            
            // Verificar que la librer√≠a QRCode est√© cargada
            if (typeof QRCode !== 'undefined') {
              // Generar c√≥digo QR usando QRCode.js
              new QRCode(qrCodeImage, {
                text: uploadUrl,
                width: 240,
                height: 240,
                colorDark: '#000F9F',  // Alico blue
                colorLight: '#FFFFFF',
                correctLevel: QRCode.CorrectLevel.H
              });
            } else {
              // Fallback: usar API de Google Charts
              const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=240x240&data=${encodeURIComponent(uploadUrl)}&color=000F9F&bgcolor=FFFFFF`;
              qrCodeImage.innerHTML = `<img src="${qrUrl}" alt="QR Code" style="border-radius: 8px;" />`;
            }
            
            // Mostrar tiempo de expiraci√≥n
            const expiryTime = new Date(Date.now() + 30 * 60 * 1000).toLocaleTimeString('es-ES', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            qrCodeExpiry.textContent = `‚è∞ V√°lido hasta: ${expiryTime}`;
          } else {
            qrCodeImage.innerHTML = '<p style="color: #dc3545;">‚ùå Error al generar el c√≥digo QR</p>';
          }
        } catch (err) {
          qrCodeImage.innerHTML = '<p style="color: #dc3545;">‚ùå Error: ' + err.message + '</p>';
        }
      });

      document.getElementById('createFolderBtn').addEventListener('click', () => {
        showFolderManager();
      });

      document.getElementById('newFolderBtn').addEventListener('click', () => {
        document.getElementById('newFolderSection').style.display = 'block';
        document.getElementById('newFolderName').focus();
      });

      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      document.getElementById('confirmFolderBtn').addEventListener('click', () => {
        const folderName = document.getElementById('newFolderName').value.trim();
        if (!folderName) {
          document.getElementById('folderResult').textContent = 'Ingresa un nombre';
          return;
        }
        if (allFolders.includes(folderName)) {
          document.getElementById('folderResult').textContent = 'La carpeta ya existe';
          return;
        }
        allFolders.push(folderName);
        
        // Agregar acorde√≥n vac√≠o inmediatamente
        addEmptyFolderAccordion(folderName);
        
        document.getElementById('folderResult').textContent = '¬°Carpeta creada!';
        setTimeout(() => {
          folderModal.style.display = 'none';
          document.getElementById('newFolderSection').style.display = 'none';
          document.getElementById('newFolderName').value = '';
        }, 800);
      });

      async function loadUploads(forceRefresh = false) {
        try {
          const cacheKey = `dashboard_uploads_${user.id}`;
          const cacheTimestampKey = `dashboard_uploads_timestamp_${user.id}`;
          const CACHE_DURATION = 5 * 60 * 1000; // 5 minutos
          
          // Try to load from cache first (if not forcing refresh)
          if (!forceRefresh) {
            const cachedData = localStorage.getItem(cacheKey);
            const cacheTimestamp = localStorage.getItem(cacheTimestampKey);
            
            if (cachedData && cacheTimestamp) {
              const age = Date.now() - parseInt(cacheTimestamp);
              
              // If cache is less than 5 minutes old, use it
              if (age < CACHE_DURATION) {
                console.log('üì¶ Loading from cache (age: ' + Math.round(age / 1000) + 's)');
                const uploads = JSON.parse(cachedData);
                document.getElementById('loadingMsg').style.display = 'none';
                
                // Show cache badge
                const cacheBadge = document.getElementById('cacheBadge');
                if (cacheBadge) {
                  cacheBadge.style.display = 'inline-block';
                  setTimeout(() => { cacheBadge.style.display = 'none'; }, 3000);
                }
                
                // Store all uploads
                allUploads = uploads;
                
                // Calculate user photos count from cached data (exclude AI Generated)
                window.currentUserPhotosCount = uploads.filter(u => u.folder !== 'AI Generated').length;
                
                // extract unique folders
                const folders = new Set();
                uploads.forEach(u => {
                  let folderName = u.folder || 'Sin carpeta';
                  // Renombrar carpeta de IA
                  if (folderName === 'AI Generated') folderName = 'Im√°genes generadas por IA';
                  folders.add(folderName);
                });
                allFolders = Array.from(folders).sort();
                if (!allFolders.includes('Sin carpeta')) allFolders.unshift('Sin carpeta');
                
                renderGallery(uploads);
                
                // Still check for updates in background
                checkForUpdates();
                return;
              }
            }
          }
          
          // Fetch fresh data from server
          console.log('üåê Fetching from server...');
          const res = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          document.getElementById('loadingMsg').style.display = 'none';
          
          if (data.ok && data.uploads) {
            // Save to cache
            localStorage.setItem(cacheKey, JSON.stringify(data.uploads));
            localStorage.setItem(cacheTimestampKey, Date.now().toString());
            
            // Store user photos count (for limit validation)
            window.currentUserPhotosCount = data.userPhotosCount || 0;
            
            // Store all uploads
            allUploads = data.uploads;
            
            // extract unique folders
            const folders = new Set();
            data.uploads.forEach(u => {
              let folderName = u.folder || 'Sin carpeta';
              // Renombrar carpeta de IA
              if (folderName === 'AI Generated') folderName = 'Im√°genes generadas por IA';
              folders.add(folderName);
            });
            allFolders = Array.from(folders).sort();
            if (!allFolders.includes('Sin carpeta')) allFolders.unshift('Sin carpeta');
            
            renderGallery(data.uploads);
          } else {
            document.getElementById('gallery').innerHTML = '<p>Error al cargar fotos</p>';
          }
        } catch (err) {
          document.getElementById('loadingMsg').style.display = 'none';
          document.getElementById('gallery').innerHTML = '<p>Error: ' + err + '</p>';
        }
      }

      // Check for updates in background
      async function checkForUpdates() {
        try {
          const res = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok && data.uploads) {
            const cacheKey = `dashboard_uploads_${user.id}`;
            const cachedData = localStorage.getItem(cacheKey);
            
            // Compare with cache
            if (cachedData) {
              const cached = JSON.parse(cachedData);
              
              // Smart comparison: only check metadata, not URLs (they change every time)
              const hasRealChanges = 
                cached.length !== data.uploads.length || 
                cached.some((c, i) => {
                  const current = data.uploads.find(u => u.id === c.id);
                  if (!current) return true; // Photo deleted
                  // Compare only important fields, not URLs
                  return c.filename !== current.filename ||
                         c.custom_name !== current.custom_name ||
                         c.folder !== current.folder ||
                         c.size !== current.size;
                }) ||
                data.uploads.some(u => !cached.find(c => c.id === u.id)); // New photo
              
              if (hasRealChanges) {
                console.log('üîÑ Real updates detected, refreshing...');
                loadUploads(true);
              } else {
                console.log('‚úÖ No real updates (URLs ignored)');
              }
            }
          }
        } catch (err) {
          console.log('Background update check failed:', err);
        }
      }

      // Invalidate cache when changes are made
      function invalidateCache() {
        const cacheKey = `dashboard_uploads_${user.id}`;
        const cacheTimestampKey = `dashboard_uploads_timestamp_${user.id}`;
        localStorage.removeItem(cacheKey);
        localStorage.removeItem(cacheTimestampKey);
        console.log('üóëÔ∏è Cache invalidated');
      }

      function addEmptyFolderAccordion(folderName) {
        const gallery = document.getElementById('gallery');
        
        // Si el gallery est√° vac√≠o, limpiar el mensaje
        if (gallery.querySelector('.empty')) {
          gallery.innerHTML = '';
        }
        
        // Crear estructura del acorde√≥n
        const accordion = document.createElement('div');
        accordion.className = 'gallery-accordion';

        const header = document.createElement('div');
        header.className = 'gallery-accordion-header';
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 20px 24px; cursor: pointer;';
        
        const leftSection = document.createElement('div');
        leftSection.style.cssText = 'display: flex; align-items: center; gap: 16px;';
        leftSection.innerHTML = `<span style="font-size: 20px; font-weight: 700;">${folderName}</span>`;
        
        const rightSection = document.createElement('div');
        rightSection.style.cssText = 'display: flex; align-items: center; gap: 12px;';
        
        const photoCount = document.createElement('span');
        photoCount.style.cssText = 'font-size: 14px; color: rgba(255,255,255,0.9);';
        photoCount.textContent = '0 fotos';
        
        // Bot√≥n de eliminar carpeta
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-delete-folder';
        deleteBtn.innerHTML = 'üóëÔ∏è';
        deleteBtn.title = 'Eliminar carpeta';
        // No permitir borrar carpeta de IA
        const isAIFolder = folderName === 'Im√°genes generadas por IA';
        if (isAIFolder) {
          deleteBtn.style.cssText = 'background: #6c757d; border: none; padding: 6px 12px; border-radius: 6px; cursor: not-allowed; font-size: 16px; opacity: 0.5;';
          deleteBtn.title = 'No puedes eliminar esta carpeta';
          deleteBtn.disabled = true;
        } else {
          deleteBtn.style.cssText = 'background: #dc3545; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            showDeleteFolderModal(folderName, []);
          };
        }
        deleteBtn.onmouseenter = (e) => {
          e.target.style.background = '#c82333';
          e.target.style.boxShadow = '0 4px 10px rgba(220, 53, 69, 0.6)';
          e.target.style.transform = 'translateY(-2px)';
        };
        deleteBtn.onmouseleave = (e) => {
          e.target.style.background = '#dc3545';
          e.target.style.boxShadow = '0 2px 6px rgba(220, 53, 69, 0.4)';
          e.target.style.transform = '';
        };
        
        const accordionIcon = document.createElement('span');
        accordionIcon.className = 'accordion-icon';
        accordionIcon.textContent = '‚ñ∂';
        
        rightSection.appendChild(photoCount);
        rightSection.appendChild(deleteBtn);
        rightSection.appendChild(accordionIcon);
        
        header.appendChild(leftSection);
        header.appendChild(rightSection);

        const content = document.createElement('div');
        content.className = 'gallery-accordion-content';
        content.style.display = 'none'; // Cerrado por defecto
        
        const emptyMessage = document.createElement('p');
        emptyMessage.className = 'empty';
        emptyMessage.style.cssText = 'text-align: center; color: rgba(255,255,255,0.7); padding: 20px;';
        emptyMessage.textContent = 'Esta carpeta est√° vac√≠a';
        content.appendChild(emptyMessage);

        accordion.appendChild(header);
        accordion.appendChild(content);
        
        // Toggle accordion
        header.addEventListener('click', () => {
          const isOpen = content.style.display === 'block';
          content.style.display = isOpen ? 'none' : 'block';
          accordionIcon.textContent = isOpen ? '‚ñ∂' : '‚ñº';
        });
        
        gallery.appendChild(accordion);
      }

      function renderGallery(uploads) {
        const gallery = document.getElementById('gallery');
        
        // Mostrar contador de fotos (l√≠mite de 4) - Solo contar fotos subidas, no generadas
        const photoCountBadge = document.getElementById('photoCountBadge');
        const uploadBtn = document.getElementById('uploadBtn');
        const qrUploadBtn = document.getElementById('qrUploadBtn');
        
        if (photoCountBadge) {
          // Usar el conteo del servidor (ya filtrado)
          const count = window.currentUserPhotosCount || 0;
          const maxLimit = 4;
          photoCountBadge.textContent = `${count}/${maxLimit} fotos`;
          photoCountBadge.style.backgroundColor = count >= maxLimit ? '#dc3545' : count >= 3 ? '#ffc107' : '#28a745';
          
          // Deshabilitar botones de subir si lleg√≥ al l√≠mite
          const reachedLimit = count >= maxLimit;
          const disabledStyle = {
            disabled: reachedLimit,
            opacity: reachedLimit ? '0.5' : '1',
            cursor: reachedLimit ? 'not-allowed' : 'pointer',
            title: reachedLimit ? 'Has alcanzado el l√≠mite de 4 fotos subidas. Elimina algunas antes de subir m√°s. (Las im√°genes generadas por IA no cuentan)' : ''
          };
          
          if (uploadBtn) {
            uploadBtn.disabled = disabledStyle.disabled;
            uploadBtn.style.opacity = disabledStyle.opacity;
            uploadBtn.style.cursor = disabledStyle.cursor;
            uploadBtn.title = disabledStyle.title || 'Subir nueva foto';
          }
          
          if (qrUploadBtn) {
            qrUploadBtn.disabled = disabledStyle.disabled;
            qrUploadBtn.style.opacity = disabledStyle.opacity;
            qrUploadBtn.style.cursor = disabledStyle.cursor;
            qrUploadBtn.title = disabledStyle.title || 'Subir desde celular';
          }
        }
        
        if (uploads.length === 0) {
          gallery.innerHTML = '<p class="empty">No has subido ninguna foto a√∫n.</p>';
          return;
        }

        // group by folder
        const byFolder = {};
        uploads.forEach(u => {
          let folder = u.folder || 'Sin carpeta';
          // Renombrar carpeta de IA
          if (folder === 'AI Generated') folder = 'Im√°genes generadas por IA';
          if (!byFolder[folder]) byFolder[folder] = [];
          byFolder[folder].push(u);
        });

        gallery.innerHTML = '';
        Object.keys(byFolder).sort().forEach(folder => {
          // Create accordion structure
          const accordion = document.createElement('div');
          accordion.className = 'gallery-accordion';

          const header = document.createElement('div');
          header.className = 'gallery-accordion-header';
          header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 20px 24px; cursor: pointer;';
          
          const leftSection = document.createElement('div');
          leftSection.style.cssText = 'display: flex; align-items: center; gap: 16px;';
          leftSection.innerHTML = `<span style="font-size: 20px; font-weight: 700;">${folder}</span>`;
          
          const rightSection = document.createElement('div');
          rightSection.style.cssText = 'display: flex; align-items: center; gap: 12px;';
          
          const photoCount = document.createElement('span');
          photoCount.style.cssText = 'font-size: 14px; color: rgba(255,255,255,0.9);';
          photoCount.textContent = `${byFolder[folder].length} foto${byFolder[folder].length !== 1 ? 's' : ''}`;
          
          // Delete folder button (only if not "Sin carpeta" and not AI folder)
          if (folder !== 'Sin carpeta' && folder !== 'Im√°genes generadas por IA') {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-delete-folder';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = 'Eliminar carpeta';
            deleteBtn.style.cssText = 'background: #dc3545; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);';
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              showDeleteFolderModal(folder, byFolder[folder]);
            };
            deleteBtn.onmouseenter = (e) => {
              e.target.style.background = '#c82333';
              e.target.style.boxShadow = '0 4px 10px rgba(220, 53, 69, 0.6)';
              e.target.style.transform = 'translateY(-2px)';
            };
            deleteBtn.onmouseleave = (e) => {
              e.target.style.background = '#dc3545';
              e.target.style.boxShadow = '0 2px 6px rgba(220, 53, 69, 0.4)';
              e.target.style.transform = '';
            };
            rightSection.appendChild(deleteBtn);
          }
          
          const accordionIcon = document.createElement('span');
          accordionIcon.className = 'accordion-icon';
          accordionIcon.textContent = '‚ñº';
          
          rightSection.appendChild(photoCount);
          rightSection.appendChild(accordionIcon);
          
          header.appendChild(leftSection);
          header.appendChild(rightSection);

          const content = document.createElement('div');
          content.className = 'gallery-accordion-content';
          content.style.display = 'block'; // Open by default

          const itemsDiv = document.createElement('div');
          itemsDiv.className = 'folder-items';

          byFolder[folder].forEach(upload => {
            const card = document.createElement('div');
            card.className = 'photo-card';
            const imgSrc = upload.thumbnailUrl || upload.signedUrl;
            card.innerHTML = `
              <img 
                src="${imgSrc}" 
                data-full="${upload.signedUrl}"
                alt="${upload.custom_name || upload.filename}" 
                loading="lazy"
                class="photo-thumbnail"
                onclick="viewFullImage('${upload.signedUrl}', '${upload.custom_name || upload.filename}')"
                style="cursor: pointer;"
              />
              <div class="photo-info">
                <div class="photo-title-row">
                  <input class="photo-name" data-id="${upload.id}" value="${upload.custom_name || upload.filename}" placeholder="Nombre" disabled />
                  <button class="btn-folder-icon" data-id="${upload.id}" title="Cambiar carpeta">üìÅ</button>
                </div>
                <div class="photo-actions">
                  <button class="btn-update" data-id="${upload.id}">Cambiar nombre</button>
                  <button onclick="downloadImage('${upload.signedUrl}', '${upload.custom_name || upload.filename}')" class="btn-download" title="Descargar imagen">üì• Descargar</button>
                  <button class="btn-delete" data-id="${upload.id}">Eliminar</button>
                </div>
              </div>
            `;
            itemsDiv.appendChild(card);
          });

          content.appendChild(itemsDiv);

          // Toggle accordion
          header.addEventListener('click', () => {
            const isOpen = content.style.display === 'block';
            content.style.display = isOpen ? 'none' : 'block';
            header.querySelector('.accordion-icon').textContent = isOpen ? '‚ñ∂' : '‚ñº';
          });

          accordion.appendChild(header);
          accordion.appendChild(content);
          gallery.appendChild(accordion);
        });

        // attach event listeners
        document.querySelectorAll('.btn-folder-icon').forEach(btn => {
          btn.addEventListener('click', (e) => {
            currentPhotoId = e.target.dataset.id;
            showFolderSelector();
          });
        });

        document.querySelectorAll('.btn-update').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const id = e.target.dataset.id;
            const button = e.target;
            const nameInput = document.querySelector(`.photo-name[data-id="${id}"]`);
            
            // Si el bot√≥n dice "Cambiar nombre", habilitar edici√≥n
            if (button.textContent === 'Cambiar nombre') {
              nameInput.disabled = false;
              nameInput.focus();
              nameInput.select(); // Seleccionar todo el texto autom√°ticamente
              button.textContent = 'Guardar nombre';
              button.classList.add('editing');
            } 
            // Si el bot√≥n dice "Guardar nombre", guardar cambios
            else {
              try {
                const res = await fetch(`/api/uploads/${id}`, {
                  method: 'PATCH',
                  headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
                  body: JSON.stringify({ customName: nameInput.value })
                });
                const data = await res.json();
                if (data.ok) {
                  nameInput.disabled = true;
                  button.textContent = 'Cambiar nombre';
                  button.classList.remove('editing');
                  invalidateCache(); // Clear cache after update
                  showNotification('Nombre actualizado exitosamente', NotificationType.SUCCESS);
                  loadImages();
                } else {
                  showNotification('Error al actualizar nombre: ' + (data.error || 'Error desconocido'), NotificationType.ERROR);
                }
              } catch (err) {
                showNotification('Error al actualizar nombre: ' + err, NotificationType.ERROR);
              }
            }
          });
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const confirmed = await showConfirmDialog('¬øSeguro que quieres eliminar esta foto?', 'Eliminar', 'Cancelar');
            if (!confirmed) return;
            const id = e.target.dataset.id;
            const hideLoader = showLoader('Eliminando imagen...');
            try {
              const res = await fetch(`/api/uploads/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
              });
              const data = await res.json();
              hideLoader();
              if (data.ok) {
                showNotification('Imagen eliminada exitosamente', NotificationType.SUCCESS);
                invalidateCache();
                loadUploads(true); // refresh with force
              } else {
                showNotification('Error al eliminar imagen: ' + (data.error || 'Error desconocido'), NotificationType.ERROR);
              }
            } catch (err) {
              hideLoader();
              showNotification('Error al eliminar imagen: ' + err, NotificationType.ERROR);
            }
          });
        });
      }

      function updateFolderSelect() {
        const select = document.getElementById('uploadFolderSelect');
        select.innerHTML = '';
        
        allFolders.forEach(folder => {
          // No permitir seleccionar carpeta de IA
          if (folder === 'Im√°genes generadas por IA') return;
          
          const option = document.createElement('option');
          option.value = folder;
          option.textContent = folder;
          select.appendChild(option);
        });
      }

      function showFolderManager() {
        const existingList = document.getElementById('existingFoldersList');
        existingList.innerHTML = '';
        
        if (allFolders.length > 0) {
          const title = document.createElement('p');
          title.textContent = 'Carpetas disponibles:';
          title.style.marginBottom = '12px';
          title.style.fontWeight = '600';
          title.style.color = '#333';
          existingList.appendChild(title);

          allFolders.forEach(folder => {
            const folderItem = document.createElement('div');
            folderItem.className = 'folder-item';
            folderItem.textContent = `üìÅ ${folder}`;
            existingList.appendChild(folderItem);
          });
        }

        document.getElementById('newFolderSection').style.display = 'none';
        document.getElementById('newFolderName').value = '';
        document.getElementById('folderResult').textContent = '';
        folderModal.style.display = 'flex';
      }

      let selectedFolder = null;

      function showFolderSelector() {
        const folderList = document.getElementById('folderList');
        const confirmBtn = document.getElementById('confirmFolderChangeBtn');
        folderList.innerHTML = '';
        selectedFolder = null;
        confirmBtn.disabled = true;
        
        allFolders.forEach(folder => {
          const btn = document.createElement('button');
          btn.className = 'folder-option';
          btn.style.cssText = 'width: 100%; padding: 12px; margin: 8px 0; background: white; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 15px; transition: all 0.3s; text-align: left;';
          btn.textContent = `üìÅ ${folder}`;
          
          btn.onmouseenter = (e) => {
            if (e.target.style.border !== '2px solid var(--alico-gold)') {
              e.target.style.background = '#f8f9fa';
            }
          };
          btn.onmouseleave = (e) => {
            if (e.target.style.border !== '2px solid var(--alico-gold)') {
              e.target.style.background = 'white';
            }
          };
          
          btn.addEventListener('click', (e) => {
            // Remove selection from all buttons
            document.querySelectorAll('#folderList .folder-option').forEach(b => {
              b.style.background = 'white';
              b.style.border = '2px solid #ddd';
            });
            // Mark this button as selected
            e.target.style.background = 'var(--alico-gold-10)';
            e.target.style.border = '2px solid var(--alico-gold)';
            
            // Store selected folder and enable confirm button
            selectedFolder = folder;
            confirmBtn.disabled = false;
          });
          folderList.appendChild(btn);
        });

        selectFolderModal.style.display = 'flex';
      }

      // Confirm folder change
      document.getElementById('confirmFolderChangeBtn').addEventListener('click', async () => {
        if (!selectedFolder) return;
        
        const confirmBtn = document.getElementById('confirmFolderChangeBtn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Moviendo...';
        
        try {
          const res = await fetch(`/api/uploads/${currentPhotoId}`, {
            method: 'PATCH',
            headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
            body: JSON.stringify({ folder: selectedFolder })
          });
          const data = await res.json();
          if (data.ok) {
            selectFolderModal.style.display = 'none';
            showNotification('‚úÖ Foto movida exitosamente a "' + selectedFolder + '"');
            invalidateCache();
            loadUploads(true);
          } else {
            showNotification('‚ùå Error: ' + (data.error || 'No se pudo mover la foto'), true);
          }
        } catch (err) {
          showNotification('‚ùå Error: ' + err, true);
        } finally {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Confirmar';
        }
      });

      // Cancel folder change
      document.getElementById('cancelFolderChangeBtn').addEventListener('click', () => {
        selectFolderModal.style.display = 'none';
        selectedFolder = null;
      });

      // Show notification function
      function showNotification(message, isError = false) {
        const existingNotification = document.getElementById('folderChangeNotification');
        if (existingNotification) {
          existingNotification.remove();
        }

        const notification = document.createElement('div');
        notification.id = 'folderChangeNotification';
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${isError ? 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)' : 'linear-gradient(135deg, #28a745 0%, #20c997 100%)'};
          color: white;
          padding: 16px 24px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 10001;
          font-weight: 600;
          font-size: 14px;
          animation: slideInRight 0.3s ease-out;
        `;

        document.body.appendChild(notification);

        // Remove after 4 seconds
        setTimeout(() => {
          notification.style.animation = 'slideOutRight 0.3s ease-out';
          setTimeout(() => notification.remove(), 300);
        }, 4000);
      }

      // Add notification animations
      const notificationStyles = document.createElement('style');
      notificationStyles.textContent = `
        @keyframes slideInRight {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOutRight {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(notificationStyles);

      // Preview de archivos seleccionados
      document.getElementById('fileInputUpload').addEventListener('change', (e) => {
        const files = e.target.files;
        const preview = document.getElementById('uploadPreview');
        const fileList = document.getElementById('uploadFileList');
        
        if (files.length > 0) {
          preview.style.display = 'block';
          let html = '<ul style="margin: 0; padding-left: 20px;">';
          Array.from(files).forEach(file => {
            const size = (file.size / 1024 / 1024).toFixed(2);
            html += `<li>${file.name} (${size} MB)</li>`;
          });
          html += '</ul>';
          fileList.innerHTML = html;
        } else {
          preview.style.display = 'none';
        }
      });

      // Funci√≥n para crear thumbnail optimizado de una imagen
      async function createThumbnail(file, maxWidth = 1200, quality = 0.85) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              // Calcular nuevas dimensiones manteniendo aspect ratio
              let width = img.width;
              let height = img.height;
              
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              // Crear canvas para redimensionar
              const canvas = document.createElement('canvas');
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              
              // Dibujar imagen redimensionada
              ctx.drawImage(img, 0, 0, width, height);
              
              // Convertir a blob con compresi√≥n
              canvas.toBlob(
                (blob) => {
                  if (blob) {
                    // Crear nuevo File con el blob comprimido
                    const compressedFile = new File([blob], file.name, {
                      type: 'image/jpeg',
                      lastModified: Date.now()
                    });
                    
                    const originalSize = (file.size / 1024 / 1024).toFixed(2);
                    const compressedSize = (blob.size / 1024 / 1024).toFixed(2);
                    console.log(`Imagen optimizada: ${file.name}`);
                    console.log(`  Original: ${originalSize} MB`);
                    console.log(`  Comprimida: ${compressedSize} MB`);
                    console.log(`  Reducci√≥n: ${((1 - blob.size / file.size) * 100).toFixed(1)}%`);
                    
                    resolve(compressedFile);
                  } else {
                    reject(new Error('Error al comprimir imagen'));
                  }
                },
                'image/jpeg',
                quality
              );
            };
            img.onerror = () => reject(new Error('Error al cargar imagen'));
            img.src = e.target.result;
          };
          reader.onerror = () => reject(new Error('Error al leer archivo'));
          reader.readAsDataURL(file);
        });
      }

      document.getElementById('uploadForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = document.getElementById('fileInputUpload');
        const files = fileInput.files;
        const resEl = document.getElementById('uploadResult');
        const submitBtn = document.getElementById('uploadSubmitBtn');
        const folderSelect = document.getElementById('uploadFolderSelect');
        
        if (files.length === 0) {
          resEl.textContent = 'Por favor selecciona al menos un archivo';
          resEl.style.color = '#dc3545';
          return;
        }
        
        // Validar todos los archivos
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        const maxSize = 5 * 1024 * 1024; // 5MB
        
        for (let file of files) {
          if (!allowedTypes.includes(file.type)) {
            resEl.textContent = `‚ùå ${file.name}: Solo se permiten JPG, JPEG o PNG`;
            resEl.style.color = '#dc3545';
            return;
          }
          if (file.size > maxSize) {
            resEl.textContent = `‚ùå ${file.name}: M√°ximo 5 MB`;
            resEl.style.color = '#dc3545';
            return;
          }
        }
        
        // Subir archivos uno por uno
        submitBtn.disabled = true;
        let successCount = 0;
        let errorCount = 0;
        const folder = folderSelect.value === 'Sin carpeta' ? null : folderSelect.value;
        
        resEl.textContent = `Subiendo ${files.length} archivo${files.length > 1 ? 's' : ''}...`;
        resEl.style.color = '#17a2b8'; // Azul informativo
        
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
          // Comprimir imagen antes de subir
          resEl.textContent = `Optimizando ${i + 1}/${files.length}: ${file.name}...`;
          resEl.style.color = '#17a2b8'; // Azul informativo
          let fileToUpload = file;
          
          try {
            // Solo comprimir im√°genes
            if (file.type.startsWith('image/')) {
              fileToUpload = await createThumbnail(file);
            }
          } catch (err) {
            console.warn('No se pudo comprimir la imagen, subiendo original:', err);
            // Si falla la compresi√≥n, subir original
            fileToUpload = file;
          }
          
          const fd = new FormData();
          fd.append('file', fileToUpload);
          if (folder) fd.append('folder', folder);
          
          resEl.textContent = `Subiendo ${i + 1}/${files.length}: ${file.name}...`;
          resEl.style.color = '#17a2b8'; // Azul informativo
          
          try {
            const res = await fetch('/api/upload', {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token },
              body: fd
            });
            const data = await res.json();
            if (data.ok) {
              successCount++;
            } else {
              errorCount++;
              console.error(`Error subiendo ${file.name}:`, data.error);
              
              // Si alcanz√≥ el l√≠mite de fotos, mostrar mensaje espec√≠fico y detener
              if (res.status === 400 && data.error === 'L√≠mite de fotos alcanzado') {
                resEl.textContent = `‚ùå ${data.message}`;
                resEl.style.color = '#dc3545';
                submitBtn.disabled = false;
                return; // Detener el bucle de subida
              }
            }
          } catch (err) {
            errorCount++;
            console.error(`Error subiendo ${file.name}:`, err);
          }
        }
        
        submitBtn.disabled = false;
        
        if (errorCount === 0) {
          resEl.textContent = `‚úÖ ${successCount} archivo${successCount > 1 ? 's subidos' : ' subido'} correctamente!`;
          resEl.style.color = '#28a745';
          showNotification(`${successCount} imagen${successCount > 1 ? 'es optimizadas y subidas' : ' optimizada y subida'} exitosamente`, NotificationType.SUCCESS);
          e.target.reset();
          document.getElementById('uploadPreview').style.display = 'none';
          invalidateCache();
          setTimeout(() => {
            uploadModal.style.display = 'none';
            loadUploads(true);
          }, 1500);
        } else {
          resEl.textContent = `‚ö†Ô∏è ${successCount} exitosos, ${errorCount} con errores`;
          resEl.style.color = '#ffc107';
          if (successCount > 0) {
            showNotification(`${successCount} imagen${successCount > 1 ? 'es subidas' : ' subida'} correctamente, ${errorCount} con errores`, NotificationType.WARNING);
          }
          invalidateCache();
          setTimeout(() => {
            loadUploads(true);
          }, 1000);
        }
      });

      loadUploads();

      // Auto-refresh: Check for new uploads every 10 seconds
      let autoRefreshInterval = null;
      let lastUploadCount = 0;

      async function checkForNewUploads() {
        try {
          const response = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          if (response.ok) {
            const data = await response.json();
            const currentCount = data.uploads?.length || 0;
            
            // Si hay cambios en el n√∫mero de fotos, recargar
            if (currentCount !== lastUploadCount && lastUploadCount !== 0) {
              console.log('üì∏ Nuevas fotos detectadas, actualizando...');
              invalidateCache();
              await loadUploads(true);
            }
            
            lastUploadCount = currentCount;
          }
        } catch (err) {
          console.error('Error checking for updates:', err);
        }
      }

      // Iniciar auto-refresh cuando la p√°gina est√° visible
      function startAutoRefresh() {
        if (!autoRefreshInterval) {
          autoRefreshInterval = setInterval(checkForNewUploads, 10000); // cada 10 segundos
          console.log('üîÑ Auto-refresh activado');
        }
      }

      // Detener auto-refresh cuando la p√°gina no est√° visible
      function stopAutoRefresh() {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('‚è∏Ô∏è Auto-refresh pausado');
        }
      }

      // Detectar cuando la pesta√±a est√° visible/oculta
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopAutoRefresh();
        } else {
          checkForNewUploads(); // Verificar inmediatamente al volver
          startAutoRefresh();
        }
      });

      // Iniciar auto-refresh
      startAutoRefresh();

      // Limpiar al cerrar la p√°gina
      window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
      });

      // Descargar imagen sin redirigir
      async function downloadImage(imageUrl, fileName) {
        try {
          const response = await fetch(imageUrl);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = fileName;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } catch (error) {
          console.error('Error al descargar imagen:', error);
          showNotification('Error al descargar la imagen. Por favor, intenta nuevamente.', NotificationType.ERROR);
        }
      }

      // Ver imagen en tama√±o completo con modal
      function viewFullImage(imageUrl, imageName) {
        const modal = document.createElement('div');
        modal.className = 'image-preview-modal';
        modal.innerHTML = `
          <div class="image-preview-content">
            <div class="image-preview-header">
              <h3>üì∑ ${imageName}</h3>
              <button class="close-preview" onclick="this.closest('.image-preview-modal').remove()">‚úï</button>
            </div>
            <div class="image-preview-body">
              <img src="${imageUrl}" alt="${imageName}" class="image-preview-img" />
            </div>
            <div class="image-preview-footer">
              <button onclick="downloadImage('${imageUrl}', '${imageName}')" class="btn-download-preview">
                üì• Descargar imagen
              </button>
              <button class="btn-close-preview" onclick="this.closest('.image-preview-modal').remove()">
                Cerrar
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // Cerrar al hacer click fuera del contenido
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.remove();
          }
        });
      }

      // Sistema de polling para detectar im√°genes generadas
      let hideOverlay = null;
      let pollingInterval = null;
      let pollingStartTime = null;

      async function checkForNewImage() {
        try {
          const token = localStorage.getItem('token');
          if (!token) return;

          const response = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });

          if (!response.ok) return;

          const data = await response.json();
          
          // Buscar im√°genes AI generadas recientemente (√∫ltimos 90 segundos)
          const now = new Date();
          const recentAIImages = data.uploads?.filter(upload => {
            if (upload.folder !== 'AI Generated') return false;
            
            const createdAt = new Date(upload.created_at);
            const ageInSeconds = (now - createdAt) / 1000;
            
            // Imagen creada despu√©s de iniciar el polling (con 10s de margen por si acaso)
            const createdAfterPolling = pollingStartTime ? createdAt >= new Date(pollingStartTime - 10000) : false;
            
            console.log(`üîç Imagen AI: ${upload.filename}, edad: ${ageInSeconds.toFixed(1)}s, creada despu√©s polling: ${createdAfterPolling}`);
            
            return createdAfterPolling;
          }) || [];

          // Si detectamos una imagen AI nueva
          if (recentAIImages.length > 0) {
            console.log('‚úÖ Nueva imagen AI detectada!', recentAIImages[0]);
            
            // Detener polling
            if (pollingInterval) {
              clearInterval(pollingInterval);
              pollingInterval = null;
            }

            // Ocultar overlay
            if (hideOverlay) {
              hideOverlay();
              hideOverlay = null;
            }

            // Actualizar galer√≠a
            loadAllPhotos();

            // Mostrar notificaci√≥n de √©xito
            showNotification('üéâ ¬°Tu dise√±o est√° listo! Ya puedes verlo en tu galer√≠a.', NotificationType.SUCCESS, 6000);

            // Limpiar par√°metro de URL
            const url = new URL(window.location);
            url.searchParams.delete('waiting');
            window.history.replaceState({}, '', url);
          }
        } catch (error) {
          console.error('Error checking for new image:', error);
        }
      }

      function startImagePolling() {
        console.log('üîÑ Iniciando polling de im√°genes...');
        
        // Polling cada 3 segundos
        pollingInterval = setInterval(checkForNewImage, 3000);

        // Timeout despu√©s de 60 segundos
        setTimeout(() => {
          if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;

            if (hideOverlay) {
              hideOverlay();
              hideOverlay = null;
            }

            showNotification(
              'La generaci√≥n est√° tomando m√°s tiempo del esperado. Por favor, recarga la p√°gina en unos momentos.',
              NotificationType.WARNING,
              8000
            );

            // Limpiar par√°metro de URL
            const url = new URL(window.location);
            url.searchParams.delete('waiting');
            window.history.replaceState({}, '', url);
          }
        }, 60000); // 60 segundos
      }

      // Detectar par√°metro ?waiting=true al cargar la p√°gina
      (async function initDashboard() {
        const urlParams = new URLSearchParams(window.location.search);
        
        if (urlParams.get('waiting') === 'true') {
          console.log('üé® Iniciando modo de espera de generaci√≥n...');
          
          // Guardar timestamp de inicio del polling
          pollingStartTime = Date.now();
          console.log('‚è∞ Polling start time:', new Date(pollingStartTime).toISOString());

          // Mostrar overlay de generaci√≥n
          hideOverlay = showGeneratingOverlay();

          // Iniciar polling
          startImagePolling();
        }

        // Detectar primera visita y mostrar tutorial
        if (!localStorage.getItem('tutorialCompleted')) {
          console.log('üëã Primera visita detectada, iniciando tutorial...');
          // Esperar 1 segundo para que el dashboard cargue completamente
          setTimeout(() => {
            startTutorial();
          }, 1000);
        }
      })();
    </script>
  </body>
</html>

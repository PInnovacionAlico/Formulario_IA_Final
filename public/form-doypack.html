<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulario Doypack - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üì¶ Formulario Doypack</h1>
        <div class="user-info">
          <span id="userName"></span>
          <button id="adminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
          <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">Dashboard</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>
      </header>

      <div class="dashboard-content">
        <div class="gallery-section">
          <div class="form-page-header">
            <h2>üì¶ Formulario Doypack</h2>
            <p class="form-page-description">Empaque flexible vertical con cierre resellable - Ideal para l√≠quidos y semil√≠quidos</p>
          </div>

          <!-- Breadcrumb -->
          <div class="breadcrumb-container">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a href="/dashboard.html">üè† Dashboard</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item">
                  <a href="/forms.html">üìã Formularios</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item active" aria-current="page">
                  üì¶ Doypack
                </li>
              </ol>
            </nav>
          </div>
          
          <form id="mainForm">
            <!-- Secci√≥n 1: Seleccionar foto -->
            <div class="form-section">
              <h3>üì∑ 1. Selecciona una foto</h3>
              
              <div class="form-section-content">
                <div class="photo-selector-layout">
                <!-- Men√∫ lateral de carpetas -->
                <div class="folder-menu">
                  <div class="folder-menu-header">
                    <h4>üìÅ Filtrar por carpeta</h4>
                  </div>
                  <div id="folderFilters" class="folder-filters">
                    <p style="color: #999; font-size: 14px; padding: 12px;">Cargando carpetas...</p>
                  </div>
                </div>

                <!-- Contenedor principal -->
                <div class="photo-selector-container">
                  <!-- Dropdown selector personalizado -->
                  <label>Foto</label>
                  <div class="custom-select-wrapper">
                    <div class="custom-select-trigger" id="photoSelectTrigger">
                      <span class="custom-select-text">Cargando fotos...</span>
                      <span class="custom-select-arrow">‚ñº</span>
                    </div>
                    <div class="custom-select-dropdown" id="photoSelectDropdown">
                      <div class="custom-select-search">
                        <input type="text" id="photoSearchInput" placeholder="üîç Buscar foto...">
                      </div>
                      <div class="custom-select-options" id="photoSelectOptions">
                        <!-- Las opciones se cargar√°n din√°micamente -->
                      </div>
                    </div>
                  </div>
                  <input type="hidden" id="photoSelect" name="photo_id" required>
                  
                  <!-- Preview de la foto seleccionada -->
                  <div id="photoPreview" class="photo-preview-container" style="display: none;">
                    <div class="preview-header">
                      <span class="preview-title">üñºÔ∏è Vista previa</span>
                      <span class="preview-hint">(Click para ampliar)</span>
                    </div>
                    <div class="preview-image-wrapper">
                      <img 
                        id="previewImage" 
                        src="" 
                        alt="Vista previa" 
                        class="preview-image"
                      />
                    </div>
                    <p id="previewInfo" class="preview-info"></p>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- M√°s secciones se agregar√°n aqu√≠ -->

            <div class="form-actions">
              <button type="submit" class="btn-submit">Enviar formulario</button>
              <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal for full image view -->
    <div id="formImageViewModal" class="modal">
      <div class="modal-content modal-image">
        <span class="modal-close">&times;</span>
        <h2 id="formImageViewTitle">Imagen completa</h2>
        <img id="formFullImageView" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;" />
      </div>
    </div>

    <script>
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('userInfo') || '{}');
      let allPhotos = [];
      let allFolders = [];
      let selectedFolders = new Set();
      
      if (!token) {
        window.location.href = '/login.html';
      }

      document.getElementById('userName').textContent = user.name || user.email || 'Usuario';

      // Check if user is admin and show admin button
      if (user.is_admin) {
        document.getElementById('adminDashboardBtn').style.display = 'inline-block';
      }

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Inicializar dropdown personalizado
      initCustomSelect();

      // Cargar fotos del usuario
      async function loadPhotos() {
        try {
          const res = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok && data.uploads) {
            allPhotos = data.uploads;
            
            // Extract folders
            const folders = new Set();
            data.uploads.forEach(photo => {
              folders.add(photo.folder || 'Sin carpeta');
            });
            allFolders = Array.from(folders).sort();
            
            // Initialize all folders as selected
            allFolders.forEach(folder => selectedFolders.add(folder));
            
            populateFolderFilters();
            populatePhotoSelect(data.uploads);
          } else {
            document.getElementById('photoSelect').innerHTML = '<option value="">Error al cargar fotos</option>';
          }
        } catch (err) {
          console.error('Error loading photos:', err);
          document.getElementById('photoSelect').innerHTML = '<option value="">Error al cargar fotos</option>';
        }
      }

      function populateFolderFilters() {
        const container = document.getElementById('folderFilters');
        container.innerHTML = '';

        allFolders.forEach(folder => {
          const label = document.createElement('label');
          label.className = 'folder-checkbox-label';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.value = folder;
          checkbox.checked = selectedFolders.has(folder);
          checkbox.addEventListener('change', handleFolderFilter);
          
          const icon = document.createElement('span');
          icon.textContent = 'üìÅ ';
          
          const text = document.createElement('span');
          text.textContent = folder;
          
          label.appendChild(checkbox);
          label.appendChild(icon);
          label.appendChild(text);
          
          container.appendChild(label);
        });
      }

      function handleFolderFilter(e) {
        const folder = e.target.value;
        
        if (e.target.checked) {
          selectedFolders.add(folder);
        } else {
          selectedFolders.delete(folder);
        }
        
        // Filter photos and repopulate select
        const filteredPhotos = allPhotos.filter(photo => 
          selectedFolders.has(photo.folder || 'Sin carpeta')
        );
        
        populatePhotoSelect(filteredPhotos);
      }

      function populatePhotoSelect(photos) {
        const trigger = document.getElementById('photoSelectTrigger');
        const triggerText = trigger.querySelector('.custom-select-text');
        const optionsContainer = document.getElementById('photoSelectOptions');
        const hiddenInput = document.getElementById('photoSelect');
        
        if (photos.length === 0) {
          triggerText.textContent = 'No hay fotos en las carpetas seleccionadas';
          triggerText.classList.add('placeholder');
          optionsContainer.innerHTML = '<div class="custom-select-no-results">No hay fotos disponibles</div>';
          document.getElementById('photoPreview').style.display = 'none';
          return;
        }

        // Agrupar por carpeta
        const byFolder = {};
        photos.forEach(photo => {
          const folder = photo.folder || 'Sin carpeta';
          if (!byFolder[folder]) byFolder[folder] = [];
          byFolder[folder].push(photo);
        });

        // Crear opciones agrupadas
        optionsContainer.innerHTML = '';
        Object.keys(byFolder).sort().forEach(folder => {
          if (!selectedFolders.has(folder)) return;
          
          // Etiqueta de grupo
          const groupLabel = document.createElement('div');
          groupLabel.className = 'custom-select-group-label';
          groupLabel.textContent = `üìÅ ${folder}`;
          optionsContainer.appendChild(groupLabel);
          
          // Opciones del grupo
          byFolder[folder].forEach(photo => {
            const option = document.createElement('div');
            option.className = 'custom-select-option';
            option.dataset.value = photo.id;
            option.dataset.name = photo.custom_name || photo.filename;
            option.dataset.url = photo.thumbnailUrl || photo.signedUrl;
            option.dataset.fullUrl = photo.signedUrl;
            option.dataset.filename = photo.filename;
            option.dataset.folder = photo.folder;
            
            option.innerHTML = `
              <img src="${photo.thumbnailUrl || photo.signedUrl}" 
                   alt="${photo.custom_name || photo.filename}" 
                   class="custom-select-option-thumbnail"
                   loading="lazy">
              <div class="custom-select-option-info">
                <div class="custom-select-option-name">${photo.custom_name || photo.filename}</div>
                <div class="custom-select-option-folder">üìÅ ${photo.folder || 'Sin carpeta'}</div>
              </div>
            `;
            
            option.addEventListener('click', () => selectPhoto(photo, option));
            optionsContainer.appendChild(option);
          });
        });

        // Resetear texto del trigger
        triggerText.textContent = '-- Selecciona una foto --';
        triggerText.classList.add('placeholder');
      }

      function selectPhoto(photo, optionElement) {
        const trigger = document.getElementById('photoSelectTrigger');
        const triggerText = trigger.querySelector('.custom-select-text');
        const dropdown = document.getElementById('photoSelectDropdown');
        const hiddenInput = document.getElementById('photoSelect');
        
        // Actualizar valor
        hiddenInput.value = photo.id;
        
        // Actualizar texto del trigger
        triggerText.textContent = photo.custom_name || photo.filename;
        triggerText.classList.remove('placeholder');
        
        // Actualizar selecci√≥n visual
        document.querySelectorAll('.custom-select-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        optionElement.classList.add('selected');
        
        // Cerrar dropdown
        trigger.classList.remove('active');
        dropdown.classList.remove('active');
        
        // Mostrar preview
        showPhotoPreview(photo);
      }

      function showPhotoPreview(photo) {
        const previewContainer = document.getElementById('photoPreview');
        const previewImage = document.getElementById('previewImage');
        const previewInfo = document.getElementById('previewInfo');
        
        previewImage.src = photo.signedUrl;
        previewImage.onclick = () => viewFormFullImage(photo.signedUrl, photo.custom_name || photo.filename);
        previewInfo.textContent = `üìÅ ${photo.folder || 'Sin carpeta'}`;
        previewContainer.style.display = 'block';
        
        currentFullImageUrl = photo.signedUrl;
      }

      // Inicializar dropdown personalizado
      function initCustomSelect() {
        const trigger = document.getElementById('photoSelectTrigger');
        const dropdown = document.getElementById('photoSelectDropdown');
        const searchInput = document.getElementById('photoSearchInput');
        
        // Toggle dropdown
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          trigger.classList.toggle('active');
          dropdown.classList.toggle('active');
          if (dropdown.classList.contains('active')) {
            searchInput.focus();
          }
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
          if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
            trigger.classList.remove('active');
            dropdown.classList.remove('active');
          }
        });
        
        // B√∫squeda
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const options = document.querySelectorAll('.custom-select-option');
          const groupLabels = document.querySelectorAll('.custom-select-group-label');
          
          let hasVisibleOptions = false;
          let currentGroupHasVisible = false;
          let currentGroupLabel = null;
          
          document.querySelectorAll('.custom-select-group-label, .custom-select-option').forEach(el => {
            if (el.classList.contains('custom-select-group-label')) {
              // Mostrar/ocultar grupo anterior
              if (currentGroupLabel) {
                currentGroupLabel.style.display = currentGroupHasVisible ? 'block' : 'none';
              }
              currentGroupLabel = el;
              currentGroupHasVisible = false;
            } else {
              const name = el.dataset.name.toLowerCase();
              const folder = (el.dataset.folder || 'Sin carpeta').toLowerCase();
              const matches = name.includes(searchTerm) || folder.includes(searchTerm);
              
              el.style.display = matches ? 'flex' : 'none';
              if (matches) {
                hasVisibleOptions = true;
                currentGroupHasVisible = true;
              }
            }
          });
          
          // √öltimo grupo
          if (currentGroupLabel) {
            currentGroupLabel.style.display = currentGroupHasVisible ? 'block' : 'none';
          }
          
          // Mostrar mensaje si no hay resultados
          const noResults = document.querySelector('.custom-select-no-results');
          if (!hasVisibleOptions && !noResults) {
            const msg = document.createElement('div');
            msg.className = 'custom-select-no-results';
            msg.textContent = 'üîç No se encontraron resultados';
            document.getElementById('photoSelectOptions').appendChild(msg);
          } else if (hasVisibleOptions && noResults) {
            noResults.remove();
          }
        });
      }

      // Modal for full image view
      const formImageViewModal = document.getElementById('formImageViewModal');
      let currentFullImageUrl = '';

      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      function viewFormFullImage(url, title) {
        document.getElementById('formFullImageView').src = url;
        document.getElementById('formImageViewTitle').textContent = title;
        formImageViewModal.style.display = 'flex';
      }

      // Enviar formulario
      document.getElementById('mainForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const photoId = document.getElementById('photoSelect').value;
        
        if (!photoId) {
          alert('Por favor selecciona una foto');
          return;
        }

        const submitButton = e.target.querySelector('.btn-submit');
        const originalButtonText = submitButton.textContent;
        
        try {
          // Disable button and show loading state with detailed message
          submitButton.disabled = true;
          submitButton.innerHTML = '‚è≥ Generando imagen... (puede tardar hasta 60 segundos)';
          submitButton.style.opacity = '0.6';
          
          // Actualizar cada 10 segundos para dar feedback al usuario
          let secondsElapsed = 0;
          const progressInterval = setInterval(() => {
            secondsElapsed += 10;
            submitButton.innerHTML = `‚è≥ Generando imagen... (${secondsElapsed}s transcurridos)`;
          }, 10000);
          
          const formData = {
            photo_id: photoId,
            form_type: 'doypack'
          };

          // Fetch con timeout de 70 segundos
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 70000);

          const response = await fetch('/api/submit-form', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(formData),
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          clearInterval(progressInterval);

          const result = await response.json();

          if (response.ok && result.ok) {
            console.log('Formulario enviado exitosamente:', result);
            
            let message = '‚úÖ ¬°Formulario enviado correctamente!\n\n';
            
            if (result.webhook_sent) {
              message += 'üéØ Webhook enviado a Alico exitosamente';
            } else {
              message += '‚ö†Ô∏è Advertencia: El webhook no pudo ser enviado\n';
              message += `Error: ${result.webhook_error || 'Desconocido'}`;
            }
            
            alert(message);
            
            // Redirect to dashboard after success
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
          } else if (!result.ok && result.credit_refunded) {
            // La generaci√≥n fall√≥ pero el cr√©dito fue reembolsado
            console.log('‚ö†Ô∏è Generaci√≥n fall√≥, cr√©dito reembolsado');
            
            // Actualizar cr√©ditos
            if (typeof loadCredits === 'function') loadCredits();
            
            let message = '‚ö†Ô∏è La generaci√≥n de la imagen fall√≥\n\n';
            message += '‚úÖ Tu cr√©dito ha sido reembolsado autom√°ticamente\n';
            message += `üí≥ Cr√©ditos actuales: ${result.new_credits || 'N/A'}\n\n`;
            message += 'Por favor intenta nuevamente en unos momentos.';
            
            alert(message);
            
            // Redirigir al inicio del formulario (recargar p√°gina)
            window.location.reload();
          } else {
            throw new Error(result.error || result.message || 'Error al enviar formulario');
          }
        } catch (error) {
          console.error('Error al enviar formulario:', error);
          
          // Limpiar interval si existe
          if (typeof progressInterval !== 'undefined') {
            clearInterval(progressInterval);
          }
          
          let errorMessage = '‚ùå Error al enviar el formulario:\n';
          
          if (error.name === 'AbortError') {
            errorMessage += 'La solicitud tard√≥ demasiado tiempo (m√°s de 70 segundos).\n';
            errorMessage += 'El servidor de IA puede estar sobrecargado. Por favor intenta nuevamente.';
          } else {
            errorMessage += error.message;
          }
          
          alert(errorMessage);
          
          // Re-enable button
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
          submitButton.style.opacity = '1';
        }
      });

      // Cargar fotos al iniciar
      loadPhotos();
    </script>
  </body>
</html>

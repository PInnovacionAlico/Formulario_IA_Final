<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Formulario Doypack - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <script src="/shared-components.js"></script>
  </head>
  <body>
    <div class="dashboard-container">
      <header class="dashboard-header">
        <h1>üî≤ Formulario Doypack</h1>
        
        <!-- Desktop menu -->
        <div class="user-info">
          <span id="userName"></span>
          <div id="creditsDisplay" style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 16px; background: linear-gradient(135deg, var(--alico-gold-20) 0%, var(--alico-gold-30) 100%); border-radius: 8px; margin-right: 12px; border: 2px solid var(--alico-gold);">
            <span style="font-size: 20px;">üí≥</span>
            <span style="font-weight: 700; color: var(--alico-gold); font-size: 18px;" id="creditsCount">...</span>
            <span style="font-size: 13px; color: var(--alico-gold-80);">cr√©ditos</span>
          </div>
          <button id="adminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
          <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">Dashboard</button>
          <button id="logoutBtn" class="btn-secondary">Cerrar sesi√≥n</button>
        </div>

        <!-- Mobile hamburger button -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle">
          ‚ò∞
        </button>
      </header>

      <!-- Mobile menu overlay and sidebar -->
      <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
      <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
          <h2>Men√∫</h2>
          <button class="mobile-menu-close" id="mobileMenuClose">√ó</button>
        </div>
        <div class="mobile-menu-content">
          <div class="mobile-menu-user">
            <span id="mobileUserName"></span>
            <div class="mobile-menu-credits">
              <span class="mobile-menu-credits-icon">üí≥</span>
              <span class="mobile-menu-credits-count" id="mobileCreditsCount">...</span>
              <span class="mobile-menu-credits-label">cr√©ditos</span>
            </div>
          </div>
          <div class="mobile-menu-buttons">
            <button id="mobileAdminDashboardBtn" onclick="location.href='/admin-dashboard.html'" class="btn-secondary" style="display: none; background: linear-gradient(135deg, var(--alico-gold) 0%, #d4a017 100%); color: white;">üõ°Ô∏è Panel Admin</button>
            <button type="button" onclick="location.href='/dashboard.html'" class="btn-secondary">üè† Dashboard</button>
            <button type="button" onclick="location.href='/forms.html'" class="btn-secondary active-page">üìã Formularios</button>
            <button type="button" onclick="location.href='/history.html'" class="btn-secondary">üìä Historial</button>
            <button type="button" onclick="location.href='/settings.html'" class="btn-secondary">‚öôÔ∏è Configuraci√≥n</button>
            <button id="mobileLogoutBtn" class="btn-secondary">üö™ Cerrar sesi√≥n</button>
          </div>
        </div>
      </div>

      <div class="dashboard-content">
        <div class="gallery-section">
          <!-- Breadcrumb -->
          <div class="breadcrumb-container">
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb">
                <li class="breadcrumb-item">
                  <a href="/dashboard.html">üè† Dashboard</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item">
                  <a href="/forms.html">üìã Formularios</a>
                </li>
                <li class="breadcrumb-separator">‚Ä∫</li>
                <li class="breadcrumb-item active" aria-current="page">
                  üî≤ Doypack
                </li>
              </ol>
            </nav>
          </div>
        
          <!-- Progress indicator -->
          <div class="wizard-progress">
            <div class="wizard-step active" data-step="1">
              <div class="step-circle">1</div>
              <div class="step-label">Mercado</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="2">
              <div class="step-circle">2</div>
              <div class="step-label">Descripci√≥n</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="3">
              <div class="step-circle">3</div>
              <div class="step-label">Colores</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="4">
              <div class="step-circle">4</div>
              <div class="step-label">Estilo</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="5">
              <div class="step-circle">5</div>
              <div class="step-label">Acabado</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="6">
              <div class="step-circle">6</div>
              <div class="step-label">Aditamentos</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="7">
              <div class="step-circle">7</div>
              <div class="step-label">Selecci√≥n</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="8">
              <div class="step-circle">8</div>
              <div class="step-label">Foto</div>
            </div>
            <div class="wizard-line"></div>
            <div class="wizard-step" data-step="9">
              <div class="step-circle">9</div>
              <div class="step-label">Confirmar</div>
            </div>
          </div>
          <form id="mainForm">
            <!-- Step 1: Mercado del producto -->
            <div class="form-step active" data-step="1">
              <div class="form-section">
                <h3>üè™ Paso 1: ¬øA qu√© mercado pertenece tu producto?</h3>
                
                <div class="form-section-content">
                  <div class="radio-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="C√°rnicos" required>
                      <span class="radio-label">ü•© C√°rnicos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Caf√© y chocolate" required>
                      <span class="radio-label">‚òï Caf√© y chocolate</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Snacks, cereales y polvos" required>
                      <span class="radio-label">üçø Snacks, cereales y polvos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Cosm√©ticos" required>
                      <span class="radio-label">üíÑ Cosm√©ticos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Farmac√©utico" required>
                      <span class="radio-label">üíä Farmac√©utico</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Cuidado del hogar" required>
                      <span class="radio-label">üßπ Cuidado del hogar</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Industrial y agroindustrial" required>
                      <span class="radio-label">üè≠ Industrial y agroindustrial</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="L√°cteos" required>
                      <span class="radio-label">ü•õ L√°cteos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Mascotas" required>
                      <span class="radio-label">üêæ Mascotas</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Panader√≠a y reposter√≠a" required>
                      <span class="radio-label">üç∞ Panader√≠a y reposter√≠a</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Salsas y aderezos" required>
                      <span class="radio-label">üçÖ Salsas y aderezos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Alimentos preparados" required>
                      <span class="radio-label">üç± Alimentos preparados</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="marketSector" value="Fruver" required>
                      <span class="radio-label">ü•ó Fruver (frutas y verduras)</span>
                    </label>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 1 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step1Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 2: Descripci√≥n del producto -->
            <div class="form-step" data-step="2">
              <div class="form-section">
                <h3>üìù Paso 2: ¬øQu√© producto vas a empacar?</h3>
                
                <div class="form-section-content">
                  <div style="margin-top: 20px;">
                    <label for="productDescription" style="display: block; margin-bottom: 8px; font-weight: 600;">Descripci√≥n del producto</label>
                    <textarea 
                      id="productDescription" 
                      name="productDescription" 
                      rows="4" 
                      maxlength="120"
                      placeholder="Describe brevemente tu producto (m√°ximo 120 caracteres)"
                      required
                      style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px; font-family: inherit; resize: vertical;"
                    ></textarea>
                    <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px;">
                      <span id="charCountWarning" style="color: #dc3545; display: none;">‚ö†Ô∏è Has alcanzado el l√≠mite de caracteres</span>
                      <span id="charCount" style="color: #666;">0 / 120 caracteres</span>
                    </div>
                  </div>
                </div>
                

                <!-- Navigation buttons for Step 2 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step2Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step2Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
                <script>
                // Contador de caracteres para descripci√≥n del producto
                const productDescTextarea = document.getElementById('productDescription');
                const charCountEl = document.getElementById('charCount');
                const charCountWarning = document.getElementById('charCountWarning');
                productDescTextarea.addEventListener('input', function() {
                  const length = this.value.length;
                  charCountEl.textContent = `${length} / 120 caracteres`;
                  if (length >= 120) {
                    charCountWarning.style.display = 'inline';
                    charCountEl.style.color = '#dc3545';
                    charCountEl.style.fontWeight = '700';
                  } else {
                    charCountWarning.style.display = 'none';
                    charCountEl.style.color = '#666';
                    charCountEl.style.fontWeight = '400';
                  }
                });

                // Navegaci√≥n del paso 2 (Anterior)
                const step2PrevBtn = document.getElementById('step2Prev');
                if (step2PrevBtn) {
                  step2PrevBtn.addEventListener('click', () => {
                    currentStep = 1;
                    showStep(currentStep);
                  });
                }
                </script>
              </div>
            </div>

            <!-- Step 3: Colores predominantes -->
            <div class="form-step" data-step="3">
              <div class="form-section">
                <h3>üé® Paso 3: ¬øCu√°les son los colores que predominan en tu marca? (M√°ximo 3)</h3>
                
                <div class="form-section-content">
                  <div id="colorError" style="display: none; padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 6px; margin-bottom: 16px; color: #721c24; font-weight: 600;">
                    ‚ö†Ô∏è Por favor selecciona entre 1 y 3 colores
                  </div>
                  
                  <div class="checkbox-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Tonos tierra (marrones, beiges)" class="color-checkbox">
                      <span class="checkbox-label">üü§ Tonos tierra (marrones, beiges)</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Verdes" class="color-checkbox">
                      <span class="checkbox-label">üü¢ Verdes</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Dorados/Amarillos" class="color-checkbox">
                      <span class="checkbox-label">üü° Dorados/Amarillos</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Negro/Grises oscuros" class="color-checkbox">
                      <span class="checkbox-label">‚ö´ Negro/Grises oscuros</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Blanco/Grises claros" class="color-checkbox">
                      <span class="checkbox-label">‚ö™ Blanco/Grises claros</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Rojos" class="color-checkbox">
                      <span class="checkbox-label">üî¥ Rojos</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Azules" class="color-checkbox">
                      <span class="checkbox-label">üîµ Azules</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Naranjas" class="color-checkbox">
                      <span class="checkbox-label">üü† Naranjas</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="brandColors" value="Otro" class="color-checkbox" id="otroColorCheckbox">
                      <span class="checkbox-label">üé® Otro</span>
                    </label>
                  </div>
                  
                  <!-- Campo de texto para "Otro" -->
                  <div id="otroColorField" style="display: none; margin-top: 20px;">
                    <label for="otroColorText" style="display: block; margin-bottom: 8px; font-weight: 600;">Especifica el color:</label>
                    <input 
                      type="text" 
                      id="otroColorText" 
                      name="otroColorText" 
                      maxlength="50"
                      placeholder="Ejemplo: Rosa pastel, Morado, etc."
                      style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;"
                    />
                    <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #666;">
                      <span id="otroColorCharCount">0 / 50 caracteres</span>
                    </div>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 3 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step3Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step3Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <style>
            /* Estilos para los checkboxes */
            .checkbox-options-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
              gap: 12px;
              margin-top: 20px;
            }

            /* --- MOBILE: Mercado radio options horizontal scroll --- */
            /* Opciones radio y checkbox: input y texto alineados horizontalmente SIEMPRE */
            .radio-option,
            .checkbox-option {
              display: flex !important;
              flex-direction: row;
              align-items: center;
              justify-content: flex-start;
              min-width: 0;
              max-width: 100%;
              padding: 10px 8px;
              font-size: 15px;
            }
            .radio-label,
            .checkbox-label {
              font-size: 15px;
              margin-left: 10px;
              margin-top: 0;
            }

            .checkbox-option {
              position: relative;
              display: flex;
              align-items: center;
              padding: 16px 20px;
              background: white;
              border: 2px solid #e0e0e0;
              border-radius: 12px;
              cursor: pointer;
              transition: all 0.3s ease;
              font-size: 15px;
              font-weight: 500;
            }

            .checkbox-option:hover {
              border-color: var(--alico-blue-40);
              background: var(--alico-blue-10);
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(0, 15, 159, 0.1);
            }

            .checkbox-option input[type="checkbox"] {
              appearance: none;
              width: 22px;
              height: 22px;
              border: 2px solid #ccc;
              border-radius: 4px;
              margin-right: 12px;
              cursor: pointer;
              position: relative;
              transition: all 0.2s ease;
              flex-shrink: 0;
            }

            .checkbox-option input[type="checkbox"]:checked {
              border-color: var(--alico-blue);
              background: var(--alico-blue);
            }

            .checkbox-option input[type="checkbox"]:checked::after {
              content: '‚úì';
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              color: white;
              font-size: 14px;
              font-weight: bold;
            }

            .checkbox-option input[type="checkbox"]:checked ~ .checkbox-label {
              color: var(--alico-blue);
              font-weight: 700;
            }

            .checkbox-option:has(input:checked) {
              border-color: var(--alico-blue);
              background: linear-gradient(135deg, var(--alico-blue-10) 0%, var(--alico-gold-10) 100%);
              box-shadow: 0 4px 12px rgba(0, 15, 159, 0.15);
            }

            .checkbox-label {
              color: #333;
              transition: all 0.2s ease;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            </style>

            <script>
            // Manejo del campo "Otro"
            const otroColorCheckbox = document.getElementById('otroColorCheckbox');
            const otroColorField = document.getElementById('otroColorField');
            const otroColorText = document.getElementById('otroColorText');
            const otroColorCharCount = document.getElementById('otroColorCharCount');

            otroColorCheckbox.addEventListener('change', function() {
              if (this.checked) {
                otroColorField.style.display = 'block';
                otroColorText.required = true;
              } else {
                otroColorField.style.display = 'none';
                otroColorText.required = false;
                otroColorText.value = '';
                otroColorCharCount.textContent = '0 / 50 caracteres';
              }
            });

            // Contador de caracteres para "Otro"
            otroColorText.addEventListener('input', function() {
              const length = this.value.length;
              otroColorCharCount.textContent = `${length} / 50 caracteres`;
            });

            // Validaci√≥n de m√°ximo 3 colores
            const colorCheckboxes = document.querySelectorAll('.color-checkbox');
            const colorError = document.getElementById('colorError');

            colorCheckboxes.forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll('.color-checkbox:checked').length;
                
                if (checkedCount > 3) {
                  this.checked = false;
                  colorError.style.display = 'block';
                  setTimeout(() => {
                    colorError.style.display = 'none';
                  }, 3000);
                }
              });
            });

            // Validaci√≥n del paso 3
            function validateStep3() {
              const checkedColors = document.querySelectorAll('.color-checkbox:checked');
              
              if (checkedColors.length === 0) {
                colorError.textContent = '‚ö†Ô∏è Por favor selecciona al menos 1 color';
                colorError.style.display = 'block';
                setTimeout(() => {
                  colorError.style.display = 'none';
                }, 3000);
                return false;
              }
              
              if (checkedColors.length > 3) {
                colorError.textContent = '‚ö†Ô∏è Por favor selecciona m√°ximo 3 colores';
                colorError.style.display = 'block';
                setTimeout(() => {
                  colorError.style.display = 'none';
                }, 3000);
                return false;
              }
              
              // Validar que si "Otro" est√° seleccionado, tenga texto
              const otroChecked = document.getElementById('otroColorCheckbox').checked;
              const otroText = document.getElementById('otroColorText').value.trim();
              
              if (otroChecked && !otroText) {
                alert('Por favor especifica el color en el campo "Otro"');
                document.getElementById('otroColorText').focus();
                return false;
              }
              
              return true;
            }

            // Navegaci√≥n del paso 3
            document.getElementById('step3Prev').addEventListener('click', () => {
              currentStep = 2;
              showStep(currentStep);
            });

            document.getElementById('step3Next').addEventListener('click', () => {
              if (validateStep3()) {
                currentStep = 4;
                showStep(currentStep);
              }
            });
            </script>

            <!-- Step 4: Estilo gr√°fico -->
            <div class="form-step" data-step="4">
              <div class="form-section">
                <h3>üé® Paso 4: Describe el estilo gr√°fico de tu marca (M√°ximo 2)</h3>
                
                <div class="form-section-content">
                  <div id="styleError" style="display: none; padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 6px; margin-bottom: 16px; color: #721c24; font-weight: 600;">
                    ‚ö†Ô∏è Por favor selecciona entre 1 y 2 estilos
                  </div>
                  
                  <div class="checkbox-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Minimalista" class="style-checkbox">
                      <span class="checkbox-label">‚ú® Minimalista</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="R√∫stico" class="style-checkbox">
                      <span class="checkbox-label">üåæ R√∫stico</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Moderno" class="style-checkbox">
                      <span class="checkbox-label">üöÄ Moderno</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Vintage" class="style-checkbox">
                      <span class="checkbox-label">üìª Vintage</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Ilustrativo" class="style-checkbox">
                      <span class="checkbox-label">üé® Ilustrativo</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Elegante" class="style-checkbox">
                      <span class="checkbox-label">üíé Elegante</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Artesanal" class="style-checkbox">
                      <span class="checkbox-label">üñêÔ∏è Artesanal</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Urbano" class="style-checkbox">
                      <span class="checkbox-label">üèôÔ∏è Urbano</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="graphicStyle" value="Otro" class="style-checkbox" id="otroStyleCheckbox">
                      <span class="checkbox-label">‚úèÔ∏è Otro</span>
                    </label>
                  </div>
                  
                  <!-- Campo de texto para "Otro" -->
                  <div id="otroStyleField" style="display: none; margin-top: 20px;">
                    <label for="otroStyleText" style="display: block; margin-bottom: 8px; font-weight: 600;">Especifica el estilo:</label>
                    <input 
                      type="text" 
                      id="otroStyleText" 
                      name="otroStyleText" 
                      maxlength="50"
                      placeholder="Ejemplo: Futurista, Bohemio, etc."
                      style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;"
                    />
                    <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #666;">
                      <span id="otroStyleCharCount">0 / 50 caracteres</span>
                    </div>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 4 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step4Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step4Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <script>
            // Manejo del campo "Otro" en estilo
            const otroStyleCheckbox = document.getElementById('otroStyleCheckbox');
            const otroStyleField = document.getElementById('otroStyleField');
            const otroStyleText = document.getElementById('otroStyleText');
            const otroStyleCharCount = document.getElementById('otroStyleCharCount');

            otroStyleCheckbox.addEventListener('change', function() {
              if (this.checked) {
                otroStyleField.style.display = 'block';
                otroStyleText.required = true;
              } else {
                otroStyleField.style.display = 'none';
                otroStyleText.required = false;
                otroStyleText.value = '';
                otroStyleCharCount.textContent = '0 / 50 caracteres';
              }
            });

            // Contador de caracteres para "Otro"
            otroStyleText.addEventListener('input', function() {
              const length = this.value.length;
              otroStyleCharCount.textContent = `${length} / 50 caracteres`;
            });

            // Validaci√≥n de m√°ximo 2 estilos
            const styleCheckboxes = document.querySelectorAll('.style-checkbox');
            const styleError = document.getElementById('styleError');

            styleCheckboxes.forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                const checkedCount = document.querySelectorAll('.style-checkbox:checked').length;
                
                if (checkedCount > 2) {
                  this.checked = false;
                  styleError.style.display = 'block';
                  setTimeout(() => {
                    styleError.style.display = 'none';
                  }, 3000);
                }
              });
            });

            // Validaci√≥n del paso 4
            function validateStep4() {
              const checkedStyles = document.querySelectorAll('.style-checkbox:checked');
              
              if (checkedStyles.length === 0) {
                styleError.textContent = '‚ö†Ô∏è Por favor selecciona al menos 1 estilo';
                styleError.style.display = 'block';
                setTimeout(() => {
                  styleError.style.display = 'none';
                }, 3000);
                return false;
              }
              
              if (checkedStyles.length > 2) {
                styleError.textContent = '‚ö†Ô∏è Por favor selecciona m√°ximo 2 estilos';
                styleError.style.display = 'block';
                setTimeout(() => {
                  styleError.style.display = 'none';
                }, 3000);
                return false;
              }
              
              // Validar que si "Otro" est√° seleccionado, tenga texto
              const otroChecked = document.getElementById('otroStyleCheckbox').checked;
              const otroText = document.getElementById('otroStyleText').value.trim();
              
              if (otroChecked && !otroText) {
                alert('Por favor especifica el estilo en el campo "Otro"');
                document.getElementById('otroStyleText').focus();
                return false;
              }
              
              return true;
            }

            // Navegaci√≥n del paso 4
            document.getElementById('step4Prev').addEventListener('click', () => {
              currentStep = 3;
              showStep(currentStep);
            });

            document.getElementById('step4Next').addEventListener('click', () => {
              if (validateStep4()) {
                currentStep = 5;
                showStep(currentStep);
              }
            });
            </script>

            <!-- Step 5: Acabado del empaque -->
            <div class="form-step" data-step="5">
              <div class="form-section">
                <h3>‚ú® Paso 5: ¬øC√≥mo deseas el acabado de tu empaque?</h3>
                
                <div class="form-section-content">
                  <div class="radio-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="radio-option">
                      <input type="radio" name="packageFinish" value="Mate" required>
                      <span class="radio-label">üå´Ô∏è Mate</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="packageFinish" value="Brillante" required>
                      <span class="radio-label">‚ú® Brillante</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="packageFinish" value="Transparente" required>
                      <span class="radio-label">üíé Transparente</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="packageFinish" value="Papel" required>
                      <span class="radio-label">üìÑ Papel</span>
                    </label>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 5 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step5Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step5Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <script>
            // Validaci√≥n del paso 5
            function validateStep5() {
              const selectedFinish = document.querySelector('input[name="packageFinish"]:checked');
              if (!selectedFinish) {
                alert('Por favor selecciona el acabado de tu empaque');
                return false;
              }
              return true;
            }

            // Navegaci√≥n del paso 5
            document.getElementById('step5Prev').addEventListener('click', () => {
              currentStep = 4;
              showStep(currentStep);
            });

            document.getElementById('step5Next').addEventListener('click', () => {
              if (validateStep5()) {
                currentStep = 6;
                showStep(currentStep);
              }
            });
            </script>

            <!-- Step 6: ¬øDeseas aditamentos? -->
            <div class="form-step" data-step="6">
              <div class="form-section">
                <h3>üîß Paso 6: ¬øDeseas agregar aditamentos a tu empaque?</h3>
                
                <div class="form-section-content">
                  <div class="radio-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="radio-option">
                      <input type="radio" name="wantsAttachments" value="Si" required id="wantsAttachmentsYes">
                      <span class="radio-label">‚úÖ S√≠, quiero agregar aditamentos</span>
                    </label>
                    <label class="radio-option">
                      <input type="radio" name="wantsAttachments" value="No" required id="wantsAttachmentsNo">
                      <span class="radio-label">‚ùå No, no necesito aditamentos</span>
                    </label>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 6 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step6Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step6Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 7: Seleccionar aditamentos -->
            <div class="form-step" data-step="7">
              <div class="form-section">
                <h3>üî© Paso 7: ¬øCon cu√°les aditamentos deseas tu empaque? (Selecciona al menos uno)</h3>
                
                <div class="form-section-content">
                  <div id="attachmentError" style="display: none; padding: 12px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 6px; margin-bottom: 16px; color: #721c24; font-weight: 600;">
                    ‚ö†Ô∏è Por favor selecciona al menos un aditamento
                  </div>
                  
                  <div class="checkbox-options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px; margin-top: 20px;">
                    <label class="checkbox-option">
                      <input type="checkbox" name="attachments" value="Zipper" class="attachment-checkbox">
                      <span class="checkbox-label">üîí Zipper</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="attachments" value="V√°lvula dosificadora" class="attachment-checkbox">
                      <span class="checkbox-label">üíß V√°lvula dosificadora</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="attachments" value="V√°lvula desgasificadora" class="attachment-checkbox">
                      <span class="checkbox-label">üå¨Ô∏è V√°lvula desgasificadora</span>
                    </label>
                    <label class="checkbox-option">
                      <input type="checkbox" name="attachments" value="Ventana" class="attachment-checkbox">
                      <span class="checkbox-label">ü™ü Ventana</span>
                    </label>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 7 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step7Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step7Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <script>
            // Validaci√≥n del paso 6
            function validateStep6() {
              const selectedOption = document.querySelector('input[name="wantsAttachments"]:checked');
              if (!selectedOption) {
                alert('Por favor selecciona si deseas aditamentos');
                return false;
              }
              return true;
            }

            // Navegaci√≥n del paso 6 (con l√≥gica condicional)
            document.getElementById('step6Prev').addEventListener('click', () => {
              currentStep = 5;
              showStep(currentStep);
            });

            document.getElementById('step6Next').addEventListener('click', () => {
              if (validateStep6()) {
                const wantsAttachments = document.querySelector('input[name="wantsAttachments"]:checked').value;
                
                if (wantsAttachments === 'Si') {
                  // Si quiere aditamentos, ir al paso 7
                  currentStep = 7;
                } else {
                  // Si NO quiere aditamentos, saltar al paso 8
                  currentStep = 8;
                }
                showStep(currentStep);
              }
            });

            // Validaci√≥n del paso 7
            function validateStep7() {
              const checkedAttachments = document.querySelectorAll('.attachment-checkbox:checked');
              const attachmentError = document.getElementById('attachmentError');
              
              if (checkedAttachments.length === 0) {
                attachmentError.style.display = 'block';
                setTimeout(() => {
                  attachmentError.style.display = 'none';
                }, 3000);
                return false;
              }
              
              return true;
            }

            // Navegaci√≥n del paso 7
            document.getElementById('step7Prev').addEventListener('click', () => {
              currentStep = 6;
              showStep(currentStep);
            });

            document.getElementById('step7Next').addEventListener('click', () => {
              if (validateStep7()) {
                currentStep = 8;
                showStep(currentStep);
              }
            });
            </script>


            <!-- Step 8: Seleccionar foto -->
            <div class="form-step" data-step="8">
              <div class="form-section">
                <h3>üì∑ Paso 8: Selecciona una foto</h3>
                
                <div class="form-section-content">
                  <div class="photo-selector-container">
                    <!-- Dropdown selector personalizado -->
                    <label>Foto</label>
                    <div class="custom-select-wrapper">
                      <div class="custom-select-trigger" id="photoSelectTriggerDoypack">
                        <span class="custom-select-text">Cargando fotos...</span>
                        <span class="custom-select-arrow">‚ñº</span>
                      </div>
                      <div class="custom-select-dropdown" id="photoSelectDropdownDoypack">
                        <div class="custom-select-search">
                          <input type="text" id="photoSearchInputDoypack" placeholder="üîç Buscar foto...">
                        </div>
                        <div class="custom-select-options" id="photoSelectOptionsDoypack">
                          <!-- Las opciones se cargar√°n din√°micamente -->
                        </div>
                      </div>
                    </div>
                    <input type="hidden" id="photoSelectDoypack" name="photo_id" required>
                    
                    <!-- Preview de la foto seleccionada -->
                    <div id="photoPreviewDoypack" class="photo-preview-container" style="display: none;">
                      <div class="preview-header">
                        <span class="preview-title">üñºÔ∏è Vista previa</span>
                        <span class="preview-hint">(Click para ampliar)</span>
                      </div>
                      <div class="preview-image-wrapper">
                        <img 
                          id="previewImageDoypack" 
                          src="" 
                          alt="Vista previa" 
                          class="preview-image"
                        />
                      </div>
                      <p id="previewInfoDoypack" class="preview-info"></p>
                    </div>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 8 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step8Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step8Next" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üí</span>
                    <span>Siguiente</span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Step 9: Confirmar y enviar -->
            <div class="form-step" data-step="9">
              <div class="form-section">
                <h3>‚úÖ Paso 9: Confirmar y enviar</h3>
                
                <div class="form-section-content">
                  <div class="confirmation-summary">
                    <div class="summary-item">
                      <strong>Mercado del producto:</strong>
                      <div id="confirmMarketSector" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Descripci√≥n del producto:</strong>
                      <div id="confirmProductDescription" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Colores predominantes:</strong>
                      <div id="confirmColors" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Estilo gr√°fico:</strong>
                      <div id="confirmStyle" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Acabado del empaque:</strong>
                      <div id="confirmFinish" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Aditamentos:</strong>
                      <div id="confirmAttachments" style="margin-top: 8px;"></div>
                    </div>
                    <div class="summary-item">
                      <strong>Foto seleccionada:</strong>
                      <div id="confirmPhoto" style="margin-top: 8px;"></div>
                    </div>
                  </div>
                </div>
                
                <!-- Navigation buttons for Step 9 -->
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                  <button type="button" id="step9Prev" class="btn-secondary" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚Üê</span>
                    <span>Anterior</span>
                  </button>
                  <button type="button" id="step9Submit" class="btn-submit" style="padding: 14px 40px; font-size: 16px; font-weight: 700; flex: 1; max-width: 200px; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <span style="font-size: 20px;">‚úì</span>
                    <span>Enviar formulario</span>
                  </button>
                </div>
              </div>
            </div>

            <script>
            // Validaci√≥n del paso 8
            function validateStep8() {
              const photoId = document.getElementById('photoSelectDoypack').value;
              if (!photoId) {
                alert('Por favor selecciona una foto');
                return false;
              }
              return true;
            }

            // Navegaci√≥n del paso 8
            document.getElementById('step8Prev').addEventListener('click', () => {
              // Verificar si el usuario eligi√≥ aditamentos para saber a d√≥nde volver
              const wantsAttachments = document.querySelector('input[name="wantsAttachments"]:checked');
              if (wantsAttachments && wantsAttachments.value === 'Si') {
                currentStep = 7; // Volver al paso de selecci√≥n de aditamentos
              } else {
                currentStep = 6; // Volver al paso de "¬øDeseas aditamentos?"
              }
              showStep(currentStep);
            });

            document.getElementById('step8Next').addEventListener('click', () => {
              if (validateStep8()) {
                currentStep = 9;
                showStep(currentStep);
              }
            });



            // Funci√≥n para actualizar el resumen de confirmaci√≥n
            function updateConfirmationSummary() {
              // 1. Mercado del producto
              const selectedMarket = document.querySelector('input[name="marketSector"]:checked');
              if (selectedMarket) {
                const marketLabel = selectedMarket.nextElementSibling.textContent;
                document.getElementById('confirmMarketSector').innerHTML = `<div style="font-weight: 600; font-size: 16px; color: var(--alico-blue);">${marketLabel}</div>`;
              }

              // 2. Descripci√≥n del producto
              const productDesc = document.getElementById('productDescription').value.trim();
              if (productDesc) {
                document.getElementById('confirmProductDescription').innerHTML = `<div style="padding: 12px; background: #f8f9fa; border-left: 4px solid var(--alico-gold); border-radius: 6px; font-size: 15px; color: #333;">${productDesc}</div>`;
              }

              // 3. Colores predominantes
              const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(cb => {
                if (cb.value === 'Otro') {
                  const otroText = document.getElementById('otroColorText').value.trim();
                  return otroText ? `üé® ${otroText}` : 'üé® Otro';
                }
                return cb.nextElementSibling.textContent;
              });
              if (selectedColors.length > 0) {
                document.getElementById('confirmColors').innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${selectedColors.map(c => `<span style="padding: 8px 14px; background: var(--alico-gold-20); border-radius: 20px; font-weight: 600; font-size: 14px; color: var(--alico-blue);">${c}</span>`).join('')}</div>`;
              }

              // 4. Estilo gr√°fico
              const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked')).map(cb => {
                if (cb.value === 'Otro') {
                  const otroText = document.getElementById('otroStyleText').value.trim();
                  return otroText ? `‚úèÔ∏è ${otroText}` : '‚úèÔ∏è Otro';
                }
                return cb.nextElementSibling.textContent;
              });
              if (selectedStyles.length > 0) {
                document.getElementById('confirmStyle').innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${selectedStyles.map(s => `<span style="padding: 8px 14px; background: var(--alico-blue-20); border-radius: 20px; font-weight: 600; font-size: 14px; color: var(--alico-blue);">${s}</span>`).join('')}</div>`;
              }

              // 5. Acabado del empaque
              const selectedFinish = document.querySelector('input[name="packageFinish"]:checked');
              if (selectedFinish) {
                const finishLabel = selectedFinish.nextElementSibling.textContent;
                document.getElementById('confirmFinish').innerHTML = `<div style="font-weight: 600; font-size: 16px; color: var(--alico-blue);">${finishLabel}</div>`;
              }

              // 6. Aditamentos
              const wantsAttachments = document.querySelector('input[name="wantsAttachments"]:checked');
              if (wantsAttachments) {
                if (wantsAttachments.value === 'Si') {
                  const selectedAttachments = Array.from(document.querySelectorAll('.attachment-checkbox:checked')).map(cb => cb.nextElementSibling.textContent);
                  document.getElementById('confirmAttachments').innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px;">${selectedAttachments.map(a => `<span style="padding: 8px 14px; background: var(--alico-gold-20); border-radius: 20px; font-weight: 600; font-size: 14px; color: var(--alico-blue);">${a}</span>`).join('')}</div>`;
                } else {
                  document.getElementById('confirmAttachments').innerHTML = `<div style="font-weight: 600; font-size: 16px; color: #999;">‚ùå Sin aditamentos</div>`;
                }
              }

              // 7. Foto seleccionada
              const photoId = document.getElementById('photoSelectDoypack').value;
              if (photoId && allPhotos) {
                const selectedPhoto = allPhotos.find(p => p.id === photoId);
                if (selectedPhoto) {
                  const photoName = selectedPhoto.custom_name || selectedPhoto.filename;
                  const photoUrl = selectedPhoto.thumbnailUrl || selectedPhoto.signedUrl;
                  const photoFolder = selectedPhoto.folder || 'Sin carpeta';
                  
                  let html = `<div style="display: flex; align-items: center; gap: 16px;">`;
                  if (photoUrl) {
                    html += `<img src="${photoUrl}" alt="${photoName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--alico-gold);">`;
                  }
                  html += `<div><div style="font-weight: 600; font-size: 16px;">${photoName}</div><div style="color: #666; font-size: 14px; margin-top: 4px;">üìÅ ${photoFolder}</div></div></div>`;
                  
                  document.getElementById('confirmPhoto').innerHTML = html;
                }
              }
            }

            // Navegaci√≥n del paso 9
            document.getElementById('step9Prev').addEventListener('click', () => {
              currentStep = 8;
              showStep(currentStep);
            });

            document.getElementById('step9Submit').addEventListener('click', async (e) => {
              e.preventDefault();
              console.log('üöÄ Enviando formulario doypack...');
              
              // Recopilar todos los datos del formulario
              const photoId = document.getElementById('photoSelectDoypack').value;
              const selectedMarket = document.querySelector('input[name="marketSector"]:checked');
              const productDesc = document.getElementById('productDescription').value.trim();
              const selectedFinish = document.querySelector('input[name="packageFinish"]:checked');
              const wantsAttachments = document.querySelector('input[name="wantsAttachments"]:checked');

              if (!selectedMarket || !productDesc || !selectedFinish || !wantsAttachments || !photoId) {
                alert('Por favor completa todos los campos requeridos');
                return;
              }

              // Recopilar colores (incluyendo "Otro" con el texto personalizado)
              const selectedColors = Array.from(document.querySelectorAll('.color-checkbox:checked')).map(cb => {
                if (cb.value === 'Otro') {
                  const otroText = document.getElementById('otroColorText').value.trim();
                  return otroText || 'Otro';
                }
                return cb.value;
              });

              // Recopilar estilos (incluyendo "Otro" con el texto personalizado)
              const selectedStyles = Array.from(document.querySelectorAll('.style-checkbox:checked')).map(cb => {
                if (cb.value === 'Otro') {
                  const otroText = document.getElementById('otroStyleText').value.trim();
                  return otroText || 'Otro';
                }
                return cb.value;
              });

              // Recopilar aditamentos (incluyendo "Otro" con el texto personalizado si existe)
              // Si el usuario dijo "No", attachments quedar√° como array vac√≠o []
              let attachments = [];
              if (wantsAttachments.value === 'Si') {
                attachments = Array.from(document.querySelectorAll('.attachment-checkbox:checked')).map(cb => {
                  if (cb.value === 'Otro') {
                    const otroText = document.getElementById('otroAttachmentText')?.value.trim();
                    return otroText || 'Otro';
                  }
                  return cb.value;
                });
              }
              
              // Buscar la foto seleccionada en allPhotos
              const selectedPhoto = allPhotos.find(p => p.id === photoId);
              if (!selectedPhoto) {
                alert('Error: No se pudo encontrar la foto seleccionada');
                return;
              }

              const submitButton = e.target;
              const originalButtonHTML = submitButton.innerHTML;
              
              try {
                // Disable button and show loading state
                submitButton.disabled = true;
                submitButton.innerHTML = '‚è≥ Generando imagen... (puede tardar hasta 60 segundos)';
                submitButton.style.opacity = '0.6';
                
                // Actualizar cada 10 segundos para dar feedback al usuario
                let secondsElapsed = 0;
                const progressInterval = setInterval(() => {
                  secondsElapsed += 10;
                  submitButton.innerHTML = `‚è≥ Generando imagen... (${secondsElapsed}s transcurridos)`;
                }, 10000);
                
                const formData = {
                  action: 'form_submitted',
                  timestamp: new Date().toISOString(),
                  form_type: 'doypack',
                  user: {
                    id: user.id,
                    name: user.name,
                    email: user.email
                  },
                  user_photo: {
                    id: selectedPhoto.id,
                    url: selectedPhoto.signedUrl || selectedPhoto.url,
                    custom_name: selectedPhoto.custom_name,
                    folder: selectedPhoto.folder,
                    mimetype: selectedPhoto.mimetype,
                    size: selectedPhoto.size,
                    created_at: selectedPhoto.created_at
                  },
                  market_sector: selectedMarket.value,
                  product_description: productDesc,
                  brand_colors: selectedColors,
                  graphic_style: selectedStyles,
                  package_finish: selectedFinish.value,
                  wants_attachments: wantsAttachments.value,
                  attachments: attachments
                };

                console.log('üì§ Datos a enviar:', formData);

                // Fetch con timeout de 70 segundos
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 70000);

                const response = await fetch('/api/submit-form', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                  },
                  body: JSON.stringify(formData),
                  signal: controller.signal
                });

                clearTimeout(timeoutId);
                clearInterval(progressInterval);

                const result = await response.json();
                console.log('üì• Respuesta recibida:', result);

                if (response.status === 403 && result.credits !== undefined) {
                  const nextReset = new Date(result.nextReset);
                  alert(`‚ùå No tienes cr√©ditos disponibles\n\n` +
                        `Tus cr√©ditos se recargar√°n el ${nextReset.toLocaleDateString('es-ES', { 
                          day: 'numeric', 
                          month: 'long', 
                          year: 'numeric' 
                        })}\n\n` +
                        `Cada mes recibes 3 cr√©ditos nuevos.`);
                  
                  submitButton.disabled = false;
                  submitButton.innerHTML = originalButtonHTML;
                  submitButton.style.opacity = '1';
                  return;
                }

                if (response.ok && result.ok) {
                  console.log('‚úÖ Formulario enviado exitosamente:', result);
                  
                  // Redirigir inmediatamente al dashboard con par√°metro waiting
                  window.location.href = '/dashboard.html?waiting=true';
                } else if (!result.ok && result.credit_refunded) {
                  console.log('‚ö†Ô∏è Generaci√≥n fall√≥, cr√©dito reembolsado');
                  
                  if (typeof loadCredits === 'function') {
                    loadCredits();
                  }
                  
                  let message = '‚ö†Ô∏è La generaci√≥n de la imagen fall√≥\n\n';
                  message += '‚úÖ Tu cr√©dito ha sido reembolsado autom√°ticamente\n';
                  message += `üí≥ Cr√©ditos actuales: ${result.new_credits || 'N/A'}\n\n`;
                  message += 'Por favor intenta nuevamente en unos momentos.';
                  
                  alert(message);
                  window.location.reload();
                } else {
                  throw new Error(result.error || result.message || 'Error al enviar formulario');
                }
              } catch (error) {
                console.error('‚ùå Error al enviar formulario:', error);
                
                if (typeof progressInterval !== 'undefined') {
                  clearInterval(progressInterval);
                }
                
                let errorMessage = '‚ùå Error al enviar el formulario:\n';
                
                if (error.name === 'AbortError') {
                  errorMessage += 'La solicitud tard√≥ demasiado tiempo (m√°s de 70 segundos).\n';
                  errorMessage += 'El servidor de IA puede estar sobrecargado. Por favor intenta nuevamente.';
                } else {
                  errorMessage += error.message;
                }
                
                alert(errorMessage);
                
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonHTML;
                submitButton.style.opacity = '1';
              }
            });
            </script>

    <!-- Modal for full image view -->
    <div id="formImageViewModal" class="modal">
      <div class="modal-content modal-image">
        <span class="modal-close">&times;</span>
        <h2 id="formImageViewTitle">Imagen completa</h2>
        <img id="formFullImageView" src="" alt="" style="max-width: 100%; height: auto; border-radius: 8px;" />
      </div>
    </div>

    <script>
      console.log('üîµ Script principal de doypack cargado');
      const token = localStorage.getItem('token') || localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || localStorage.getItem('userInfo') || '{}');
      let allPhotos = [];
      let currentFullImageUrl = '';
      let allProducts = {};
      
      console.log('üë§ Usuario:', user);
      console.log('üîë Token presente:', !!token);
      
      if (!token) {
        window.location.href = '/login.html';
      }

      const userName = user.name || user.email || 'Usuario';
      document.getElementById('userName').textContent = userName;
      document.getElementById('mobileUserName').textContent = userName;

      // Check if user is admin and show admin button
      if (user.is_admin) {
        document.getElementById('adminDashboardBtn').style.display = 'inline-block';
        document.getElementById('mobileAdminDashboardBtn').style.display = 'block';
      }

      // Mobile menu handlers
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function openMobileMenu() {
        mobileMenu.classList.add('active');
        mobileMenuOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove('active');
        mobileMenuOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }

      mobileMenuToggle.addEventListener('click', openMobileMenu);
      mobileMenuClose.addEventListener('click', closeMobileMenu);
      mobileMenuOverlay.addEventListener('click', closeMobileMenu);

      document.getElementById('mobileLogoutBtn').addEventListener('click', () => {
        if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
          localStorage.removeItem('token');
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          localStorage.removeItem('userInfo');
          window.location.href = '/login.html';
        }
      });

      // Load user credits
      async function loadCredits() {
        try {
          const res = await fetch('/api/credits', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok) {
            // Update desktop credits
            const creditsCount = document.getElementById('creditsCount');
            creditsCount.textContent = data.credits;
            
            // Update mobile credits
            const mobileCreditsCount = document.getElementById('mobileCreditsCount');
            mobileCreditsCount.textContent = data.credits;
            
            // Change color based on credits remaining
            const creditsDisplay = document.getElementById('creditsDisplay');
            if (data.credits === 0) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%)';
              creditsDisplay.style.borderColor = '#dc3545';
              creditsCount.style.color = '#dc3545';
              
              // Show next reset date
              const nextReset = new Date(data.nextReset);
              creditsDisplay.title = `Se recargar√°n el ${nextReset.toLocaleDateString('es-ES')}`;
            } else if (data.credits === 1) {
              creditsDisplay.style.background = 'linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%)';
              creditsDisplay.style.borderColor = '#ffc107';
              creditsCount.style.color = '#856404';
            }
          }
        } catch (err) {
          console.error('Error loading credits:', err);
        }
      }

      loadCredits();

      // Category icons and labels
      const categoryConfig = {
        'estuches': { icon: 'üéÅ', label: 'Estuches' },
        'base-tapa': { icon: 'üîÑ', label: 'Base y Tapa' },
        'bandejas': { icon: 'üç±', label: 'Bandejas' },
        'domos': { icon: 'üîÆ', label: 'Domos' }
      };

      // Load products from API with cache
      async function loadProducts() {
        console.log('üîÑ Iniciando carga de productos...');
        console.log('Token:', token ? 'Existe ‚úì' : 'No existe ‚úó');
        
        const productsLoading = document.getElementById('productsLoading');
        if (!productsLoading) {
          console.warn('‚ö†Ô∏è productsLoading no encontrado (normal en doypack)');
          return;
        }
        
        try {
          // Check cache first (5 minutes)
          const cacheKey = 'products_termoformado';
          const cacheTimeKey = 'products_termoformado_time';
          const cacheData = localStorage.getItem(cacheKey);
          const cacheTime = localStorage.getItem(cacheTimeKey);
          const now = Date.now();
          const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

          // Use cache if available and not expired
          if (cacheData && cacheTime && (now - parseInt(cacheTime)) < CACHE_DURATION) {
            console.log('üì¶ Usando cach√©...');
            const data = JSON.parse(cacheData);
            allProducts = data.groupedProducts;
            renderProducts(data.groupedProducts);
            if (productsLoading) productsLoading.style.display = 'none';
            console.log('‚úÖ Productos cargados desde cach√©:', Object.keys(data.groupedProducts).length, 'categor√≠as');
            return;
          }

          // Fetch from API
          console.log('üåê Llamando a /api/products/termoformado...');
          const res = await fetch('/api/products/termoformado', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          
          console.log('üì° Respuesta recibida:', res.status, res.statusText);
          const data = await res.json();
          console.log('üì¶ Datos recibidos:', data);
          
          if (data.ok && data.groupedProducts) {
            allProducts = data.groupedProducts;
            renderProducts(data.groupedProducts);
            if (productsLoading) productsLoading.style.display = 'none';
            
            // Save to cache
            localStorage.setItem(cacheKey, JSON.stringify(data));
            localStorage.setItem(cacheTimeKey, now.toString());
            console.log('‚úÖ Productos cargados desde API:', Object.keys(data.groupedProducts).length, 'categor√≠as');
          } else {
            throw new Error(data.error || 'Error al cargar productos');
          }
        } catch (err) {
          console.error('‚ùå Error loading products:', err);
          if (productsLoading) {
            productsLoading.innerHTML = `
              <div style="color: #721c24; text-align: center; padding: 40px;">
                <div style="font-size: 48px; margin-bottom: 16px;">‚ùå</div>
                <p><strong>Error al cargar productos</strong></p>
                <p style="font-size: 14px; margin-top: 12px;">${err.message}</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">
                  Recargar p√°gina
                </button>
              </div>
            `;
          }
        }
      }

      // Render products grouped by category
      function renderProducts(groupedProducts) {
        const container = document.getElementById('productsContainer');
        if (!container) {
          console.warn('‚ö†Ô∏è productsContainer no encontrado (normal en doypack)');
          return;
        }
        container.innerHTML = '';

        Object.keys(groupedProducts).forEach(category => {
          const config = categoryConfig[category] || { icon: 'üì¶', label: category };
          const products = groupedProducts[category];

          const accordion = document.createElement('div');
          accordion.className = 'product-accordion';

          const header = document.createElement('button');
          header.type = 'button';
          header.className = 'accordion-header';
          header.onclick = () => toggleAccordion(header);
          header.innerHTML = `
            <span>${config.icon} ${config.label}</span>
            <span class="accordion-icon">‚ñº</span>
          `;

          const content = document.createElement('div');
          content.className = 'accordion-content';

          const grid = document.createElement('div');
          grid.className = 'product-grid';

          products.forEach(product => {
            const card = document.createElement('label');
            card.className = 'product-card';
            card.htmlFor = `product-${product.id}`;

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'product_type';
            radio.id = `product-${product.id}`;
            radio.value = product.id;
            radio.className = 'product-radio';
            radio.addEventListener('change', handleProductSelection);

            const imageDiv = document.createElement('div');
            imageDiv.className = 'product-image';
            
            if (product.imageUrl && !product.imageError) {
              const img = document.createElement('img');
              img.src = product.imageUrl;
              img.alt = product.name;
              img.style.width = '100%';
              img.style.height = '100%';
              img.style.objectFit = 'cover';
              img.style.borderRadius = '8px';
              img.onerror = function() {
                this.parentElement.innerHTML = 'üì¶';
              };
              imageDiv.appendChild(img);
            } else {
              imageDiv.textContent = config.icon;
            }

            const name = document.createElement('p');
            name.className = 'product-name';
            name.textContent = product.name;

            card.appendChild(radio);
            card.appendChild(imageDiv);
            card.appendChild(name);

            grid.appendChild(card);
          });

          content.appendChild(grid);
          accordion.appendChild(header);
          accordion.appendChild(content);
          container.appendChild(accordion);
        });
      }

      // Handle product selection
      function handleProductSelection() {
        // Remove selected class from all cards
        document.querySelectorAll('.product-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // Add selected class to the clicked card
        if (this.checked) {
          this.closest('.product-card').classList.add('selected');
        }
      }

      // === WIZARD NAVIGATION ===
      let currentStep = 1;
      const totalSteps = 3;

      function showStep(step) {
        // Hide all steps
        document.querySelectorAll('.form-step').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active', 'completed'));

        // Validar que el paso existe
        const formStep = document.querySelector(`.form-step[data-step="${step}"]`);
        const wizardStep = document.querySelector(`.wizard-step[data-step="${step}"]`);
        if (!formStep || !wizardStep) {
          console.warn(`El paso ${step} no existe en el DOM.`);
          return;
        }

        // Show current step
        formStep.classList.add('active');
        wizardStep.classList.add('active');

        // Mark previous steps as completed
        for (let i = 1; i < step; i++) {
          const wiz = document.querySelector(`.wizard-step[data-step="${i}"]`);
          if (wiz) wiz.classList.add('completed');
        }

        // Update progress lines
        document.querySelectorAll('.wizard-line').forEach((line, index) => {
          if (index < step - 1) {
            line.classList.add('completed');
          } else {
            line.classList.remove('completed');
          }
        });

        // Si es el paso 9 (resumen/confirmar), actualizar el resumen
        if (step === 9 && typeof updateConfirmationSummary === 'function') {
          setTimeout(() => updateConfirmationSummary(), 100);
        }
      }



      const step1NextBtn = document.getElementById('step1Next');
      if (step1NextBtn) {
        step1NextBtn.addEventListener('click', () => {
          const selectedMarket = document.querySelector('input[name="marketSector"]:checked');
          if (!selectedMarket) {
            alert('Por favor selecciona el mercado de tu producto');
            return;
          }
          currentStep = 2;
          showStep(currentStep);
        });
      }

      // Step 2 navigation
      const step2NextBtn = document.getElementById('step2Next');
      if (step2NextBtn) {
        step2NextBtn.addEventListener('click', () => {
          const productDesc = document.getElementById('productDescription').value.trim();
          if (!productDesc || productDesc.length === 0) {
            alert('Por favor describe tu producto');
            return;
          }
          if (productDesc.length > 120) {
            alert('La descripci√≥n no puede exceder los 120 caracteres');
            return;
          }
          currentStep = 3;
          showStep(currentStep);
        });
      }
      const step3PrevBtn = document.getElementById('step3Prev');
      if (step3PrevBtn) {
        step3PrevBtn.addEventListener('click', () => {
          currentStep = 2;
          showStep(currentStep);
        });
      }

      const step3NextBtn = document.getElementById('step3Next');
      if (step3NextBtn) {
        step3NextBtn.addEventListener('click', () => {
          if (typeof validateStep3 === 'function' ? validateStep3() : true) {
            currentStep = 4;
            showStep(currentStep);
          }
        });
      }

      // Step 4 navigation
      const step4PrevBtn = document.getElementById('step4Prev');
      if (step4PrevBtn) {
        step4PrevBtn.addEventListener('click', () => {
          currentStep = 3;
          showStep(currentStep);
        });
      }

      const step4NextBtn = document.getElementById('step4Next');
      if (step4NextBtn) {
        step4NextBtn.addEventListener('click', () => {
          if (typeof validateStep4 === 'function' ? validateStep4() : true) {
            currentStep = 5;
            showStep(currentStep);
          }
        });
      }

      // Step 5 navigation
      const step5PrevBtn = document.getElementById('step5Prev');
      if (step5PrevBtn) {
        step5PrevBtn.addEventListener('click', () => {
          currentStep = 4;
          showStep(currentStep);
        });
      }

      const step5NextBtn = document.getElementById('step5Next');
      if (step5NextBtn) {
        step5NextBtn.addEventListener('click', () => {
          if (typeof validateStep5 === 'function' ? validateStep5() : true) {
            currentStep = 6;
            if (typeof updateConfirmation === 'function') updateConfirmation();
            showStep(currentStep);
          }
        });
      }

      // === NAVIGATION CODE REMOVED - Using step8/step9 navigation instead ===

      /* C√ìDIGO ANTIGUO REMOVIDO - step6Submit no existe en doypack
      document.getElementById('step6Submit').addEventListener('click', async (e) => {
        e.preventDefault();
        console.log('üöÄ Enviando formulario...');
        
        const photoId = document.getElementById('photoSelect').value;
        const selectedProduct = document.querySelector('input[name="product_type"]:checked');
        const selectedMarket = document.querySelector('input[name="marketSector"]:checked');
        const productDesc = document.getElementById('productDescription').value.trim();
        const selectedLogo = document.querySelector('input[name="logoDisplay"]:checked');

        if (!selectedMarket || !productDesc || !selectedProduct || !photoId || !selectedLogo) {
          alert('Por favor completa todos los campos requeridos');
          return;
        }

        const submitButton = e.target;
        const originalButtonText = submitButton.textContent;
        
        try {
          // Disable button and show loading state with detailed message
          submitButton.disabled = true;
          submitButton.innerHTML = '‚è≥ Generando imagen... (puede tardar hasta 60 segundos)';
          submitButton.style.opacity = '0.6';
          
          // Actualizar cada 10 segundos para dar feedback al usuario
          let secondsElapsed = 0;
          const progressInterval = setInterval(() => {
            secondsElapsed += 10;
            submitButton.innerHTML = `‚è≥ Generando imagen... (${secondsElapsed}s transcurridos)`;
          }, 10000);
          
          const formData = {
            photo_id: photoId,
            form_type: 'doypack',
            product_id: selectedProduct.value,
            market_sector: selectedMarket.value,
            product_description: productDesc,
            logo_display_preference: selectedLogo.value
          };

          console.log('üì§ Datos a enviar:', formData);

          // Fetch con timeout de 70 segundos
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 70000); // 70 segundos

          const response = await fetch('/api/submit-form', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(formData),
            signal: controller.signal
          });

          clearTimeout(timeoutId);
          clearInterval(progressInterval);

          const result = await response.json();
          console.log('üì• Respuesta recibida:', result);

          if (response.status === 403 && result.credits !== undefined) {
            // No credits available
            const nextReset = new Date(result.nextReset);
            alert(`‚ùå No tienes cr√©ditos disponibles\n\n` +
                  `Tus cr√©ditos se recargar√°n el ${nextReset.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                  })}\n\n` +
                  `Cada mes recibes 3 cr√©ditos nuevos.`);
            
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
            submitButton.style.opacity = '1';
            return;
          }

          if (response.ok && result.ok) {
            console.log('‚úÖ Formulario enviado exitosamente:', result);
            
            // Update credits display
            loadCredits();
            
            let message = '‚úÖ ¬°Formulario enviado correctamente!\n';
            message += 'üí≥ Se ha descontado 1 cr√©dito\n\n';
            
            if (result.webhook_sent) {
              message += 'üéØ Webhook enviado a Alico exitosamente';
            } else {
              message += '‚ö†Ô∏è Advertencia: El webhook no pudo ser enviado\n';
              message += `Error: ${result.webhook_error || 'Desconocido'}`;
            }
            
            alert(message);
            
            // Redirect to dashboard after success
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
          } else if (!result.ok && result.credit_refunded) {
            // La generaci√≥n fall√≥ pero el cr√©dito fue reembolsado
            console.log('‚ö†Ô∏è Generaci√≥n fall√≥, cr√©dito reembolsado');
            
            // Actualizar cr√©ditos
            loadCredits();
            
            let message = '‚ö†Ô∏è La generaci√≥n de la imagen fall√≥\n\n';
            message += '‚úÖ Tu cr√©dito ha sido reembolsado autom√°ticamente\n';
            message += `üí≥ Cr√©ditos actuales: ${result.new_credits || 'N/A'}\n\n`;
            message += 'Por favor intenta nuevamente en unos momentos.';
            
            alert(message);
            
            // Redirigir al inicio del formulario (recargar p√°gina)
            window.location.reload();
          } else {
            throw new Error(result.error || result.message || 'Error al enviar formulario');
          }
        } catch (error) {
          console.error('‚ùå Error al enviar formulario:', error);
          
          // Limpiar interval si existe
          if (typeof progressInterval !== 'undefined') {
            clearInterval(progressInterval);
          }
          
          let errorMessage = '‚ùå Error al enviar el formulario:\n';
          
          if (error.name === 'AbortError') {
            errorMessage += 'La solicitud tard√≥ demasiado tiempo (m√°s de 70 segundos).\n';
            errorMessage += 'El servidor de IA puede estar sobrecargado. Por favor intenta nuevamente.';
          } else {
            errorMessage += error.message;
          }
          
          alert(errorMessage);
          
          // Re-enable button
          submitButton.disabled = false;
          submitButton.innerHTML = originalButtonText;
          submitButton.style.opacity = '1';
        }
      }); */
      // === FIN DEL C√ìDIGO ANTIGUO COMENTADO ===

      // Initialize wizard
      showStep(1);

      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', () => {
          if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
            localStorage.removeItem('token');
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            localStorage.removeItem('userInfo');
            window.location.href = '/login.html';
          }
        });
      }

      // Cargar fotos del usuario
      async function loadPhotosDoypack() {
        try {
          const res = await fetch('/api/uploads', {
            headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json();
          
          if (data.ok && data.uploads) {
            // Filtrar im√°genes generadas por IA
            const userPhotos = data.uploads.filter(photo => photo.folder !== 'AI Generated');
            allPhotos = userPhotos;
            populatePhotoSelectDoypack(userPhotos);
          } else {
            const triggerText = document.getElementById('photoSelectTriggerDoypack')?.querySelector('.custom-select-text');
            if (triggerText) triggerText.textContent = 'Error al cargar fotos';
          }
        } catch (err) {
          console.error('Error loading photos:', err);
          const triggerText = document.getElementById('photoSelectTriggerDoypack')?.querySelector('.custom-select-text');
          if (triggerText) triggerText.textContent = 'Error al cargar fotos';
        }
      }

      function populatePhotoSelectDoypack(photos) {
        const trigger = document.getElementById('photoSelectTriggerDoypack');
        const triggerText = trigger?.querySelector('.custom-select-text');
        const optionsContainer = document.getElementById('photoSelectOptionsDoypack');
        const hiddenInput = document.getElementById('photoSelectDoypack');
        
        if (!trigger || !triggerText) return;
        
        if (photos.length === 0) {
          triggerText.textContent = 'No hay fotos disponibles';
          triggerText.classList.add('placeholder');
          optionsContainer.innerHTML = '<div class="custom-select-no-results">No hay fotos disponibles</div>';
          document.getElementById('photoPreviewDoypack').style.display = 'none';
          return;
        }

        // Agrupar por carpeta
        const byFolder = {};
        photos.forEach(photo => {
          const folder = photo.folder || 'Sin carpeta';
          if (!byFolder[folder]) byFolder[folder] = [];
          byFolder[folder].push(photo);
        });

        // Crear opciones agrupadas
        optionsContainer.innerHTML = '';
        Object.keys(byFolder).sort().forEach(folder => {
          // Etiqueta de grupo
          const groupLabel = document.createElement('div');
          groupLabel.className = 'custom-select-group-label';
          groupLabel.textContent = `üìÅ ${folder}`;
          optionsContainer.appendChild(groupLabel);
          
          // Opciones del grupo
          byFolder[folder].forEach(photo => {
            const option = document.createElement('div');
            option.className = 'custom-select-option';
            option.dataset.value = photo.id;
            option.dataset.name = photo.custom_name || photo.filename;
            option.dataset.url = photo.thumbnailUrl || photo.signedUrl;
            option.dataset.fullUrl = photo.signedUrl;
            option.dataset.filename = photo.filename;
            option.dataset.folder = photo.folder;
            
            option.innerHTML = `
              <img src="${photo.thumbnailUrl || photo.signedUrl}" 
                   alt="${photo.custom_name || photo.filename}" 
                   class="custom-select-option-thumbnail"
                   loading="lazy">
              <div class="custom-select-option-info">
                <div class="custom-select-option-name">${photo.custom_name || photo.filename}</div>
                <div class="custom-select-option-folder">üìÅ ${photo.folder || 'Sin carpeta'}</div>
              </div>
            `;
            
            option.addEventListener('click', () => selectPhotoDoypack(photo, option));
            optionsContainer.appendChild(option);
          });
        });

        // Resetear texto del trigger
        triggerText.textContent = '-- Selecciona una foto --';
        triggerText.classList.add('placeholder');
      }

      function selectPhotoDoypack(photo, optionElement) {
        const trigger = document.getElementById('photoSelectTriggerDoypack');
        const triggerText = trigger.querySelector('.custom-select-text');
        const dropdown = document.getElementById('photoSelectDropdownDoypack');
        const hiddenInput = document.getElementById('photoSelectDoypack');
        
        // Actualizar valor
        hiddenInput.value = photo.id;
        
        // Actualizar texto del trigger
        triggerText.textContent = photo.custom_name || photo.filename;
        triggerText.classList.remove('placeholder');
        
        // Actualizar selecci√≥n visual
        document.querySelectorAll('.custom-select-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        optionElement.classList.add('selected');
        
        // Cerrar dropdown
        trigger.classList.remove('active');
        dropdown.classList.remove('active');
        
        // Mostrar preview
        showPhotoPreviewDoypack(photo);
      }

      function showPhotoPreviewDoypack(photo) {
        const previewContainer = document.getElementById('photoPreviewDoypack');
        const previewImage = document.getElementById('previewImageDoypack');
        const previewInfo = document.getElementById('previewInfoDoypack');
        
        previewImage.src = photo.signedUrl;
        previewImage.onclick = () => viewFormFullImage(photo.signedUrl, photo.custom_name || photo.filename);
        previewInfo.textContent = `üìÅ ${photo.folder || 'Sin carpeta'}`;
        previewContainer.style.display = 'block';
        
        currentFullImageUrl = photo.signedUrl;
      }

      // Inicializar dropdown personalizado
      function initCustomSelectDoypack() {
        const trigger = document.getElementById('photoSelectTriggerDoypack');
        const dropdown = document.getElementById('photoSelectDropdownDoypack');
        const searchInput = document.getElementById('photoSearchInputDoypack');
        
        if (!trigger || !dropdown || !searchInput) return;
        
        // Toggle dropdown
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          trigger.classList.toggle('active');
          dropdown.classList.toggle('active');
          if (dropdown.classList.contains('active')) {
            searchInput.focus();
          }
        });
        
        // Prevenir que clicks dentro del dropdown lo cierren
        dropdown.addEventListener('click', (e) => {
          e.stopPropagation();
        });
        
        // Cerrar al hacer click fuera
        document.addEventListener('click', (e) => {
          if (!trigger.contains(e.target) && !dropdown.contains(e.target)) {
            trigger.classList.remove('active');
            dropdown.classList.remove('active');
          }
        });
        
        // B√∫squeda
        searchInput.addEventListener('input', (e) => {
          const searchTerm = e.target.value.toLowerCase();
          const options = document.querySelectorAll('.custom-select-option');
          
          let hasVisibleOptions = false;
          let currentGroupHasVisible = false;
          let currentGroupLabel = null;
          
          document.querySelectorAll('.custom-select-group-label, .custom-select-option').forEach(el => {
            if (el.classList.contains('custom-select-group-label')) {
              if (currentGroupLabel) {
                currentGroupLabel.style.display = currentGroupHasVisible ? 'block' : 'none';
              }
              currentGroupLabel = el;
              currentGroupHasVisible = false;
            } else {
              const name = el.dataset.name?.toLowerCase() || '';
              const folder = (el.dataset.folder || 'Sin carpeta').toLowerCase();
              const matches = name.includes(searchTerm) || folder.includes(searchTerm);
              el.style.display = matches ? 'flex' : 'none';
              if (matches) {
                hasVisibleOptions = true;
                currentGroupHasVisible = true;
              }
            }
          });
          
          if (currentGroupLabel) {
            currentGroupLabel.style.display = currentGroupHasVisible ? 'block' : 'none';
          }
          
          const noResults = document.querySelector('.custom-select-no-results');
          if (!hasVisibleOptions && !noResults) {
            const msg = document.createElement('div');
            msg.className = 'custom-select-no-results';
            msg.textContent = 'üîç No se encontraron resultados';
            document.getElementById('photoSelectOptionsDoypack').appendChild(msg);
          } else if (hasVisibleOptions && noResults) {
            noResults.remove();
          }
        });
      }

      // Modal for full image view
      const formImageViewModal = document.getElementById('formImageViewModal');

      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.target.closest('.modal').style.display = 'none';
        });
      });

      window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
          e.target.style.display = 'none';
        }
      });

      function viewFormFullImage(url, title) {
        document.getElementById('formFullImageView').src = url;
        document.getElementById('formImageViewTitle').textContent = title;
        formImageViewModal.style.display = 'flex';
      }

      // Preview de la foto seleccionada
      // Enviar formulario - DESHABILITADO (ahora se maneja en step3Submit)
      /* document.getElementById('mainForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const photoId = document.getElementById('photoSelect').value;
        const selectedProduct = document.querySelector('input[name="product_type"]:checked');

        const submitButton = document.getElementById('submitBtn');
        const originalButtonText = submitButton.textContent;
        
        try {
          // Disable button and show loading state
          submitButton.disabled = true;
          submitButton.textContent = 'Enviando...';
          submitButton.style.opacity = '0.6';
          
          const formData = {
            photo_id: photoId,
            form_type: 'termoformado',
            product_id: selectedProduct.value,
            // Aqu√≠ se agregar√°n m√°s campos cuando se a√±adan m√°s secciones
          };

          const response = await fetch('/api/submit-form', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (response.status === 403 && result.credits !== undefined) {
            // No credits available
            const nextReset = new Date(result.nextReset);
            alert(`‚ùå No tienes cr√©ditos disponibles\n\n` +
                  `Tus cr√©ditos se recargar√°n el ${nextReset.toLocaleDateString('es-ES', { 
                    day: 'numeric', 
                    month: 'long', 
                    year: 'numeric' 
                  })}\n\n` +
                  `Cada mes recibes 3 cr√©ditos nuevos.`);
            
            submitButton.disabled = false;
            submitButton.textContent = originalButtonText;
            submitButton.style.opacity = '1';
            return;
          }

          if (response.ok && result.ok) {
            console.log('Formulario enviado exitosamente:', result);
            
            // Update credits display
            loadCredits();
            
            let message = '‚úÖ ¬°Formulario enviado correctamente!\n';
            message += 'üí≥ Se ha descontado 1 cr√©dito\n\n';
            
            if (result.webhook_sent) {
              message += 'üéØ Webhook enviado a Alico exitosamente';
            } else {
              message += '‚ö†Ô∏è Advertencia: El webhook no pudo ser enviado\n';
              message += `Error: ${result.webhook_error || 'Desconocido'}`;
            }
            
            alert(message);
            
            // Redirect to dashboard after success
            setTimeout(() => {
              window.location.href = '/dashboard.html';
            }, 2000);
          } else {
            throw new Error(result.error || 'Error al enviar formulario');
          }
        } catch (error) {
          console.error('Error al enviar formulario:', error);
          alert('‚ùå Error al enviar el formulario:\n' + error.message);
          
          // Re-enable button
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
          submitButton.style.opacity = '1';
        }
      }); */

      // Toggle accordion function (permite m√∫ltiples abiertos)
      function toggleAccordion(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('.accordion-icon');
        
        // Toggle the clicked accordion
        button.classList.toggle('active');
        content.classList.toggle('active');
        
        // Update icon
        if (button.classList.contains('active')) {
          icon.textContent = '‚ñ≤';
        } else {
          icon.textContent = '‚ñº';
        }
      }

      // Handle product selection
      document.querySelectorAll('.product-radio').forEach(radio => {
        radio.addEventListener('change', function() {
          // Remove selected class from all cards
          document.querySelectorAll('.product-card').forEach(card => {
            card.classList.remove('selected');
          });
          
          // Add selected class to the clicked card
          if (this.checked) {
            this.closest('.product-card').classList.add('selected');
          }
        });
      });

      // Inicializar dropdown personalizado de doypack
      console.log('üü¢ Intentando inicializar selector de fotos doypack...');
      console.log('üîç Buscando elemento photoSelectTriggerDoypack:', document.getElementById('photoSelectTriggerDoypack'));
      initCustomSelectDoypack();
      // console.log('üü¢ Cargando productos...'); // Doypack no usa productos
      // loadProducts(); // Doypack no usa productos
      console.log('üü¢ Cargando fotos doypack...');
      loadPhotosDoypack();

      // === FUNCI√ìN PARA CONSTRUIR EL JSON DEL FORMULARIO DOYPACK ===
      function buildDoypackFormJson() {
        const userId = user.id || user.email || '';
        // Paso 1: Mercado
        const mercado = document.querySelector('input[name="mercado"]:checked')?.value || '';
        // Paso 2: Descripci√≥n producto
        const producto = document.getElementById('productDescription')?.value || '';
        // Paso 3: Colores
        const colores = Array.from(document.querySelectorAll('input[name="brandColors"]:checked')).map(cb => cb.value);
        const otroColor = document.getElementById('otroColorText')?.value || '';
        // Paso 4: Foto
        const fotoId = document.getElementById('photoSelectDoypack')?.value || '';
        // Paso 5: Logo
        const logo = document.querySelector('input[name="logoDisplay"]:checked')?.value || '';
        // Paso 6: Material
        const material = document.querySelector('input[name="material"]:checked')?.value || '';
        // Paso 7: Aditamentos
        const aditamentos = Array.from(document.querySelectorAll('input[name="aditamentos"]:checked')).map(cb => cb.value);
        // Paso 8: Cantidad
        const cantidad = document.getElementById('cantidadSolicitada')?.value || '';
        // Paso 9: Contacto
        const nombre = document.getElementById('contactName')?.value || '';
        const email = document.getElementById('contactEmail')?.value || '';
        const telefono = document.getElementById('contactPhone')?.value || '';
        // Timestamp
        const timestamp = new Date().toISOString();

        return {
          form_type: 'doypack',
          user_id: userId,
          step_1_mercado: mercado,
          step_2_producto: producto,
          step_3_colores: colores,
          step_3_otro_color: otroColor,
          step_4_foto_id: fotoId,
          step_5_logo: logo,
          step_6_material: material,
          step_7_aditamentos: aditamentos,
          step_8_cantidad: cantidad,
          step_9_contacto: {
            nombre,
            email,
            telefono
          },
          timestamp
        };
      }
    </script>
  </body>
</html>
<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Restablecer ContraseÃ±a - Formulario IA</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h1>ğŸ” Restablecer ContraseÃ±a</h1>
        <p style="text-align: center; color: #666; margin-bottom: 24px;">
          Ingresa tu nueva contraseÃ±a
        </p>
        
        <form id="resetForm">
          <label>Nueva ContraseÃ±a
            <div class="password-wrapper">
              <input type="password" name="newPassword" id="newPassword" required minlength="8" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword', this)">
                ğŸ‘ï¸
              </button>
            </div>
          </label>
          <label>Confirmar ContraseÃ±a
            <div class="password-wrapper">
              <input type="password" name="confirmPassword" id="confirmPassword" required minlength="8" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword', this)">
                ğŸ‘ï¸
              </button>
            </div>
          </label>
          <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin: 16px 0; border-radius: 6px;">
            <p style="margin: 0; font-size: 13px; color: #856404; line-height: 1.6;">
              <strong>âš ï¸ Requisitos:</strong><br>
              â€¢ MÃ­nimo 8 caracteres<br>
              â€¢ Se recomienda usar letras, nÃºmeros y sÃ­mbolos
            </p>
          </div>
          <button type="submit">Restablecer ContraseÃ±a</button>
          <div id="resetResult" class="result"></div>
        </form>
        
        <div class="links">
          <a href="/login.html">â† Volver al inicio de sesiÃ³n</a>
        </div>
      </div>
    </div>
    
    <script>
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      // If no token, redirect to login
      if (!token) {
        alert('Token invÃ¡lido. Por favor solicita un nuevo enlace de recuperaciÃ³n.');
        window.location.href = '/login.html';
      }

      document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newPassword = fd.get('newPassword');
        const confirmPassword = fd.get('confirmPassword');
        const resEl = document.getElementById('resetResult');
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
          resEl.textContent = 'âŒ Las contraseÃ±as no coinciden';
          resEl.style.color = '#dc3545';
          return;
        }
        
        // Validate password length
        if (newPassword.length < 8) {
          resEl.textContent = 'âŒ La contraseÃ±a debe tener al menos 8 caracteres';
          resEl.style.color = '#dc3545';
          return;
        }
        
        resEl.textContent = 'Restableciendo contraseÃ±a...';
        resEl.style.color = '';
        
        try {
          const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword })
          });
          
          const data = await res.json();
          
          if (data.ok) {
            resEl.textContent = 'âœ… Â¡ContraseÃ±a restablecida exitosamente!';
            resEl.style.color = '#28a745';
            setTimeout(() => {
              window.location.href = '/login.html';
            }, 2000);
          } else {
            resEl.textContent = 'âŒ ' + (data.error || 'Error al restablecer contraseÃ±a');
            resEl.style.color = '#dc3545';
          }
        } catch (err) {
          resEl.textContent = 'âŒ ' + String(err);
          resEl.style.color = '#dc3545';
        }
      });

      // Password visibility toggle function
      function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
          input.type = 'text';
          button.textContent = 'ğŸ™ˆ';
        } else {
          input.type = 'password';
          button.textContent = 'ğŸ‘ï¸';
        }
      }
    </script>
  </body>
</html>

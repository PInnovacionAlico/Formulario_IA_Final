<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Restablecer Contrase√±a - Transforma tu empaque</title>
    <link rel="icon" type="image/png" href="/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/favicon/favicon.svg" />
    <link rel="shortcut icon" href="/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-title" content="Transforma tu empaque" />
    <link rel="manifest" href="/favicon/site.webmanifest" />
    <link rel="stylesheet" href="/style.css" />
    <style>
      /* Alico color variables */
      :root {
        --alico-gold: #DB9500;
        --alico-gold-80: #E2AA33;
        --alico-gold-70: #E6B54D;
        --alico-gold-20: #F8EACC;
        --alico-gold-10: #FBF4E5;
        --alico-blue: #000F9F;
        --alico-blue-80: #333FB2;
        --alico-blue-70: #4D58BC;
      }

      body {
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      .reset-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 50%, var(--alico-gold) 100%);
        padding: 2rem;
      }

      .reset-card {
        background: white;
        border-radius: 12px;
        padding: 3rem;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 20px 60px rgba(0, 15, 159, 0.3);
        border-top: 4px solid var(--alico-gold);
      }

      .reset-icon {
        font-size: 4rem;
        text-align: center;
        margin-bottom: 1rem;
      }

      .reset-title {
        color: var(--alico-blue);
        font-size: 2rem;
        margin-bottom: 0.5rem;
        text-align: center;
        font-weight: 700;
      }

      .reset-subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 2rem;
        font-size: 1rem;
      }

      label {
        display: block;
        margin-bottom: 1.5rem;
        color: var(--alico-blue);
        font-weight: 600;
      }

      .password-wrapper {
        position: relative;
        margin-top: 0.5rem;
      }

      input[type="password"],
      input[type="text"] {
        width: 100%;
        padding: 0.75rem;
        padding-right: 3rem;
        border: 2px solid var(--alico-gold-20);
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
        box-sizing: border-box;
      }

      input[type="password"]:focus,
      input[type="text"]:focus {
        outline: none;
        border-color: var(--alico-blue);
        box-shadow: 0 0 0 3px rgba(0, 15, 159, 0.1);
      }

      .password-toggle {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem;
        transition: transform 0.2s;
      }

      .password-toggle:hover {
        transform: translateY(-50%) scale(1.1);
      }

      .info-box {
        background: var(--alico-gold-10);
        border-left: 4px solid var(--alico-gold);
        padding: 1rem;
        margin: 1.5rem 0;
        border-radius: 8px;
      }

      .info-box p {
        margin: 0;
        font-size: 0.9rem;
        color: #856404;
        line-height: 1.6;
      }

      .btn-submit {
        width: 100%;
        padding: 1rem;
        background: linear-gradient(135deg, var(--alico-blue) 0%, var(--alico-blue-70) 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(0, 15, 159, 0.3);
        margin-top: 1rem;
      }

      .btn-submit:hover {
        background: linear-gradient(135deg, var(--alico-blue-70) 0%, var(--alico-blue) 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 15, 159, 0.4);
      }

      .result {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
      }

      .links {
        text-align: center;
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid var(--alico-gold-20);
      }

      .links a {
        color: var(--alico-blue);
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
      }

      .links a:hover {
        color: var(--alico-gold);
      }
    </style>
  </head>
  <body>
    <div class="reset-container">
      <div class="reset-card">
        <div class="reset-icon">üîê</div>
        <h1 class="reset-title">Restablecer Contrase√±a</h1>
        <p class="reset-subtitle">
          Ingresa tu nueva contrase√±a
        </p>
        
        <form id="resetForm">
          <label>Nueva Contrase√±a
            <div class="password-wrapper">
              <input type="password" name="newPassword" id="newPassword" required minlength="8" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword', this)">
                üëÅÔ∏è
              </button>
            </div>
          </label>
          <label>Confirmar Contrase√±a
            <div class="password-wrapper">
              <input type="password" name="confirmPassword" id="confirmPassword" required minlength="8" />
              <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword', this)">
                üëÅÔ∏è
              </button>
            </div>
          </label>
          <div class="info-box">
            <p>
              <strong>‚ö†Ô∏è Requisitos:</strong><br>
              ‚Ä¢ M√≠nimo 8 caracteres<br>
              ‚Ä¢ Se recomienda usar letras, n√∫meros y s√≠mbolos
            </p>
          </div>
          <button type="submit" class="btn-submit">Restablecer Contrase√±a</button>
          <div id="resetResult" class="result"></div>
        </form>
        
        <div class="links">
          <a href="/login.html">‚Üê Volver al inicio de sesi√≥n</a>
        </div>
      </div>
    </div>
    
    <script>
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('token');
      
      // If no token, redirect to login
      if (!token) {
        alert('Token inv√°lido. Por favor solicita un nuevo enlace de recuperaci√≥n.');
        window.location.href = '/login.html';
      }

      document.getElementById('resetForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newPassword = fd.get('newPassword');
        const confirmPassword = fd.get('confirmPassword');
        const resEl = document.getElementById('resetResult');
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
          resEl.textContent = '‚ùå Las contrase√±as no coinciden';
          resEl.style.color = '#dc3545';
          return;
        }
        
        // Validate password length
        if (newPassword.length < 8) {
          resEl.textContent = '‚ùå La contrase√±a debe tener al menos 8 caracteres';
          resEl.style.color = '#dc3545';
          return;
        }
        
        resEl.textContent = 'Restableciendo contrase√±a...';
        resEl.style.color = '';
        
        try {
          const res = await fetch('/api/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token, newPassword })
          });
          
          const data = await res.json();
          
          if (data.ok) {
            resEl.textContent = '‚úÖ ¬°Contrase√±a restablecida exitosamente!';
            resEl.style.color = '#28a745';
            setTimeout(() => {
              window.location.href = '/login.html';
            }, 2000);
          } else {
            resEl.textContent = '‚ùå ' + (data.error || 'Error al restablecer contrase√±a');
            resEl.style.color = '#dc3545';
          }
        } catch (err) {
          resEl.textContent = '‚ùå ' + String(err);
          resEl.style.color = '#dc3545';
        }
      });

      // Password visibility toggle function
      function togglePasswordVisibility(inputId, button) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
          input.type = 'text';
          button.textContent = 'üôà';
        } else {
          input.type = 'password';
          button.textContent = 'üëÅÔ∏è';
        }
      }
    </script>
  </body>
</html>
